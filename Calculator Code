<script src="https://cdn.tailwindcss.com/3.4.17"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/phosphor-icons/1.4.2/css/phosphor.min.css" rel="stylesheet">
<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js" defer></script>
<script src="https://hammerjs.github.io/dist/hammer.min.js"></script>

<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
            },
        },
    }
</script>

<style>
    /* Isolate all styles to the calculator wrapper */
    #pc-calculator-wrapper {
        font-family: 'Inter', sans-serif;
    }

    #pc-calculator-wrapper ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    #pc-calculator-wrapper ::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    #pc-calculator-wrapper .dark ::-webkit-scrollbar-track {
        background: #1e293b;
    }

    #pc-calculator-wrapper ::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 10px;
    }

    #pc-calculator-wrapper .dark ::-webkit-scrollbar-thumb {
        background: #475569;
    }

    #pc-calculator-wrapper input[type="radio"]:checked+label {
        border-color: #4f46e5;
        background-color: #eef2ff;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    #pc-calculator-wrapper .dark input[type="radio"]:checked+label {
        border-color: #6366f1;
        background-color: #312e81;
    }

    @keyframes pc-fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pc-fadeOut {
        from {
            opacity: 1;
            transform: translateY(0);
        }

        to {
            opacity: 0;
            transform: translateY(-5px);
        }
    }

    .pc-fade-in {
        animation: pc-fadeIn 0.3s ease-out forwards;
    }

    .pc-mobile-pace-card {
        background: white;
        border-radius: 0.75rem;
        padding: 0.875rem 1rem;
        border-left: 3px solid var(--accent, #6366f1);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .pc-mobile-pace-card:active {
        transform: scale(0.985);
    }

    @media (prefers-color-scheme: dark) {
        .pc-mobile-pace-card {
            background: rgb(30 41 59 / 0.8);
        }
    }

    .pc-mobile-cards {
        padding: 1rem;
    }

    /* Live VDOT Preview Badge */
    .pc-vdot-preview {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        background: linear-gradient(135deg, #6366f1, #818cf8);
        color: white;
        font-weight: 800;
        font-size: 0.875rem;
        border-radius: 9999px;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        transition: all 0.2s ease;
        opacity: 0;
        transform: scale(0.8);
    }

    .pc-vdot-preview.active {
        opacity: 1;
        transform: scale(1);
    }

    .pc-vdot-preview .vdot-label {
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.8;
    }

    /* Step slide transitions */
    @keyframes pc-slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes pc-slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .pc-slide-right {
        animation: pc-slideInRight 0.35s ease-out forwards;
    }

    .pc-slide-left {
        animation: pc-slideInLeft 0.35s ease-out forwards;
    }

    /* Details chevron rotation */
    details[open] .pc-details-chevron {
        transform: rotate(180deg);
    }

    /* Confetti */
    .pc-confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
    }

    .pc-confetti-piece {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 2px;
        animation: pc-confettiFall 2.5s ease-in forwards;
    }

    @keyframes pc-confettiFall {
        0% {
            transform: translateY(-10px) rotate(0deg) scale(1);
            opacity: 1;
        }

        100% {
            transform: translateY(100vh) rotate(720deg) scale(0.3);
            opacity: 0;
        }
    }

    /* Nudge card */
    .pc-nudge-card {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border: 1px solid #f59e0b33;
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        animation: pc-fadeIn 0.5s ease-out 0.3s forwards;
        opacity: 0;
    }

    @media (prefers-color-scheme: dark) {
        .pc-nudge-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.1));
            border-color: rgba(245, 158, 11, 0.2);
        }
    }

    /* Temperature slider */
    .pc-temp-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #3b82f6, #22c55e, #ef4444);
        outline: none;
    }

    .pc-temp-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: white;
        border: 2px solid #6366f1;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        cursor: pointer;
    }

    .pc-fade-out {
        animation: pc-fadeOut 0.2s ease-in forwards;
    }

    @keyframes pc-slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .pc-slide-up {
        animation: pc-slideUp 0.4s ease-out forwards;
    }

    .pc-hero-card {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #6366f1 100%);
    }

    .dark .pc-hero-card {
        background: linear-gradient(135deg, #312e81 0%, #4c1d95 50%, #3730a3 100%);
    }

    /* Pulse animation for live VDOT badge */
    .pc-vdot-badge.pulse {
        animation: pc-badgePulse 0.4s ease-out;
    }

    @keyframes pc-badgePulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.15);
        }

        100% {
            transform: scale(1);
        }
    }

    /* Staggered card animations */
    .pc-stagger-card {
        opacity: 0;
        transform: translateY(12px);
        animation: pc-staggerIn 0.35s ease-out forwards;
    }

    @keyframes pc-staggerIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Temperature badge on results */
    .pc-temp-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 0.5rem;
        font-size: 0.65rem;
        font-weight: 600;
        background: rgba(239, 68, 68, 0.12);
        color: #ef4444;
        margin-left: 8px;
    }

    /* Skeleton loading state */
    .pc-skeleton {
        background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        background-size: 200% 100%;
        animation: pc-skeletonShimmer 1.5s ease-in-out infinite;
        border-radius: 1rem;
    }

    .dark .pc-skeleton {
        background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
        background-size: 200% 100%;
    }

    @keyframes pc-skeletonShimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    /* Hero card - clean, no shimmer */
    .pc-hero-card {
        position: relative;
    }

    /* Progress ring */
    .pc-progress-ring {
        transform: rotate(-90deg);
    }

    .pc-progress-ring circle.ring-progress {
        transition: stroke-dashoffset 0.8s ease-out;
    }

    /* Tap-to-copy feedback */
    .pc-mobile-pace-card {
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .pc-mobile-pace-card:active {
        transform: scale(0.97);
    }

    .pc-copy-flash {
        animation: pc-copyFlash 0.6s ease-out forwards;
    }

    @keyframes pc-copyFlash {
        0% {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
        }

        50% {
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.15);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        }
    }

    /* New PR badge */
    .pc-pr-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 2rem;
        font-size: 0.75rem;
        font-weight: 700;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #78350f;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        margin-top: 6px;
    }

    /* Quick re-calculate button */
    .pc-recalc-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
        backdrop-filter: blur(4px);
    }

    .pc-recalc-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    /* Dark mode fixes for new elements */
    .dark .pc-pr-badge {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15));
        color: #fbbf24;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
    }

    .dark .pc-temp-badge {
        background: rgba(239, 68, 68, 0.15);
        color: #fca5a5;
    }


    #pc-calculator-wrapper .pc-sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #pc-calculator-wrapper .pc-sticky-col {
        position: sticky;
        left: 0;
        z-index: 5;
        box-shadow: 4px 0 6px -4px rgba(0, 0, 0, 0.1);
    }

    #pc-calculator-wrapper .dark .pc-sticky-col {
        box-shadow: 4px 0 6px -4px rgba(0, 0, 0, 0.3);
    }

    #pc-calculator-wrapper .pc-tab-btn {
        transition: all 0.3s ease;
    }

    #pc-calculator-wrapper .pc-tab-btn.active {
        color: #4f46e5;
        border-bottom-color: #4f46e5;
        font-weight: 600;
    }

    #pc-calculator-wrapper .dark .pc-tab-btn.active {
        color: #a5b4fc;
        border-bottom-color: #a5b4fc;
    }

    #pc-calculator-wrapper .pc-tab-content {
        display: none;
    }

    #pc-calculator-wrapper .pc-tab-content.active {
        display: block;
    }

    #pc-calculator-wrapper .pc-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(15, 23, 42, 0.7);
        z-index: 9999;
        /* High z-index for Squarespace */
        animation: pc-fadeIn 0.3s ease-out;
    }

    #pc-calculator-wrapper .pc-modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        /* High z-index for Squarespace */
        max-height: 90vh;
        overflow-y: auto;
    }

    #pc-calculator-wrapper .pc-chart-tooltip {
        transition: opacity 0.2s ease-out;
        pointer-events: none;
    }

    /* Styles for the new time input fields */
    #pc-calculator-wrapper .pc-time-input-group input {
        text-align: center;
        width: 3.5rem;
        /* Adjust width as needed */
        -moz-appearance: textfield;
        appearance: textfield;
        /* Firefox */
    }

    #pc-calculator-wrapper .pc-time-input-group input::-webkit-outer-spin-button,
    #pc-calculator-wrapper .pc-time-input-group input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    #pc-calculator-wrapper .pc-time-input-group input.border-red-500 {
        border-color: #ef4444 !important;
    }

    /* Touch-friendly buttons */
    #pc-calculator-wrapper button,
    #pc-calculator-wrapper a.button-like {
        padding: 0.6rem 1rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }

    /* Sticky Header Navigation */
    #pc-calculator-wrapper nav {
        position: sticky;
        top: 0;
        z-index: 20;
        background: inherit;
    }

    /* === MOBILE-FIRST RESPONSIVE STYLES === */

    /* Mobile: compact layout */
    @media (max-width: 639px) {
        #pc-calculator-wrapper .pc-basis-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        #pc-calculator-wrapper .pc-basis-card {
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
        }

        #pc-calculator-wrapper .pc-basis-card .pc-card-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        #pc-calculator-wrapper .pc-basis-card .pc-card-label {
            font-size: 0.8rem;
        }

        #pc-calculator-wrapper .pc-basis-card .pc-card-sub {
            font-size: 0.6rem;
        }

        #pc-calculator-wrapper .pc-hero-card {
            padding: 1.25rem;
        }

        #pc-calculator-wrapper .pc-hero-vdot {
            font-size: 3.5rem;
        }

        #pc-calculator-wrapper .pc-hero-5k {
            font-size: 1.5rem;
        }

        #pc-calculator-wrapper .pc-secondary-actions {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.375rem;
        }

        #pc-calculator-wrapper .pc-secondary-actions button {
            padding: 0.5rem 0.25rem;
            font-size: 0.7rem;
        }

        #pc-calculator-wrapper .pc-secondary-actions button span {
            display: none;
        }

        #pc-calculator-wrapper .pc-secondary-actions button i {
            font-size: 1.1rem;
        }

        /* Tab nav: icon only on mobile */
        #pc-calculator-wrapper nav button .pc-tab-label {
            display: none;
        }

        #pc-calculator-wrapper nav {
            background: white !important;
            padding: 0 0.5rem;
            gap: 0;
        }

        .dark #pc-calculator-wrapper nav {
            background: #1e293b !important;
        }

        #pc-calculator-wrapper nav button {
            font-size: 1.25rem;
            padding: 0.75rem 0.75rem;
            flex: 1;
            display: flex;
            justify-content: center;
        }

        #pc-calculator-wrapper nav button i {
            font-size: 1.25rem;
        }
    }

    /* Large screens: bump button sizes */
    @media (min-width: 640px) {

        #pc-calculator-wrapper button,
        #pc-calculator-wrapper a.button-like {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            line-height: 1.5rem;
        }
    }

    @media print {
        body * {
            visibility: hidden;
        }

        #pc-printable-area,
        #pc-printable-area * {
            visibility: visible;
        }

        #pc-printable-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }

        .pc-no-print {
            display: none !important;
        }
    }
</style>


<div id="pc-calculator-wrapper" class="text-slate-800 dark:text-slate-200 transition-colors duration-300">
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    <div id="sr-announcer" class="sr-only" aria-live="polite"></div>

    <div class="w-full min-h-screen p-2 sm:p-6 lg:p-8">
        <div class="max-w-screen-2xl mx-auto">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white">Pace Calculator</h1>
                    <p class="text-slate-500 dark:text-slate-400">Powered by Daniels' Running Formula</p>
                </div>
                <button id="darkToggle" aria-label="Toggle Dark Mode"
                    class="relative w-12 h-6 bg-slate-300 dark:bg-slate-700 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-slate-900">
                    <span class="sr-only">Toggle Dark Mode</span>
                    <span id="darkToggleIndicator"
                        class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 flex items-center justify-center">
                        <i class="ph-moon text-indigo-600"></i>
                    </span>
                </button>
            </header>

            <div class="mb-6 border-b border-slate-200 dark:border-slate-700">
                <nav class="flex space-x-6" aria-label="Tabs">
                    <button id="tab-calc-btn" role="tab" aria-selected="true" aria-controls="tab-calc-content"
                        class="pc-tab-btn active py-3 px-1 border-b-2 border-transparent text-base font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
                        <i class="ph-calculator mr-1"></i><span class="pc-tab-label">Calculator</span>
                    </button>
                    <button id="tab-convert-btn" role="tab" aria-selected="false" aria-controls="tab-convert-content"
                        class="pc-tab-btn py-3 px-1 border-b-2 border-transparent text-base font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
                        <i class="ph-arrows-left-right mr-1"></i><span class="pc-tab-label">Conversions</span>
                    </button>
                    <button id="tab-history-btn" role="tab" aria-selected="false" aria-controls="tab-history-content"
                        class="pc-tab-btn py-3 px-1 border-b-2 border-transparent text-base font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
                        <i class="ph-chart-line-up mr-1"></i><span class="pc-tab-label">History</span>
                    </button>
                    <button id="tab-settings-btn" role="tab" aria-selected="false" aria-controls="tab-settings-content"
                        class="pc-tab-btn py-3 px-1 border-b-2 border-transparent text-base font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
                        <i class="ph-gear mr-1"></i><span class="pc-tab-label">Settings</span>
                    </button>
                </nav>
            </div>

            <div>
                <div id="tab-calc-content" role="tabpanel" class="pc-tab-content active">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 sm:gap-8">

                        <div class="lg:col-span-2 lg:col-start-1 lg:row-start-1 space-y-4 sm:space-y-8">
                            <div class="bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                                <div id="main-calc-form" class="space-y-4 sm:space-y-6"></div>
                            </div>
                        </div>

                        <div id="results-column"
                            class="lg:col-span-3 lg:col-start-3 lg:row-start-1 lg:row-span-3 space-y-8">
                        </div>

                        <div class="lg:col-span-2 lg:col-start-1 lg:row-start-2">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                                <div id="goal-pace-form" class="space-y-6"></div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 lg:col-start-1 lg:row-start-3">
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg space-y-4">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Guides & Information
                                </h3>
                                <div id="infoContainer" class="space-y-2"></div>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="tab-convert-content" role="tabpanel" class="pc-tab-content">
                </div>

                <div id="tab-history-content" role="tabpanel" class="pc-tab-content">
                </div>

                <div id="tab-settings-content" role="tabpanel" class="pc-tab-content">
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="pc-modal-overlay" role="dialog" aria-modal="true">
        <div id="modal-content"
            class="pc-modal-content bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 w-11/12 max-w-4xl">
        </div>
    </div>
</div>

<script>
        (function () {
            const state = {
                isDark: false,
                history: [],
                latestCalculation: null,
                paceCardData: null,
                settings: {
                    name: '',
                    hrData: { mhr: '', lthr: '' },
                    customSplits: [],
                    paceCardSplits: [],
                    motivationalQuote: '',
                    displayUnit: localStorage.getItem('paceCalcUnit') || 'miles',
                    historySort: { by: 'date', order: 'desc' }
                },
                currentStep: 1,
                selectedBasis: localStorage.getItem('paceCalcBasis') || 'bear',
                debounceTimer: null,
                undoStack: [], // Multiple Undo Actions
            };

            const METERS_PER_MILE = 1609.34;
            const METERS_PER_KM = 1000;
            const CONFIG = {
                distMap: {
                    fiveK: 5000, threeTwo: 3200, oneSix: 1600, bear: 1.17 * METERS_PER_MILE,
                    marathon: 42195, halfMarathon: 21097.5, tenK: 10000,
                    palmerLake: 4 * METERS_PER_MILE,
                    mvp: 5000, stateXC: 5000,
                    custom: 0 // Placeholder for custom distance
                },
                // Course standardizer factors (standard 5K = 1.0)
                // Factor < 1 means the course runs faster than a flat 5K
                courseFactors: {
                    mvp: 0.974,       // Monument Valley Park
                    stateXC: 0.9544   // Norris Penrose / State XC (slower course)
                },
                benchmarks: [
                    { bear: 420, fiveK: 930 },
                    { bear: 480, fiveK: 1020 },
                    { bear: 540, fiveK: 1110 },
                    { bear: 600, fiveK: 1200 }
                ].sort((a, b) => a.bear - b.bear),
                hrZones: {
                    mhr: [
                        { name: 'Recovery', low: 0.60, high: 0.75 }, { name: 'Foundation', low: 0.75, high: 0.85 },
                        { name: 'Tempo', low: 0.82, high: 0.89 }, { name: 'Lactate Threshold', low: 0.88, high: 0.92 },
                        { name: 'CV', low: 0.90, high: 0.95 }, { name: '5K', low: 0.95, high: 0.98 }
                    ],
                    lthr: [
                        { name: 'Recovery', low: 0.80, high: 0.90 }, { name: 'Foundation', low: 0.90, high: 0.95 },
                        { name: 'Tempo', low: 0.96, high: 1.00 }, { name: 'Lactate Threshold', low: 0.99, high: 1.02 },
                        { name: 'CV', low: 1.02, high: 1.06 }, { name: '5K', low: 1.05, high: 1.10 }
                    ]
                },
                allPaces: [
                    { name: "Recovery", slow: 0.63, fast: 0.69, color: "#c6efce", darkColor: "#166534", type: 'zone' },
                    { name: "Foundation", slow: 0.70, fast: 0.80, color: "#d9ead3", darkColor: "#22502A", type: 'zone' },
                    { name: "Steady", slow: 0.80, fast: 0.85, color: "#fff2cc", darkColor: "#713f12", type: 'zone' },
                    { name: "Tempo", slow: 0.86, fast: 0.90, color: "#fce5cd", darkColor: "#7c2d12", type: 'zone' },
                    { name: "Lactate Threshold", slow: 0.91, fast: 0.94, color: "#f4cccc", darkColor: "#881337", type: 'zone' },
                    { name: "CV", slow: 0.95, fast: 0.97, color: "#ead1dc", darkColor: "#831843", type: 'zone' },
                    { name: "Marathon", dist: 42195, color: "#fef3c7", darkColor: "#713f12", type: 'race' },
                    { name: "10K", dist: 10000, color: "#fca5a5", darkColor: "#991b1b", type: 'race' },
                    { name: "5K", dist: 5000, color: "#e6b8af", darkColor: "#8c2a27", type: 'race' },
                    { name: "3200m", dist: 3200, color: "#d99694", darkColor: "#803230", type: 'race' },
                    { name: "1600m", dist: 1600, color: "#c0504d", darkColor: "#932926", type: 'race' },
                    { name: "800m", dist: 800, color: "#e06666", darkColor: "#b91c1c", type: 'race' },
                    { name: "400m", dist: 400, color: "#a4c2f4", darkColor: "#1e3a8a", type: 'race' }
                ],
                defaultSplitDistances: [
                    { dist: 100, label: '100m' }, { dist: 200, label: '200m' }, { dist: 300, label: '300m' },
                    { dist: 400, label: '400m' }, { dist: 600, label: 'Limbach' }, { dist: 800, label: '800m' },
                    { dist: 1000, label: '1000m' }, { dist: 1200, label: '1200m' }, { dist: 1309, label: 'PL Loop' },
                    { dist: 1600, label: '1600m' }, { dist: 2000, label: '2000m' }
                ],
                inputPlaceholders: {
                    m: "MM", s: "SS"
                },
                inputLabels: {
                    bear: "Bear Time", fiveK: "5K Time",
                    threeTwo: "3200m Time", oneSix: "1600m Time",
                    pace: "Pace / mi", palmerLake: "Palmer Lake 4 Miler Time",
                    custom: "Custom Distance Time",
                    mvp: "MVP Time", stateXC: "State XC Time"
                },
                exampleTimes: {
                    bear: { m: '8', s: '30' }, fiveK: { m: '19', s: '45' },
                    threeTwo: { m: '12', s: '00' }, oneSix: { m: '5', s: '30' },
                    pace: { m: '7', s: '15' }, palmerLake: { m: '28', s: '00' },
                    custom: { m: '45', s: '00' },
                    mvp: { m: '19', s: '15' }, stateXC: { m: '18', s: '30' }
                },
                // USTFCCA Standardized Track Event Conversion Factors (Rev. 01/10/12)
                ustfccaConversions: [
                    // Left table
                    { from: "60 Yards", to: "60 Meters", factor: 1.07 },
                    { from: "55 Meters (men)", to: "60 Meters (men)", factor: 1.0749 },
                    { from: "55 Meters (women)", to: "60 Meters (women)", factor: 1.0771 },
                    { from: "55 Hurdles (men)", to: "60 Hurdles (men)", factor: 1.0766 },
                    { from: "55 Hurdles (women)", to: "60 Hurdles (women)", factor: 1.0755 },
                    { from: "120 Hurdles (Yards)", to: "110 Hurdles", factor: 1.0025 },
                    { from: "200 Meters", to: "300 Yards", factor: 1.44 },
                    { from: "200 Meters", to: "300 Meters", factor: 1.60 },
                    { from: "220 Yards", to: "200 Meters", factor: 0.9942 },
                    { from: "300 Yards", to: "300 Meters", factor: 1.11 },
                    { from: "300 Yards", to: "440 Yards", factor: 1.59 },
                    { from: "400 Meters", to: "440 Yards", factor: 1.0059 },
                    { from: "400 Meters", to: "500 Yards", factor: 1.19 },
                    { from: "400 Meters", to: "500 Meters", factor: 1.32 },
                    { from: "400 Meters", to: "600 Yards", factor: 1.49 },
                    { from: "400 Meters", to: "600 Meters", factor: 1.66 },
                    { from: "440 Yards", to: "400 Meters", factor: 0.9942 },
                    { from: "440 Yards", to: "500 Yards", factor: 1.17 },
                    { from: "440 Yards", to: "500 Meters", factor: 1.29 },
                    { from: "440 Yards", to: "600 Yards", factor: 1.48 },
                    { from: "440 Yards", to: "600 Meters", factor: 1.65 },
                    { from: "500 Yards", to: "500 Meters", factor: 1.11 },
                    { from: "500 Yards", to: "600 Yards", factor: 1.25 },
                    { from: "500 Yards", to: "600 Meters", factor: 1.40 },
                    { from: "500 Meters", to: "600 Yards", factor: 1.13 },
                    { from: "500 Meters", to: "600 Meters", factor: 1.26 },
                    { from: "500 Meters", to: "800 Yards", factor: 1.75 },
                    { from: "500 Meters", to: "880 Yards", factor: 1.79 },
                    { from: "600 Yards", to: "600 Meters", factor: 1.12 },
                    { from: "600 Yards", to: "800 Meters", factor: 1.55 },
                    { from: "600 Meters", to: "800 Meters", factor: 1.38 },
                    { from: "800 Meters", to: "880 Yards", factor: 1.0059 },
                    { from: "800 Meters", to: "1000 Yards", factor: 1.19 },
                    // Right table
                    { from: "800 Meters", to: "1000 Meters", factor: 1.32 },
                    { from: "880 Yards", to: "800 Meters", factor: 0.9942 },
                    { from: "1000 Yards", to: "1000 Meters", factor: 1.11 },
                    { from: "1000 Meters", to: "1500 Meters", factor: 1.56 },
                    { from: "1500 Meters", to: "1600 Meters", factor: 1.0737 },
                    { from: "1500 Meters", to: "Mile", factor: 1.08 },
                    { from: "1500 Meters", to: "2000 Meters", factor: 1.36 },
                    { from: "1500 Meters", to: "3000 Meters", factor: 2.13 },
                    { from: "1500 Meters", to: "Two Mile", factor: 2.29 },
                    { from: "1500 Meters", to: "Three Mile", factor: 3.59 },
                    { from: "1600 Meters", to: "Mile", factor: 1.0058 },
                    { from: "Mile", to: "1500 Meters", factor: 0.9259 },
                    { from: "Mile", to: "1600 Meters", factor: 0.9942 },
                    { from: "Mile", to: "2000 Meters", factor: 1.28 },
                    { from: "Mile", to: "3000 Meters", factor: 2.00 },
                    { from: "Mile", to: "Two Mile", factor: 2.15 },
                    { from: "Mile", to: "Three Mile", factor: 3.37 },
                    { from: "2000 Meters", to: "3000 Meters", factor: 1.56 },
                    { from: "2000 Meters", to: "Two Mile", factor: 1.68 },
                    { from: "2000 Meters", to: "Three Mile", factor: 2.63 },
                    { from: "3000 Meters", to: "3200 Meters", factor: 1.0737 },
                    { from: "3000 Meters", to: "Two Mile", factor: 1.08 },
                    { from: "3200 Meters", to: "Two Mile", factor: 1.0058 },
                    { from: "Two Mile", to: "3000 Meters", factor: 0.9259 },
                    { from: "Two Mile", to: "Three Mile", factor: 1.57 },
                    { from: "Three Mile", to: "5000 Meters", factor: 1.036 },
                    { from: "4x110 Relay (Yards)", to: "4x100 Relay", factor: 0.9942 },
                    { from: "4x220 Relay (Yards)", to: "4x200 Relay", factor: 0.9942 },
                    { from: "4x440 Relay (Yards)", to: "4x400 Relay", factor: 0.9942 },
                    { from: "4x880 Relay (Yards)", to: "4x800 Relay", factor: 0.9942 },
                    { from: "4xMile Relay", to: "4x1500 Relay", factor: 0.9259 },
                    { from: "4xMile Relay", to: "4x1600 Relay", factor: 0.9942 },
                    { from: "Sprint Medley Relay (Yards)", to: "Sprint Medley Relay", factor: 0.9942 },
                    { from: "Distance Medley Relay (Yards)", to: "Distance Medley Relay", factor: 0.9942 },
                    { from: "Shuttle Hurdle Relay (Yards)", to: "Shuttle Hurdle Relay", factor: 1.0025 },
                    // Additional useful reverse lookups from the table
                    { from: "300 Meters", to: "400 Meters", factor: 1.3964 },
                ],
                // All USTFCCA distance events that have "from" conversions, with their metric distances for VDOT prediction
                ustfccaDistanceEvents: [
                    { event: '800 Meters', meters: 800 },
                    { event: '1000 Meters', meters: 1000 },
                    { event: '1500 Meters', meters: 1500 },
                    { event: '1600 Meters', meters: 1600 },
                    { event: 'Mile', meters: 1609.34 },
                    { event: '2000 Meters', meters: 2000 },
                    { event: '3000 Meters', meters: 3000 },
                    { event: '3200 Meters', meters: 3200 },
                    { event: 'Two Mile', meters: 2 * 1609.34 },
                    { event: 'Three Mile', meters: 3 * 1609.34 },
                ],
                // NCAA Indoor Track Type Conversion Factors (Official Chart)
                // Each factor: multiply actual time (in seconds) by factor to get converted time
                ncaaTrackConversions: {
                    men: {
                        // Undersized → 200m Flat
                        undersizedToFlat: { '200 Meters': 0.9872, '400 Meters': 0.9901, '800 Meters': 0.9923, '1000 Meters': 0.9929, 'Mile': 0.9941, '3000 Meters': 0.9953, '5000 Meters': 0.9961 },
                        // Banked/Oversized → 200m Flat
                        bankedToFlat: { '200 Meters': 1.0179, '400 Meters': 1.0160, '800 Meters': 1.0143, '1000 Meters': 1.0138, 'Mile': 1.0128, '3000 Meters': 1.0116, '5000 Meters': 1.0107 },
                        // Undersized → Banked/Oversized
                        undersizedToBanked: { '200 Meters': 0.9698, '400 Meters': 0.9746, '800 Meters': 0.9783, '1000 Meters': 0.9794, 'Mile': 0.9816, '3000 Meters': 0.9839, '5000 Meters': 0.9855 },
                        // 200m Flat → Banked/Oversized
                        flatToBanked: { '200 Meters': 0.9824, '400 Meters': 0.9843, '800 Meters': 0.9859, '1000 Meters': 0.9864, 'Mile': 0.9874, '3000 Meters': 0.9885, '5000 Meters': 0.9894 },
                    },
                    women: {
                        undersizedToFlat: { '200 Meters': 0.9900, '400 Meters': 0.9929, '800 Meters': 0.9951, 'Mile': 0.9969, '3000 Meters': 0.9981, '5000 Meters': 0.9989 },
                        bankedToFlat: { '200 Meters': 1.0155, '400 Meters': 1.0133, '800 Meters': 1.0115, 'Mile': 1.0099, '3000 Meters': 1.0086, '5000 Meters': 1.0077 },
                        undersizedToBanked: { '200 Meters': 0.9749, '400 Meters': 0.9799, '800 Meters': 0.9838, 'Mile': 0.9871, '3000 Meters': 0.9896, '5000 Meters': 0.9913 },
                        flatToBanked: { '200 Meters': 0.9847, '400 Meters': 0.9869, '800 Meters': 0.9886, 'Mile': 0.9902, '3000 Meters': 0.9915, '5000 Meters': 0.9924 },
                    },
                    // Track type labels for UI
                    trackTypes: [
                        { value: 'flat', label: '200m Flat Track' },
                        { value: 'banked', label: 'Banked / Oversized' },
                        { value: 'undersized', label: 'Undersized (< 200m)' },
                    ],
                    // Map convert-distance labels to the factor-key used in the tables above
                    eventMapping: {
                        '200 Meters': '200 Meters', '300 Meters': '200 Meters',
                        '400 Meters': '400 Meters', '440 Yards': '400 Meters',
                        '500 Meters': '400 Meters', '600 Meters': '400 Meters',
                        '800 Meters': '800 Meters',
                        '1000 Meters': '1000 Meters', '1200 Meters': '1000 Meters',
                        '1500 Meters': 'Mile', '1600 Meters': 'Mile', 'Mile': 'Mile',
                        '2000 Meters': 'Mile',
                        '3000 Meters': '3000 Meters', '3200 Meters': '3000 Meters',
                        'Two Mile': '3000 Meters', 'Three Mile': '5000 Meters',
                        '5000 Meters': '5000 Meters',
                    },
                },
                // NCAA DI/III Altitude Adjustment Data (verified against TFRRS 2025-26)
                // Percentage-based model — gender-neutral by design (DI/III rules)
                // Per-event percentages at representative altitude data points
                // Source: NCAA facility altitude adjustments, cross-verified with TFRRS converter
                ncaaAltitudeData: [
                    // pct values = % of time to subtract for altitude (gender-independent for DI/III)
                    { altFt: 0, pct800: 0, pct1500: 0, pct5000: 0, pct10000: 0 },
                    { altFt: 2999, pct800: 0, pct1500: 0, pct5000: 0, pct10000: 0 },
                    { altFt: 3124, pct800: 0.281, pct1500: 1.128, pct5000: 1.270, pct10000: 1.473 },
                    { altFt: 3896, pct800: 0.371, pct1500: 1.545, pct5000: 1.830, pct10000: 2.146 },
                    { altFt: 4627, pct800: 0.489, pct1500: 2.002, pct5000: 2.425, pct10000: 2.851 },
                    { altFt: 5260, pct800: 0.634, pct1500: 2.441, pct5000: 2.994, pct10000: 3.516 },
                    { altFt: 6007, pct800: 0.833, pct1500: 3.021, pct5000: 3.728, pct10000: 4.365 },
                    { altFt: 6981, pct800: 1.150, pct1500: 3.864, pct5000: 4.787, pct10000: 5.576 },
                    { altFt: 7544, pct800: 1.368, pct1500: 4.403, pct5000: 5.452, pct10000: 6.332 },
                    { altFt: 7703, pct800: 1.431, pct1500: 4.557, pct5000: 5.645, pct10000: 6.553 },
                ],
                highAltitudeVenues: [
                    // ── Indoor Facilities ──────────────────────────────────────────
                    // trackType verified via TFRRS Mark Converter: flat = 200m flat, banked = banked/oversized ≥200m, undersized = <200m
                    // --- Colorado ---
                    { id: '725', type: 'indoor', trackType: 'banked', name: "Air Force – Cadet Field House (Indoor)", elevation: 7048, city: "Colorado Springs, CO" },
                    { id: '30781', type: 'indoor', trackType: 'flat', name: "Adams State – High Altitude Training Center (Indoor)", elevation: 7544, city: "Alamosa, CO" },
                    { id: '833', type: 'indoor', trackType: 'flat', name: "Adams State – Plachy Hall (Indoor)", elevation: 7544, city: "Alamosa, CO" },
                    { id: '1458', type: 'indoor', trackType: 'flat', name: "Western Colorado – Mountaineer Field House (Indoor)", elevation: 7717, city: "Gunnison, CO" },
                    { id: '731', type: 'indoor', trackType: 'undersized', name: "Wyoming – War Memorial Fieldhouse (Indoor)", elevation: 7220, city: "Laramie, WY" },
                    { id: '1460', type: 'indoor', trackType: 'flat', name: "UCCS – Mountain Lion Fieldhouse (Indoor)", elevation: 6291, city: "Colorado Springs, CO" },
                    { id: '1462', type: 'indoor', trackType: 'undersized', name: "Colorado Mines – Steinhauer Fieldhouse (Indoor)", elevation: 5675, city: "Golden, CO" },
                    { id: '861', type: 'indoor', trackType: 'flat', name: "Colorado – Balch Fieldhouse (Indoor)", elevation: 5328, city: "Boulder, CO" },
                    // --- New Mexico / Arizona ---
                    { id: '14280', type: 'indoor', trackType: 'banked', name: "Albuquerque Convention Center (Indoor)", elevation: 4958, city: "Albuquerque, NM" },
                    { id: '1129', type: 'indoor', trackType: 'banked', name: "Northern Arizona – Walkup Skydome (Indoor)", elevation: 6880, city: "Flagstaff, AZ" },
                    // --- Idaho / Montana ---
                    { id: '1097', type: 'indoor', trackType: 'banked', name: "Boise State – Jackson's Track (Indoor)", elevation: 2704, city: "Boise, ID" },
                    { id: '1125', type: 'indoor', trackType: 'banked', name: "Idaho State – Holt Arena (Indoor, Banked)", elevation: 4462, city: "Pocatello, ID" },
                    { id: '1117', type: 'indoor', trackType: 'flat', name: "Montana (Indoor)", elevation: 3209, city: "Missoula, MT" },
                    { id: '29001', type: 'indoor', trackType: 'flat', name: "Montana State – Breeden Fieldhouse (Indoor, Flat)", elevation: 4820, city: "Bozeman, MT" },
                    { id: '1119', type: 'indoor', trackType: 'banked', name: "Montana State – Breeden Fieldhouse (Indoor, Banked)", elevation: 4820, city: "Bozeman, MT" },
                    // --- Utah / Texas ---
                    { id: '727', type: 'indoor', trackType: 'banked', name: "BYU – Smith Field House (Indoor)", elevation: 4549, city: "Provo, UT" },
                    { id: '1099', type: 'indoor', trackType: 'flat', name: "Utah State – Nelson Field House (Indoor)", elevation: 4531, city: "Logan, UT" },
                    { id: '1127', type: 'indoor', trackType: 'flat', name: "Weber State – Swenson Gym (Indoor)", elevation: 4314, city: "Ogden, UT" },
                    { id: '31857', type: 'indoor', trackType: 'banked', name: "Texas Tech – Sports Performance Center (Indoor)", elevation: 3256, city: "Lubbock, TX" },

                    // ── XC Courses (Factors standardizing to Liberty Bell @ 5340ft) ──
                    { id: 'LB_XC', type: 'xc', name: "Liberty Bell (Heritage HS)", elevation: 5340, city: "Littleton, CO", xcFactor: 1.0 },
                    { id: 'STATE_XC', type: 'xc', name: "Pre-State / State XC (Norris Penrose)", elevation: 6000, city: "Colorado Springs, CO", xcFactor: 0.9544 },
                    { id: 'PA_XC', type: 'xc', name: "Pat Amato (Northwest Open Space)", elevation: 5340, city: "Northglenn, CO", xcFactor: 0.989 },
                    { id: 'RIM_XC', type: 'xc', name: "Rim Rock Farm (Kansas)", elevation: 1000, city: "Lawrence, KS", xcFactor: 0.9793 },
                    { id: 'COR_XC', type: 'xc', name: "Coronado '23 (Monument Valley Park)", elevation: 6000, city: "Colorado Springs, CO", xcFactor: 0.974 },

                    // ── Outdoor Facilities ─────────────────────────────────────────
                    // --- Colorado ---
                    { id: 'AF_OUT', type: 'outdoor', name: "Air Force – Outdoor Track / Cadet Area", elevation: 7258, city: "Colorado Springs, CO" },
                    { id: 'ASU_OUT', type: 'outdoor', name: "Adams State – Rex Stadium (Outdoor)", elevation: 7544, city: "Alamosa, CO" },
                    { id: 'WCU_OUT', type: 'outdoor', name: "Western Colorado – Mountaineer Bowl (Outdoor)", elevation: 7717, city: "Gunnison, CO" },
                    { id: 'WYO_OUT', type: 'outdoor', name: "Wyoming – Louis S. Madrid Sports Complex (Outdoor)", elevation: 7220, city: "Laramie, WY" },
                    { id: 'CC_OUT', type: 'outdoor', name: "Colorado College – Washburn Field (Outdoor)", elevation: 6035, city: "Colorado Springs, CO" },
                    { id: 'CSM_OUT', type: 'outdoor', name: "Colorado Mines – Stermole Track Complex (Outdoor)", elevation: 5675, city: "Golden, CO" },
                    { id: 'CU_OUT', type: 'outdoor', name: "Colorado – Potts Field (Outdoor)", elevation: 5328, city: "Boulder, CO" },
                    { id: 'CSU_OUT', type: 'outdoor', name: "Colorado State – Jack Christiansen Track (Outdoor)", elevation: 5003, city: "Fort Collins, CO" },
                    { id: 'UNC_OUT', type: 'outdoor', name: "Northern Colorado – Nottingham Field (Outdoor)", elevation: 4685, city: "Greeley, CO" },
                    { id: '3167', type: 'outdoor', name: "CSU Pueblo – ThunderBowl (Outdoor)", elevation: 4700, city: "Pueblo, CO" },
                    // --- New Mexico / Arizona ---
                    { id: 'UNM_OUT', type: 'outdoor', name: "New Mexico – UNM Track & Field Complex (Outdoor)", elevation: 5335, city: "Albuquerque, NM" },
                    { id: 'NAU_OUT', type: 'outdoor', name: "Northern Arizona – Outdoor Track", elevation: 6880, city: "Flagstaff, AZ" },
                    // --- Idaho / Montana ---
                    { id: 'BSU_OUT', type: 'outdoor', name: "Boise State – Bob Gibb Friendship Bridge Track (Outdoor)", elevation: 2704, city: "Boise, ID" },
                    { id: 'ISU_OUT', type: 'outdoor', name: "Idaho State – Davis Field (Outdoor)", elevation: 4462, city: "Pocatello, ID" },
                    { id: 'UM_OUT', type: 'outdoor', name: "Montana – Dornblaser Stadium (Outdoor)", elevation: 3209, city: "Missoula, MT" },
                    { id: 'MSU_OUT', type: 'outdoor', name: "Montana State – Bobcat Track Complex (Outdoor)", elevation: 4820, city: "Bozeman, MT" },
                    // --- Utah / Texas ---
                    { id: 'BYU_OUT', type: 'outdoor', name: "BYU – Clarence Robison Track (Outdoor)", elevation: 4549, city: "Provo, UT" },
                    { id: 'USU_OUT', type: 'outdoor', name: "Utah State – Ralph Maughan Track Stadium (Outdoor)", elevation: 4531, city: "Logan, UT" },
                    { id: 'WSU_OUT', type: 'outdoor', name: "Weber State – Stewart Stadium (Outdoor)", elevation: 4314, city: "Ogden, UT" },
                    { id: 'TTU_OUT', type: 'outdoor', name: "Texas Tech – Fuller Track & Field Complex (Outdoor)", elevation: 3256, city: "Lubbock, TX" },
                    { id: 'UTEP_OUT', type: 'outdoor', name: "UTEP – Kidd Field (Outdoor)", elevation: 3740, city: "El Paso, TX" },
                ],
            };
            const INFO_CONTENT = [
                { type: 'details', title: "How to Use This Calculator", content: `<ol class="list-decimal pl-5 space-y-2 text-slate-600 dark:text-slate-400"><li><b class="text-slate-700 dark:text-slate-300">Enter Your Time:</b> Select a performance basis and enter the numbers for your time. The cursor will move automatically.</li><li><b class="text-slate-700 dark:text-slate-300">Calculate:</b> Hit the "Calculate" button.</li><li><b class="text-slate-700 dark:text-slate-300">Save (Optional):</b> Click "Save Pace" to add the result to your history and track your progress.</li><li><b class="text-slate-700 dark:text-slate-300">Review & Apply:</b> Use the equivalent times and training paces to guide your workouts.</li></ol>` },
                { type: 'header', title: 'Training Zone Descriptions' },
                { type: 'details', title: 'Recovery', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> To promote healing and recovery between hard sessions. This is the easiest running you'll do.</p><p><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> Effortless. You should be able to hold a full conversation without ever noticing your breathing. If you have to think about the pace, you're going too fast. This zone is about time on your feet, promoting blood flow, and clearing metabolic waste, not building fitness.</p></div>` },
                { type: 'details', title: 'Foundation / Steady', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> This is the bread and butter of endurance training. These paces build your aerobic engine, capillary networks, and mitochondrial density, improving your body's ability to use oxygen efficiently. This zone covers what coaches like Tinman call "Easy Aerobic" up to what Mike Smith's NAU runners would call a "steady" effort.</p><p><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> Comfortable and controlled. You can hold a conversation, but your breathing is more rhythmic than on a recovery run. It's a purposeful but low-stress pace that you feel you could maintain for a very long time. The upper end of this range feels like you're "working" but not straining.</p></div>` },
                { type: 'details', title: 'Tempo / Lactate Threshold', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> To improve your body's ability to clear and utilize lactate, directly increasing the pace you can sustain for long periods. This is the cornerstone of modern endurance training. The goal isn't to "tolerate" lactate, but to train your body to use it as a powerful fuel source.</p><p class="mt-2"><b class="text-slate-700 dark:text-slate-300">The Science & Philosophy:</b></p><ul class="list-disc pl-5 space-y-1 mt-1"><li><b class="text-slate-700 dark:text-slate-300">Lactate Threshold (LT)</b> is the intensity at which lactate begins to accumulate in the blood faster than it can be cleared. Training here raises this tipping point.</li><li><b class="text-slate-700 dark:text-slate-300">Mike Scannell's</b> approach with athletes like Grant Fisher focuses on finding the "maximal steady state" — the highest intensity where lactate levels remain stable (traditionally cited as ~4.0 mmol/L, but highly individual). This is a pace that can be sustained for 60+ minutes in elite athletes.</li><li>The <b class="text-slate-700 dark:text-slate-300">Norwegian model</b> used by Jakob Ingebrigtsen involves "double threshold" days, using lactate meters to ensure efforts stay within a specific range (often 2.5-4.5 mmol/L). This allows for a large volume of high-quality work without excessive stress, enabling faster recovery and more frequent stimuli.</li></ul><p class="mt-2"><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> "Comfortably hard." Your breathing is deep and controlled, but not labored. You can speak a few words at a time, but not hold a conversation. Crucially, as per Canova's philosophy, you should finish the workout feeling strong and in control, not completely spent. You should feel like you could have done "one more rep" or held the pace for "ten more minutes."</p></div>` },
                { type: 'details', title: 'CV (Critical Velocity)', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> Popularized by coach Tom "Tinman" Schwartz, Critical Velocity (CV) is a pace approximately equivalent to <strong class="text-slate-700 dark:text-slate-300">10k race effort</strong>, or an intensity you could sustain all-out for about 30-35 minutes. Training with intervals at this pace is a highly efficient way to improve aerobic power, running economy, and lactate clearance with less stress than traditional, faster VO₂max intervals.</p><p><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> Hard, but controlled and rhythmic. It's faster and more demanding than a threshold run, but it is NOT a sprint. You are breathing hard and can't hold a conversation. The key is to keep the effort smooth and consistent throughout each repetition, hitting your target splits without straining. Tinman describes it as "comfortably hard" but a step up from tempo running.</p></div>` },
                { type: 'header', title: 'Race Pace Descriptions' },
                { type: 'details', title: '5k Pace', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> This is a high-end aerobic effort, bordering on maximum oxygen uptake (VO₂max). Racing and training at this intensity is a potent stimulus for improving your aerobic power and your ability to tolerate significant metabolic discomfort.</p><p><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> Very hard. From the first mile, the effort is demanding. Breathing is deep and rapid, and conversation is impossible. The middle of the race requires significant mental focus to maintain pace as fatigue builds. The final kilometer is an exercise in pushing through pain and maintaining form as your body screams to slow down.</p></div>` },
                { type: 'details', title: '3200m Pace', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> This is a true VO₂max effort. It directly targets your body's maximum ability to transport and use oxygen. It requires a blend of speed, aerobic power, and grit, making it a cornerstone of track-focused training.</p><p><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> Intense from the start. The pace feels manageable for the first lap or two, but discomfort escalates quickly. Breathing is maximal, and your muscles will begin to burn from lactate accumulation. The final laps are a mental and physical battle to hold on, fighting the urge to slow down as you operate at or near your absolute physiological limit.</p></div>` },
                { type: 'details', title: '1600m (Mile) Pace', content: `<div class="space-y-2 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">Purpose:</b> A classic middle-distance event that requires a unique combination of speed, VO₂max power, and anaerobic endurance. Training at this pace improves speed endurance and your ability to recruit muscle fibers quickly and efficiently under high fatigue.</p><p><b class="text-slate-700 dark:text-slate-300">How it Feels:</b> Fast and demanding from the gun. The pace feels quick but not quite a sprint for the first lap. By the second and third laps ("the championship laps"), the effort is extremely high, lactate builds rapidly, and breathing is labored. The final 400m is an all-out drive, fighting to maintain form and turnover as your body reaches its anaerobic limit.</p></div>` },
                { type: 'header', title: 'The Bear Challenge' },
                { type: 'details', title: "Boys' Standards", content: `<div class="space-y-3 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">What is "The Bear":</b> A 1.17-mile uphill course with a 308-foot elevation gain (avg grade 5.0%), starting at 6,979 feet and finishing at 7,287 feet. It's a benchmark workout to develop aerobic capacity, muscular endurance, and mental resilience.</p><hr class="border-slate-200 dark:border-slate-600 my-2"><div><h4 class="font-semibold text-slate-800 dark:text-slate-200">Shoes/Spikes Reward: Breaking 7:00</h4><ul class="list-disc pl-5 space-y-1 mt-1"><li><b class="text-slate-700 dark:text-slate-300">Achievement:</b> Running 7:00 or faster.</li><li><b class="text-slate-700 dark:text-slate-300">What It Means:</b> This shows you’re in about <b class="text-slate-700 dark:text-slate-200">15:30 5K shape</b>. It’s a big deal and highlights your speed and endurance.</li><li><b class="text-slate-700 dark:text-slate-300">Reward:</b> A new pair of running shoes or spikes.</li></ul></div><div><h4 class="font-semibold text-slate-800 dark:text-slate-200 mt-2">"I Conquered The Bear" Shirt: Breaking 8:00</h4><ul class="list-disc pl-5 space-y-1 mt-1"><li><b class="text-slate-700 dark:text-slate-300">Achievement:</b> Running 8:00 or faster.</li><li><b class="text-slate-700 dark:text-slate-300">What It Means:</b> This is like being in around <b class="text-slate-700 dark:text-slate-200">17:00 5K shape</b>. It shows you have strong endurance and running skills.</li><li><b class="text-slate-700 dark:text-slate-300">Reward:</b> The “I Conquered The Bear” shirt.</li></ul></div></div>` },
                { type: 'details', title: "Girls' Standards", content: `<div class="space-y-3 text-sm text-slate-600 dark:text-slate-400"><p><b class="text-slate-700 dark:text-slate-300">What is "The Bear":</b> A 1.17-mile uphill course with a 308-foot elevation gain (avg grade 5.0%), starting at 6,979 feet and finishing at 7,287 feet. It's a benchmark workout to develop aerobic capacity, muscular endurance, and mental resilience.</p><hr class="border-slate-200 dark:border-slate-600 my-2"><div><h4 class="font-semibold text-slate-800 dark:text-slate-200">Shoes/Spikes Reward: Breaking 9:00</h4><ul class="list-disc pl-5 space-y-1 mt-1"><li><b class="text-slate-700 dark:text-slate-300">Achievement:</b> Running 9:00 or faster.</li><li><b class="text-slate-700 dark:text-slate-300">What It Means:</b> This shows you’re in about <b class="text-slate-700 dark:text-slate-200">18:30 5K shape</b> at sea level.</li><li><b class="text-slate-700 dark:text-slate-300">Reward:</b> A new pair of running shoes or spikes.</li></ul></div><div><h4 class="font-semibold text-slate-800 dark:text-slate-200 mt-2">"I Conquered The Bear" Shirt: Breaking 10:00</h4><ul class="list-disc pl-5 space-y-1 mt-1"><li><b class="text-slate-700 dark:text-slate-300">Achievement:</b> Running 10:00 or faster.</li><li><b class="text-slate-700 dark:text-slate-300">What It Means:</b> This is like being in around <b class="text-slate-700 dark:text-slate-200">20:00 5K shape</b> at sea level.</li><li><b class="text-slate-700 dark:text-slate-300">Reward:</b> The “I Conquered The Bear” shirt.</li></ul></div></div>` },
            ];

            const DOMElements = {
                wrapper: document.getElementById('pc-calculator-wrapper'),
                darkToggle: document.getElementById("darkToggle"),
                darkToggleIndicator: document.getElementById("darkToggleIndicator"),
                mainCalcForm: document.getElementById("main-calc-form"),
                goalPaceForm: document.getElementById("goal-pace-form"),
                resultsColumn: document.getElementById("results-column"),
                modalOverlay: document.getElementById('modal-overlay'),
                modalContent: document.getElementById('modal-content'),
                toastContainer: document.getElementById('toast-container'),
                infoContainer: document.getElementById('infoContainer'),
                srAnnouncer: document.getElementById('sr-announcer'),
                tabs: {
                    calc: { btn: document.getElementById('tab-calc-btn'), content: document.getElementById('tab-calc-content') },
                    convert: { btn: document.getElementById('tab-convert-btn'), content: document.getElementById('tab-convert-content') },
                    history: { btn: document.getElementById('tab-history-btn'), content: document.getElementById('tab-history-content') },
                    settings: { btn: document.getElementById('tab-settings-btn'), content: document.getElementById('tab-settings-content') }
                }
            };

            const Calculations = {
                timeToSec(timeStr, format = 'mm:ss') {
                    if (!timeStr || typeof timeStr !== 'string') return NaN;
                    const parts = timeStr.trim().split(':').map(Number);
                    if (parts.some(isNaN)) return NaN;
                    if (format === 'hh:mm:ss' && parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
                    if (format === 'mm:ss' && parts.length === 2) return parts[0] * 60 + parts[1];
                    if (parts.length === 1) return parts[0];
                    return NaN;
                },
                secToPace(sec, unit = 'miles') {
                    if (isNaN(sec) || !isFinite(sec)) return "N/A";

                    // sec comes in as seconds-per-mile; to get seconds-per-km, multiply by km/mile ratio
                    if (unit === 'km') {
                        sec = sec * (METERS_PER_KM / METERS_PER_MILE);
                    }

                    sec = Math.round(sec);
                    const m = Math.floor(sec / 60);
                    const s = sec % 60;
                    return `${m}:${String(s).padStart(2, '0')}`;
                },
                secToHMS(sec) {
                    if (isNaN(sec) || !isFinite(sec)) return "N/A";
                    sec = Math.round(sec);
                    const h = Math.floor(sec / 3600);
                    const m = Math.floor((sec % 3600) / 60);
                    const s = sec % 60;
                    let timeString = `${String(m).padStart(h > 0 ? 2 : 1, '0')}:${String(s).padStart(2, '0')}`;
                    if (h > 0) timeString = `${h}:${timeString}`;
                    return timeString;
                },
                getInterpolated5kTime(bearTimeInSec, benchmarks) {
                    const first = benchmarks[0], last = benchmarks[benchmarks.length - 1];
                    if (bearTimeInSec <= first.bear) {
                        const p2 = benchmarks[1];
                        return first.fiveK + (bearTimeInSec - first.bear) * (p2.fiveK - first.fiveK) / (p2.bear - first.bear);
                    }
                    if (bearTimeInSec >= last.bear) {
                        const p1 = benchmarks[benchmarks.length - 2];
                        return p1.fiveK + (bearTimeInSec - p1.bear) * (last.fiveK - p1.fiveK) / (last.bear - p1.bear);
                    }
                    for (let i = 0; i < benchmarks.length - 1; i++) {
                        if (bearTimeInSec >= benchmarks[i].bear && bearTimeInSec <= benchmarks[i + 1].bear) {
                            const p1 = benchmarks[i], p2 = benchmarks[i + 1];
                            return p1.fiveK + (bearTimeInSec - p1.bear) * (p2.fiveK - p1.fiveK) / (p2.bear - p1.bear);
                        }
                    }
                    return NaN;
                },
                getInterpolatedBearTime(fiveKTimeInSec, benchmarks) {
                    const sortedBenchmarks = [...benchmarks].sort((a, b) => a.fiveK - b.fiveK);
                    const first = sortedBenchmarks[0], last = sortedBenchmarks[sortedBenchmarks.length - 1];

                    if (fiveKTimeInSec <= first.fiveK) {
                        const p1 = sortedBenchmarks[0], p2 = sortedBenchmarks[1];
                        return p1.bear + (fiveKTimeInSec - p1.fiveK) * (p2.bear - p1.bear) / (p2.fiveK - p1.fiveK);
                    }
                    if (fiveKTimeInSec >= last.fiveK) {
                        const p1 = sortedBenchmarks[sortedBenchmarks.length - 2], p2 = sortedBenchmarks[sortedBenchmarks.length - 1];
                        return p1.bear + (fiveKTimeInSec - p1.fiveK) * (p2.bear - p1.bear) / (p2.fiveK - p1.fiveK);
                    }
                    for (let i = 0; i < sortedBenchmarks.length - 1; i++) {
                        if (fiveKTimeInSec >= sortedBenchmarks[i].fiveK && fiveKTimeInSec <= sortedBenchmarks[i + 1].fiveK) {
                            const p1 = sortedBenchmarks[i], p2 = sortedBenchmarks[i + 1];
                            return p1.bear + (fiveKTimeInSec - p1.fiveK) * (p2.bear - p1.bear) / (p2.fiveK - p1.fiveK);
                        }
                    }
                    return NaN;
                },
                calculateVDOT(distanceMeters, timeSeconds) {
                    if (timeSeconds <= 0) return 0;
                    const timeMinutes = timeSeconds / 60;
                    const velocity = distanceMeters / timeMinutes;
                    const percentVO2Max = 0.8 + 0.189439 * Math.exp(-0.012778 * timeMinutes) + 0.2989558 * Math.exp(-0.1932605 * timeMinutes);
                    const vo2 = -4.60 + 0.182258 * velocity + 0.000104 * Math.pow(velocity, 2);
                    return vo2 / percentVO2Max;
                },
                calculateTimeFromVDOT(vdot, distanceMeters) {
                    let min_v = 100, max_v = 500, velocity;
                    for (let i = 0; i < 30; i++) {
                        velocity = (min_v + max_v) / 2;
                        const timeMinutes = distanceMeters / velocity;
                        const percentVO2Max = 0.8 + 0.189439 * Math.exp(-0.012778 * timeMinutes) + 0.2989558 * Math.exp(-0.1932605 * timeMinutes);
                        const vo2 = -4.60 + 0.182258 * velocity + 0.000104 * Math.pow(velocity, 2);
                        if (vo2 / percentVO2Max < vdot) min_v = velocity; else max_v = velocity;
                    }
                    velocity = (min_v + max_v) / 2;
                    return (distanceMeters / velocity) * 60;
                },
                /**
                 * USTFCCA Conversion: Given a "from" event name and time in seconds,
                 * returns an array of { event, equivalentTimeSec, factor } for all matching conversions.
                 * Per USTFCCA rules, always round UP the last digit of the final time.
                 */
                applyUSTFCCA(fromEvent, timeInSeconds) {
                    return CONFIG.ustfccaConversions
                        .filter(c => c.from === fromEvent)
                        .map(c => ({
                            event: c.to,
                            factor: c.factor,
                            equivalentTimeSec: Math.ceil(timeInSeconds * c.factor * 100) / 100
                        }));
                },
                /**
                 * Get all unique "from" events from the USTFCCA table.
                 */
                getUSTFCCAFromEvents() {
                    return [...new Set(CONFIG.ustfccaConversions.map(c => c.from))];
                },
                /**
                 * NCAA Track Type Conversion.
                 * @param {string} eventLabel — distance label (e.g. '1500 Meters')
                 * @param {number} timeSec — time in seconds
                 * @param {string} fromType — 'flat' | 'banked' | 'undersized'
                 * @param {string} toType — 'flat' | 'banked' | 'undersized'
                 * @param {string} gender — 'men' | 'women'
                 * @returns {{ convertedTime: number, factor: number } | null}
                 */
                convertTrackType(eventLabel, timeSec, fromType, toType, gender) {
                    if (fromType === toType) return null;
                    const mapping = CONFIG.ncaaTrackConversions.eventMapping;
                    const factorKey = mapping[eventLabel];
                    if (!factorKey) return null;

                    const genderData = CONFIG.ncaaTrackConversions[gender];
                    if (!genderData) return null;

                    // Determine which factor table to use based on from→to direction
                    let tableKey;
                    if (fromType === 'undersized' && toType === 'flat') tableKey = 'undersizedToFlat';
                    else if (fromType === 'banked' && toType === 'flat') tableKey = 'bankedToFlat';
                    else if (fromType === 'undersized' && toType === 'banked') tableKey = 'undersizedToBanked';
                    else if (fromType === 'flat' && toType === 'banked') tableKey = 'flatToBanked';
                    // Reverse directions (derive factor as reciprocal)
                    else if (fromType === 'flat' && toType === 'undersized') {
                        const fwd = genderData['undersizedToFlat']?.[factorKey];
                        if (!fwd) return null;
                        const factor = 1 / fwd;
                        return { convertedTime: Math.ceil(timeSec * factor * 100) / 100, factor: Math.round(factor * 10000) / 10000 };
                    }
                    else if (fromType === 'banked' && toType === 'undersized') {
                        const fwd = genderData['undersizedToBanked']?.[factorKey];
                        if (!fwd) return null;
                        const factor = 1 / fwd;
                        return { convertedTime: Math.ceil(timeSec * factor * 100) / 100, factor: Math.round(factor * 10000) / 10000 };
                    }
                    else return null;

                    const factor = genderData[tableKey]?.[factorKey];
                    if (!factor) return null;
                    return { convertedTime: Math.ceil(timeSec * factor * 100) / 100, factor };
                },
                /**
                 * NCAA Altitude Adjustment — Official 2009 NCAA Data.
                 * Uses per-event percentage adjustments derived from published qualifying
                 * time allowances. Interpolates altitude and event distance for precision.
                 * @param {number} timeSec — actual time in seconds
                 * @param {number} altitudeFt — altitude in feet
                 * @param {number} distanceMeters — race distance in meters
                 * @returns {{ seaLevelTime: number, adjustment: number, adjustmentPct: number } | null}
                 */
                adjustAltitude(timeSec, altitudeFt, distanceMeters, gender = 'men') {
                    // DI/III model: percentage-based, gender-neutral (gender param reserved for future DII support)
                    if (altitudeFt < 3000 || distanceMeters < 800) return null;
                    const data = CONFIG.ncaaAltitudeData;

                    // Step 1: Interpolate altitude to get per-event percentages
                    function interpAlt(pctKey) {
                        if (altitudeFt <= data[0].altFt) return 0;
                        if (altitudeFt >= data[data.length - 1].altFt) {
                            const d1 = data[data.length - 2], d2 = data[data.length - 1];
                            const slope = (d2[pctKey] - d1[pctKey]) / (d2.altFt - d1.altFt);
                            return d2[pctKey] + slope * (altitudeFt - d2.altFt);
                        }
                        for (let i = 0; i < data.length - 1; i++) {
                            if (altitudeFt >= data[i].altFt && altitudeFt <= data[i + 1].altFt) {
                                const t = (altitudeFt - data[i].altFt) / (data[i + 1].altFt - data[i].altFt);
                                return data[i][pctKey] + t * (data[i + 1][pctKey] - data[i][pctKey]);
                            }
                        }
                        return 0;
                    }

                    const p800 = interpAlt('pct800');
                    const p1500 = interpAlt('pct1500');
                    const p5000 = interpAlt('pct5000');
                    const p10K = interpAlt('pct10000');

                    // Step 2: Interpolate by event distance between breakpoints
                    const breaks = [
                        { dist: 800, pct: p800 },
                        { dist: 1500, pct: p1500 },
                        { dist: 5000, pct: p5000 },
                        { dist: 10000, pct: p10K },
                    ];

                    let adjustPct;
                    if (distanceMeters <= breaks[0].dist) {
                        adjustPct = breaks[0].pct;
                    } else if (distanceMeters >= breaks[breaks.length - 1].dist) {
                        // Extrapolate beyond 10K
                        const b1 = breaks[breaks.length - 2], b2 = breaks[breaks.length - 1];
                        const slope = (b2.pct - b1.pct) / (b2.dist - b1.dist);
                        adjustPct = b2.pct + slope * (distanceMeters - b2.dist);
                    } else {
                        for (let i = 0; i < breaks.length - 1; i++) {
                            if (distanceMeters >= breaks[i].dist && distanceMeters <= breaks[i + 1].dist) {
                                const t = (distanceMeters - breaks[i].dist) / (breaks[i + 1].dist - breaks[i].dist);
                                adjustPct = breaks[i].pct + t * (breaks[i + 1].pct - breaks[i].pct);
                                break;
                            }
                        }
                    }

                    // Convert percentage to seconds
                    const adjustFrac = adjustPct / 100;
                    const adjustment = Math.round(timeSec * adjustFrac * 100) / 100;
                    const seaLevelTime = Math.round((timeSec - adjustment) * 100) / 100;

                    return {
                        seaLevelTime,
                        adjustment,
                        adjustmentPct: Math.round(adjustPct * 100) / 100
                    };
                },

                adjustTrackSize(timeSec, distanceMeters, trackType, gender = 'men') {
                    // NCAA Rule: Convert Flat/Undersized times DOWN to Banked/Oversized standard
                    // If track is already 'banked' or 'oversized', no adjustment needed.
                    if (!trackType || trackType === 'banked' || trackType === 'oversized') return null;

                    const data = CONFIG.ncaaTrackConversions;
                    const distMap = data.eventMapping;

                    // Find closest standard event distance
                    // Simple check: match exact meters first
                    let eventKey = null;
                    if (distanceMeters === 200) eventKey = '200 Meters';
                    else if (distanceMeters === 400) eventKey = '400 Meters';
                    else if (distanceMeters === 800) eventKey = '800 Meters';
                    else if (distanceMeters === 1000) eventKey = '1000 Meters';
                    else if (Math.abs(distanceMeters - 1609.34) < 10) eventKey = 'Mile';
                    else if (distanceMeters === 3000) eventKey = '3000 Meters';
                    else if (distanceMeters === 5000) eventKey = '5000 Meters';
                    else {
                        // Interpolation isn't really standard for track size, usually it triggers at specific events.
                        // But for calculator utility, we can map to closest.
                        // For now, only support standard distances for correct NCAA factors.
                        return null;
                    }

                    if (!eventKey) return null;

                    const genderKey = (gender === 'women' || gender === 'f') ? 'women' : 'men';
                    const factors = data[genderKey];

                    let factor = 1.0;

                    // We want to convert TO Banked/Standard.
                    // The factors in CONFIG are set up as "To Flat". 
                    // Let's verify CONFIG structure from lines 504-516:
                    // undersizedToFlat: { ... }  <-- multiplies by ~0.99 (makes time faster)
                    // bankedToFlat: { ... }      <-- multiplies by ~1.01 (makes time slower)
                    // 
                    // Wait, if I have a Flat time and want a Banked time:
                    // Flat is SLOWER than Banked.
                    // So Flat Time * Factor < 1 should give Banked Time.
                    // 
                    // In CONFIG (lines 510): flatToBanked: { ... } -> factors are ~0.98.
                    // This matches. Flat time (e.g. 100s) * 0.98 = 98s (Banked). Correct.

                    if (trackType === 'flat') {
                        if (factors.flatToBanked && factors.flatToBanked[eventKey]) {
                            factor = factors.flatToBanked[eventKey];
                        }
                    } else if (trackType === 'undersized') {
                        if (factors.undersizedToBanked && factors.undersizedToBanked[eventKey]) {
                            factor = factors.undersizedToBanked[eventKey];
                        }
                    }

                    if (factor === 1.0) return null;

                    const convertedTime = Math.round(timeSec * factor * 100) / 100;
                    const adjustment = Math.round((timeSec - convertedTime) * 100) / 100; // Positive value means time removed

                    return {
                        convertedTime,
                        adjustment,
                        factor
                    };
                },
            };

            const UI = {
                setDarkMode(isDark, savePreference = true) {
                    state.isDark = isDark;
                    DOMElements.wrapper.classList.toggle('dark', isDark);
                    DOMElements.darkToggleIndicator.style.transform = isDark ? 'translateX(24px)' : 'translateX(0px)';
                    DOMElements.darkToggleIndicator.innerHTML = isDark ? '<i class="ph-sun text-yellow-400"></i>' : '<i class="ph-moon text-indigo-600"></i>';

                    if (savePreference) {
                        localStorage.setItem('paceCalcDarkMode', isDark);
                    }

                    if (DOMElements.tabs.history.content.classList.contains('active')) {
                        this.renderHistoryTab();
                    }
                    if (state.latestCalculation) {
                        this.renderResults();
                    }
                },
                switchTab(tabKey) {
                    Object.values(DOMElements.tabs).forEach(tab => {
                        tab.btn.classList.remove('active');
                        tab.btn.setAttribute('aria-selected', 'false');
                        tab.content.classList.remove('active');
                    });
                    DOMElements.tabs[tabKey].btn.classList.add('active');
                    DOMElements.tabs[tabKey].btn.setAttribute('aria-selected', 'true');
                    DOMElements.tabs[tabKey].content.classList.add('active');

                    if (tabKey === 'convert') {
                        this.renderConvertTab();
                    }
                    if (tabKey === 'history') {
                        this.renderHistoryTab();
                    }
                    if (tabKey === 'settings') {
                        this.renderSettingsTab();
                    }
                    DOMElements.srAnnouncer.textContent = `${tabKey.charAt(0).toUpperCase() + tabKey.slice(1)} tab selected.`;
                },
                showToast(message, type = 'success') {
                    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                    const icon = type === 'success' ? '<i class="ph-check-circle"></i>' : '<i class="ph-x-circle"></i>';
                    const toast = document.createElement('div');
                    toast.className = `flex items-center gap-3 ${bgColor} text-white font-bold py-3 px-5 rounded-lg shadow-xl transform transition-all duration-300 pc-fade-in`;
                    toast.innerHTML = `${icon}<span>${message}</span>`;
                    DOMElements.toastContainer.appendChild(toast);
                    DOMElements.srAnnouncer.textContent = message;
                    setTimeout(() => {
                        toast.style.transform = 'translateX(120%)';
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                },
                showModal(htmlContent) {
                    DOMElements.modalContent.innerHTML = htmlContent;
                    DOMElements.modalOverlay.style.display = 'block';
                    DOMElements.modalContent.querySelector('button, a, input, select, textarea')?.focus();
                },
                hideModal() {
                    DOMElements.modalOverlay.style.display = 'none';
                    DOMElements.modalContent.innerHTML = '';
                },
                renderActionButtons(containerId) {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    const isSaved = state.latestCalculation && state.latestCalculation.isSaved;

                    let saveButtonHTML = '';
                    if (isSaved) {
                        saveButtonHTML = `<button id="savePaceBtn" aria-label="Pace is already saved" class="w-full flex items-center justify-center gap-2 bg-green-800 text-green-300 font-bold py-3 px-6 rounded-lg shadow-inner cursor-not-allowed" disabled><i class="ph-check-circle"></i><span>Saved</span></button>`;
                    } else {
                        saveButtonHTML = `<button id="savePaceBtn" aria-label="Save current pace calculation to history" class="w-full flex items-center justify-center gap-2 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-transform hover:scale-105"><i class="ph-floppy-disk"></i><span>Save Pace</span></button>`;
                    }

                    const undoButtonHTML = state.undoStack.length > 0 ? `
                    <button id="undo-btn" aria-label="Undo last action" class="w-full flex items-center justify-center gap-2 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition">
                        <i class="ph-arrow-u-left-down"></i><span>Undo (${state.undoStack.length})</span>
                    </button>
                ` : '';

                    container.innerHTML = `
                    <div class="space-y-2 sm:space-y-3 mt-4 sm:mt-6">
                        <button id="calc-btn" aria-label="Calculate paces" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold text-base sm:text-lg py-3 sm:py-4 px-4 sm:px-6 rounded-xl shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 hover:shadow-indigo-600/40 focus:outline-none focus:ring-4 focus:ring-indigo-500/20 transition-all transform hover:scale-[1.02]">
                            <i class="ph-calculator"></i><span>Calculate Paces</span>
                        </button>
                        <div class="pc-secondary-actions grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
                            <button id="reset-btn" aria-label="Reset" class="w-full flex items-center justify-center gap-1.5 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-2.5 sm:py-3 px-2 sm:px-4 rounded-xl hover:bg-slate-300 dark:hover:bg-slate-600 transition-all">
                                <i class="ph-arrows-counter-clockwise"></i><span>Reset</span>
                            </button>
                            ${saveButtonHTML}
                            ${undoButtonHTML}
                            <button id="shareBtn" aria-label="Share" class="w-full flex items-center justify-center gap-1.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-semibold py-2.5 sm:py-3 px-2 sm:px-4 rounded-xl border border-blue-200 dark:border-blue-800/40 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-all">
                                <span>📸</span><span>Share Card</span>
                            </button>
                            <button id="copyTableBtn" aria-label="Copy" class="w-full flex items-center justify-center gap-1.5 bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-400 font-semibold py-2.5 sm:py-3 px-2 sm:px-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
                                <i class="ph-copy"></i><span>Copy</span>
                            </button>
                            <button id="generatePaceCardBtn" aria-label="Pace Card" class="w-full flex items-center justify-center gap-1.5 bg-teal-50 dark:bg-teal-900/20 text-teal-600 dark:text-teal-400 font-semibold py-2.5 sm:py-3 px-2 sm:px-4 rounded-xl border border-teal-200 dark:border-teal-800/40 hover:bg-teal-100 dark:hover:bg-teal-900/40 transition-all">
                                <i class="ph-cardholder"></i><span>Pace Card</span>
                            </button>
                        </div>
                    </div>
                `;
                },
                renderEmptyState() {
                    DOMElements.resultsColumn.innerHTML = `
                    <div class="bg-gradient-to-br from-slate-50 to-indigo-50 dark:from-slate-800 dark:to-indigo-900/20 p-6 sm:p-12 rounded-2xl shadow-lg text-center h-full flex flex-col justify-center items-center pc-slide-up border border-slate-200/50 dark:border-slate-700/50">
                        <div class="w-14 h-14 sm:w-20 sm:h-20 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-4 sm:mb-6">
                            <i class="ph-chart-line-up text-2xl sm:text-4xl text-indigo-500 dark:text-indigo-400"></i>
                        </div>
                        <h3 class="text-lg sm:text-2xl font-bold text-slate-800 dark:text-slate-200">Ready to Run?</h3>
                        <p class="text-xs sm:text-base text-slate-500 dark:text-slate-400 mt-2 max-w-sm">Enter your time above to unlock personalized training zones.</p>
                        <div class="hidden sm:flex items-center gap-2 mt-6 text-xs font-semibold text-indigo-500 dark:text-indigo-400 uppercase tracking-wider">
                            <i class="ph-arrow-left"></i>
                            <span>Start on the left</span>
                        </div>
                    </div>
                `;
                },
                renderResults() {
                    const { vdot } = state.latestCalculation;
                    const displayUnit = state.settings.displayUnit;
                    const paceUnitLabel = displayUnit === 'miles' ? 'mi' : 'km';
                    DOMElements.resultsColumn.innerHTML = "";

                    // --- PR Detection ---
                    const history = JSON.parse(localStorage.getItem('paceCalcHistory') || '[]');
                    const prevBest = history.slice(0, -1).reduce((max, h) => Math.max(max, h.vdot || 0), 0);
                    const isNewPR = prevBest > 0 && vdot > prevBest;

                    // --- VDOT Progress Ring SVG ---
                    const vdotMin = 20, vdotMax = 85;
                    const vdotClamped = Math.max(vdotMin, Math.min(vdotMax, vdot));
                    const ringRadius = 38, ringCircumference = 2 * Math.PI * ringRadius;
                    const ringProgress = (vdotClamped - vdotMin) / (vdotMax - vdotMin);
                    const ringDashoffset = ringCircumference * (1 - ringProgress);

                    const progressRingHTML = `
                            <svg class="pc-progress-ring" width="90" height="90" viewBox="0 0 90 90">
                                <circle cx="45" cy="45" r="${ringRadius}" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="5"/>
                                <circle class="ring-progress" cx="45" cy="45" r="${ringRadius}" fill="none" stroke="#fbbf24" stroke-width="5"
                                    stroke-linecap="round" stroke-dasharray="${ringCircumference}" stroke-dashoffset="${ringCircumference}" />
                                <text x="45" y="42" text-anchor="middle" fill="white" font-size="10" font-weight="600" dominant-baseline="middle" style="transform: rotate(90deg); transform-origin: 45px 45px;">VDOT</text>
                                <text x="45" y="55" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="7" dominant-baseline="middle" style="transform: rotate(90deg); transform-origin: 45px 45px;">${vdotMin}–${vdotMax}</text>
                            </svg>`;

                    // --- VDOT Hero Card ---
                    const anchor5kTimeForHero = Calculations.calculateTimeFromVDOT(vdot, CONFIG.distMap.fiveK);
                    const heroCardHTML = `
                    <div class="pc-hero-card rounded-2xl shadow-xl p-4 sm:p-8 text-white pc-slide-up">
                        <div class="flex items-center justify-between gap-4">
                            <div class="text-center sm:text-left">
                                <p class="text-xs sm:text-sm font-semibold uppercase tracking-wider text-indigo-200">Your Fitness Level${state.latestCalculation.tempF > 60 ? `<span class="pc-temp-badge">🌡 Heat-Adjusted</span>` : ''}</p>
                                <div class="pc-hero-vdot text-5xl sm:text-7xl font-extrabold tracking-tight mt-1" data-target="${vdot.toFixed(1)}">0</div>
                                <p class="text-xs sm:text-sm font-semibold text-indigo-200 mt-1">VDOT Score <span class="opacity-70 font-normal">— your fitness index</span></p>
                                ${isNewPR ? `<span class="pc-pr-badge">🏆 New Personal Best!</span>` : ''}
                            </div>
                            <div class="flex flex-col items-center gap-2">
                                ${progressRingHTML}
                            </div>
                            <div class="flex-shrink-0 text-right">
                                <p class="text-[0.65rem] sm:text-xs font-semibold uppercase tracking-wider text-indigo-200">Equivalent 5K</p>
                                <div class="pc-hero-5k text-xl sm:text-3xl font-bold mt-1">${Calculations.secToHMS(anchor5kTimeForHero)}</div>
                                <p class="text-[0.6rem] sm:text-xs text-indigo-200/80 mt-1 sm:mt-2">Daniels' Running Formula</p>
                                <button class="pc-recalc-btn mt-2" onclick="state.currentStep=2; UI.renderCalculatorStep('back');">↩ Edit Time</button>
                            </div>
                        </div>
                    </div>
                `;
                    DOMElements.resultsColumn.innerHTML += heroCardHTML;

                    // Animate progress ring
                    const ringEl = DOMElements.resultsColumn.querySelector('.ring-progress');
                    if (ringEl) {
                        requestAnimationFrame(() => {
                            ringEl.style.strokeDashoffset = ringDashoffset;
                        });
                    }

                    // (confetti removed for cleaner UX)

                    // "You're close to..." motivational nudge
                    const nudgeHTML = this._buildNudgeHTML(vdot, state.selectedBasis);
                    if (nudgeHTML) {
                        DOMElements.resultsColumn.innerHTML += nudgeHTML;
                    }

                    // VDOT Progress Chart removed — cleaner for first-time users

                    const unitToggleHTML = `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg flex items-center justify-center gap-4 pc-no-print">
                        <label for="unit-toggle" class="font-semibold text-slate-700 dark:text-slate-300">Pace Unit:</label>
                        <select id="unit-toggle" class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0">
                            <option value="miles" ${displayUnit === 'miles' ? 'selected' : ''}>Miles</option>
                            <option value="km" ${displayUnit === 'km' ? 'selected' : ''}>Kilometers</option>
                        </select>
                    </div>
                `;
                    DOMElements.resultsColumn.innerHTML += unitToggleHTML;

                    const { xcAdjustmentMsg, effectiveAltitude } = state.latestCalculation;
                    if (xcAdjustmentMsg) {
                        DOMElements.resultsColumn.innerHTML += `
                                <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800/50 p-4 rounded-xl mb-4 pc-fade-in">
                                    <div class="flex items-start gap-3">
                                        <i class="ph-mountains text-2xl text-indigo-600 dark:text-indigo-400 mt-1"></i>
                                        <div>
                                            <h4 class="font-bold text-indigo-900 dark:text-indigo-100">XC Standardization Active</h4>
                                            <p class="text-sm text-indigo-800 dark:text-indigo-200 mt-1">
                                                Your time has been standardized to the <span class="font-semibold">Liberty Bell (5,340 ft)</span> course baseline using statistical conversion factors.
                                                All training paces and sea-level equivalents below are calculated from this standardized performance.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                    }

                    // VDOT Counter Animation — must be AFTER all innerHTML += calls
                    const heroVdotEl = DOMElements.resultsColumn.querySelector('.pc-hero-vdot');
                    if (heroVdotEl) {
                        const target = parseFloat(heroVdotEl.dataset.target);
                        const duration = 800;
                        const startTime = performance.now();
                        const animate = (now) => {
                            const elapsed = now - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                            heroVdotEl.textContent = (target * eased).toFixed(1);
                            if (progress < 1) requestAnimationFrame(animate);
                        };
                        requestAnimationFrame(animate);
                    }

                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = "bg-white dark:bg-slate-800 rounded-2xl shadow-lg pc-fade-in";

                    const vVO2maxPacePerMeter = Calculations.calculateTimeFromVDOT(vdot, CONFIG.distMap.fiveK) / CONFIG.distMap.fiveK;
                    state.paceCardData = { vdot: vdot.toFixed(1), paces: {} };

                    const sortedPaces = [...CONFIG.allPaces].sort((a, b) => {
                        const getSortValue = (item) => {
                            if (item.type === 'zone') return 1 / ((item.slow + item.fast) / 2);
                            return Calculations.calculateTimeFromVDOT(vdot, item.dist) / item.dist;
                        };
                        return getSortValue(b) - getSortValue(a);
                    });

                    const hrIsActive = state.settings.hrData.mhr || state.settings.hrData.lthr;
                    const hrHeaderClass = hrIsActive ? 'text-indigo-500 dark:text-indigo-400' : '';
                    const hrHeaderIcon = hrIsActive ? '<i class="ph-heart-fill text-xs ml-1"></i>' : '';

                    const allSplits = [...CONFIG.defaultSplitDistances, ...state.settings.customSplits].sort((a, b) => a.dist - b.dist);
                    const tableHeadersHTML = allSplits.map(split => `<th scope="col" class="px-4 py-3 font-semibold whitespace-nowrap">${split.label}</th>`).join('');

                    // --- Compute pace data for both mobile cards and desktop table ---
                    const paceData = sortedPaces.map((item, idx) => {
                        const accentColor = item.color;
                        const darkAccentColor = item.darkColor;
                        let slowPace, fastPace, predTimeRange = '';
                        let medianPacePerMeter;
                        const hrZone = AppLogic.getHRZone(item.name);

                        let splitValues = [];
                        if (item.type === 'zone') {
                            const slowPacePerMeter = vVO2maxPacePerMeter / item.slow;
                            const fastPacePerMeter = vVO2maxPacePerMeter / item.fast;
                            slowPace = Calculations.secToPace(slowPacePerMeter * METERS_PER_MILE, displayUnit);
                            fastPace = Calculations.secToPace(fastPacePerMeter * METERS_PER_MILE, displayUnit);
                            medianPacePerMeter = vVO2maxPacePerMeter / ((item.slow + item.fast) / 2);
                            splitValues = allSplits.map(split => ({ label: split.label, time: Calculations.secToPace(medianPacePerMeter * split.dist) }));
                            predTimeRange = '—';
                        } else {
                            const predTimeSec = Calculations.calculateTimeFromVDOT(vdot, item.dist);
                            const fastTime = predTimeSec * 0.985, slowTime = predTimeSec * 1.015;
                            const distInUnit = displayUnit === 'miles' ? item.dist / METERS_PER_MILE : item.dist / METERS_PER_KM;
                            slowPace = Calculations.secToPace(slowTime / distInUnit, displayUnit);
                            fastPace = Calculations.secToPace(fastTime / distInUnit, displayUnit);
                            medianPacePerMeter = predTimeSec / item.dist;
                            splitValues = allSplits.map(split => ({ label: split.label, time: Calculations.secToPace(medianPacePerMeter * split.dist) }));
                            predTimeRange = `${Calculations.secToHMS(fastTime)} – ${Calculations.secToHMS(slowTime)}`;
                        }
                        state.paceCardData.paces[item.name] = { medianPacePerMeter };
                        return { ...item, accentColor, darkAccentColor, slowPace, fastPace, hrZone, splitValues, predTimeRange, medianPacePerMeter, idx };
                    });

                    // --- Race condition variables (used by altitude bar + bottom card) ---
                    const calcGenderEl = document.getElementById('calc-gender');
                    const calcTrackEl = document.getElementById('calc-track-type');
                    const calcAltEl = document.getElementById('calc-altitude');
                    const calcGender = calcGenderEl ? calcGenderEl.value : 'men';
                    const calcTrackType = calcTrackEl ? calcTrackEl.value : 'flat';
                    const calcAltFt = calcAltEl ? parseFloat(calcAltEl.value) || 0 : 0;
                    const hasTrackAdj = calcTrackType !== 'flat';

                    // Build altitude/track adjustment bar above the pace table
                    let altBarHTML = '';
                    if (calcAltFt >= 3000 || hasTrackAdj) {
                        const altEvents = [
                            { name: '800m', meters: 800 },
                            { name: '1500m', meters: 1500 },
                            { name: '1600m', meters: CONFIG.distMap.oneSix },
                            { name: 'Mile', meters: METERS_PER_MILE },
                            { name: '3200m', meters: CONFIG.distMap.threeTwo },
                            { name: '5K', meters: CONFIG.distMap.fiveK },
                            { name: '10K', meters: 10000 },
                        ];
                        let pillsHTML = '';
                        altEvents.forEach(ev => {
                            const predTime = Calculations.calculateTimeFromVDOT(vdot, ev.meters);
                            const adjAlt = Calculations.adjustAltitude(predTime, calcAltFt, ev.meters, calcGender);
                            const adjTrack = Calculations.adjustTrackSize(predTime, ev.meters, calcTrackType, calcGender);
                            let totalAdj = 0;
                            let tooltips = [];
                            if (adjAlt) {
                                totalAdj += adjAlt.adjustment;
                                tooltips.push(`Alt: -${adjAlt.adjustment.toFixed(1)}s`);
                            }
                            if (adjTrack) {
                                totalAdj += adjTrack.adjustment;
                                const sign = adjTrack.adjustment >= 0 ? '-' : '+';
                                tooltips.push(`Track: ${sign}${Math.abs(adjTrack.adjustment).toFixed(1)}s`);
                            }
                            if (totalAdj !== 0) {
                                const convertedTime = predTime - totalAdj;
                                const titleStr = tooltips.join(', ');
                                pillsHTML += `<span class="inline-flex items-center gap-1 bg-white/70 dark:bg-slate-700/70 rounded-full px-2.5 py-1 text-xs" title="${titleStr}">
                                        <span class="font-semibold text-rose-700 dark:text-rose-300">${ev.name}</span>
                                        <span class="text-slate-900 dark:text-white font-bold">${Calculations.secToHMS(convertedTime)}</span>
                                        <span class="text-rose-500 dark:text-rose-400">(${totalAdj >= 0 ? '−' : '+'}${Math.abs(totalAdj).toFixed(1)}s)</span>
                                    </span>`;
                            }
                        });
                        const barLabel = (calcAltFt >= 3000 && hasTrackAdj) ? `Conversions (${calcAltFt.toLocaleString()}ft + ${calcTrackType})`
                            : (calcAltFt >= 3000) ? `Sea-Level Equivalents (${calcAltFt.toLocaleString()} ft)`
                                : `Track Conversions (${calcTrackType})`;
                        if (pillsHTML) {
                            altBarHTML = `<div class="bg-gradient-to-r from-rose-50 to-rose-100/60 dark:from-rose-900/20 dark:to-rose-800/10 border border-rose-200 dark:border-rose-800/30 rounded-xl px-4 py-3 mb-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase tracking-wide">🏔 ${barLabel}</span>
                                    </div>
                                    <div class="flex flex-wrap gap-1.5">${pillsHTML}</div>
                                </div>`;
                        }
                    }

                    // --- MOBILE CARDS VIEW (hidden on sm+) ---
                    const zoneItems = paceData.filter(d => d.type === 'zone');
                    const raceItems = paceData.filter(d => d.type === 'race');

                    const buildMobileCard = (d, idx) => {
                        const accent = state.isDark ? d.darkAccentColor : d.accentColor;
                        const isRace = d.type === 'race';
                        const splitsId = `splits-${d.name.replace(/\s+/g, '-').toLowerCase()}`;
                        const topSplits = d.splitValues.slice(0, 4);
                        const hasSplits = d.splitValues.length > 0;

                        return `<div class="pc-mobile-pace-card group pc-stagger-card" style="--accent: ${accent};">
                                <div class="flex items-start gap-3 mb-2">
                                    <div class="w-2.5 h-2.5 rounded-full flex-shrink-0 mt-1.5" style="background: ${accent};"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-900 dark:text-white text-[0.95rem] tracking-tight">${d.name}</span>
                                            ${d.hrZone !== 'N/A' ? `<span class="ml-auto text-[0.65rem] font-semibold px-2 py-0.5 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400">${d.hrZone}</span>` : ''}
                                            ${isRace ? `<span class="ml-auto text-[0.6rem] font-medium uppercase tracking-wider text-slate-400 dark:text-slate-500">Race</span>` : ''}
                                        </div>
                                        ${({ 'Recovery': 'Easy jog, conversation pace', 'Foundation': 'Aerobic base building', 'Steady': 'Sub Threshold (Sub T)', 'Tempo': 'Lactate Threshold 1 (LT1)', 'Lactate Threshold': 'LT2, sustainable hard effort', 'CV': 'Critical velocity, ~10K effort' })[d.name] ? `<p class="text-[0.65rem] text-slate-400 dark:text-slate-500 font-medium leading-tight mt-0.5">${({ 'Recovery': 'Easy jog, conversation pace', 'Foundation': 'Aerobic base building', 'Steady': 'Sub Threshold (Sub T)', 'Tempo': 'Lactate Threshold 1 (LT1)', 'Lactate Threshold': 'LT2, sustainable hard effort', 'CV': 'Critical velocity, ~10K effort' })[d.name]}</p>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-1.5 ml-[22px]">
                                    <span class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight tabular-nums">${d.slowPace === d.fastPace ? d.slowPace : `${d.slowPace} – ${d.fastPace}`}</span>
                                    <span class="text-xs text-slate-400 dark:text-slate-500 font-medium">/${paceUnitLabel}</span>
                                </div>
                                ${isRace && d.predTimeRange !== '—' ? `<div class="ml-[22px] mt-1 text-xs text-slate-500 dark:text-slate-400 tabular-nums">Predicted: ${d.predTimeRange}</div>` : ''}
                                ${hasSplits ? `<div class="ml-[22px] mt-2.5">
                                    <button onclick="document.getElementById('${splitsId}').classList.toggle('hidden'); this.querySelector('.pc-chevron').classList.toggle('rotate-90');" class="flex items-center gap-1 text-[0.65rem] font-semibold uppercase tracking-wider text-indigo-500 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors">
                                        <svg class="pc-chevron w-3 h-3 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                                        Splits
                                    </button>
                                    <div id="${splitsId}" class="hidden mt-2 grid grid-cols-3 gap-x-3 gap-y-1.5 text-xs tabular-nums">
                                        ${d.splitValues.map(s => `<div class="flex justify-between"><span class="text-slate-400 dark:text-slate-500">${s.label}</span><span class="font-semibold text-slate-700 dark:text-slate-300">${s.time}</span></div>`).join('')}
                                    </div>
                                </div>` : ''}
                            </div>`;
                    };

                    const mobileCardsHTML = `
                        <div class="pc-mobile-cards sm:hidden">
                            ${altBarHTML ? `<div class="mb-3">${altBarHTML}</div>` : ''}
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-base font-bold text-slate-900 dark:text-white tracking-tight">Training Zones</h3>
                                <div class="flex-1 h-px bg-gradient-to-r from-indigo-500/30 to-transparent"></div>
                            </div>
                            <div class="space-y-2 mb-5">
                                ${zoneItems.map(buildMobileCard).join('')}
                            </div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-base font-bold text-slate-900 dark:text-white tracking-tight">Race Paces</h3>
                                <div class="flex-1 h-px bg-gradient-to-r from-indigo-500/30 to-transparent"></div>
                            </div>
                            <div class="space-y-2">
                                ${raceItems.map(buildMobileCard).join('')}
                            </div>
                        </div>`;

                    // --- DESKTOP TABLE VIEW (hidden on mobile) ---
                    const cellStyle = "px-3 sm:px-4 py-3 whitespace-nowrap text-slate-700 dark:text-slate-200 tabular-nums";
                    const tableBodyHTML = paceData.map(d => {
                        const splitsHTML = d.splitValues.map(s => `<td class="${cellStyle}">${s.time}</td>`).join('');
                        const paceHTML = `<td class="${cellStyle} font-semibold">${d.slowPace}</td><td class="${cellStyle} font-semibold">${d.fastPace}</td><td class="${cellStyle} text-slate-400 dark:text-slate-500">${d.hrZone}</td>${splitsHTML}<td class="${cellStyle} text-slate-500 dark:text-slate-400 text-xs">${d.predTimeRange}</td>`;
                        const isEven = d.idx % 2 === 0;
                        const rowBg = isEven ? 'bg-white dark:bg-slate-800' : 'bg-slate-50/80 dark:bg-slate-800/60';
                        const accent = state.isDark ? d.darkAccentColor : d.accentColor;
                        return `<tr class="${rowBg} border-b border-slate-100 dark:border-slate-700/50 hover:bg-slate-100/80 dark:hover:bg-slate-700/40 transition-colors" style="border-left: 3px solid ${accent};">
                                <td class="pc-sticky-col px-3 sm:px-4 py-3 font-semibold whitespace-nowrap text-slate-900 dark:text-white ${rowBg}" style="border-left: 3px solid ${accent};">${d.name}</td>
                                ${paceHTML}
                            </tr>`;
                    }).join('');

                    tableWrapper.innerHTML = `
                    ${mobileCardsHTML}
                    <div class="hidden sm:block">
                        <div class="p-4 sm:p-6 pb-2">
                            ${altBarHTML}
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white tracking-tight">Training & Race Paces</h3>
                            </div>
                            <div class="h-px bg-gradient-to-r from-indigo-500/40 via-slate-200 dark:via-slate-600 to-transparent mt-3"></div>
                        </div>
                        <div class="table-container max-h-[50vh] lg:max-h-none overflow-auto">
                            <table id="paceTable" class="w-full text-sm text-left" style="font-feature-settings: 'tnum';">
                                <thead class="pc-sticky-header text-[0.65rem] sm:text-xs text-slate-400 dark:text-slate-500 uppercase tracking-wider bg-slate-50 dark:bg-slate-800/90">
                                    <tr>
                                        <th scope="col" class="pc-sticky-col px-3 sm:px-4 py-2.5 font-medium bg-slate-50 dark:bg-slate-800/90 whitespace-nowrap">Zone/Dist.</th>
                                        <th scope="col" class="px-3 sm:px-4 py-2.5 font-medium whitespace-nowrap">Slow</th>
                                        <th scope="col" class="px-3 sm:px-4 py-2.5 font-medium whitespace-nowrap">Fast</th>
                                        <th scope="col" class="px-3 sm:px-4 py-2.5 font-medium whitespace-nowrap ${hrHeaderClass}">HR ${hrHeaderIcon}</th>
                                        ${tableHeadersHTML}
                                        <th scope="col" class="px-3 sm:px-4 py-2.5 font-medium whitespace-nowrap">Pred. Range</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">${tableBodyHTML}</tbody>
                            </table>
                        </div>
                    </div>`;
                    DOMElements.resultsColumn.appendChild(tableWrapper);

                    const equivWrapper = document.createElement('div');
                    equivWrapper.className = "bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg pc-fade-in";

                    // --- Grouped Performance Equivalents ---
                    const equivGroups = [
                        {
                            label: 'Track',
                            color: 'indigo',
                            races: [
                                { name: "800m", dist: 800, type: 'vdot' },
                                { name: "1500m", dist: 1500, type: 'vdot' },
                                { name: "Mile", dist: METERS_PER_MILE, type: 'vdot' },
                                { name: "1600m", dist: CONFIG.distMap.oneSix, type: 'vdot' },
                                { name: "3200m", dist: CONFIG.distMap.threeTwo, type: 'vdot' },
                            ]
                        },
                        {
                            label: 'Road',
                            color: 'emerald',
                            races: [
                                { name: "5K", dist: CONFIG.distMap.fiveK, type: 'vdot' },
                                { name: "10K", dist: 10000, type: 'vdot' },
                                { name: "Half Marathon", dist: CONFIG.distMap.halfMarathon, type: 'vdot' },
                                { name: "Marathon", dist: CONFIG.distMap.marathon, type: 'vdot' },
                            ]
                        },
                        {
                            label: 'Colorado Springs Courses',
                            color: 'amber',
                            races: [
                                { name: "The Bear", type: 'special', note: '1.17 mi' },
                                { name: "Palmer Lake", dist: CONFIG.distMap.palmerLake, type: 'vdot', note: '4 mi' },
                                { name: "MVP", type: 'course', factor: CONFIG.courseFactors.mvp, note: '5K · 6,109 ft' },
                                { name: "State XC", type: 'course', factor: CONFIG.courseFactors.stateXC, note: 'Norris Penrose · 5K' },
                            ]
                        }
                    ];

                    const equivGroupsHTML = equivGroups.map(group => {
                        const cardsHTML = group.races.map(race => {
                            let predTimeSec;
                            if (race.type === 'special' && race.name === 'The Bear') {
                                const anchor5kTime = Calculations.calculateTimeFromVDOT(vdot, CONFIG.distMap.fiveK);
                                predTimeSec = Calculations.getInterpolatedBearTime(anchor5kTime, CONFIG.benchmarks);
                            } else if (race.type === 'course') {
                                // Speed factor < 1 means slower course → divide to get longer time
                                const flat5kTime = Calculations.calculateTimeFromVDOT(vdot, CONFIG.distMap.fiveK);
                                predTimeSec = flat5kTime / race.factor;
                            } else {
                                predTimeSec = Calculations.calculateTimeFromVDOT(vdot, race.dist);
                            }
                            const fastTime = predTimeSec * 0.985;
                            const slowTime = predTimeSec * 1.015;

                            return `<div class="bg-slate-100 dark:bg-slate-700/50 p-3 sm:p-4 rounded-xl shadow-sm">
                                    <div class="text-xs sm:text-sm font-semibold text-slate-500 dark:text-slate-400">${race.name}</div>
                                    ${race.note ? `<div class="text-[0.6rem] text-slate-400 dark:text-slate-500 font-medium">${race.note}</div>` : ''}
                                    <div class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white mt-0.5">${Calculations.secToHMS(fastTime)} – ${Calculations.secToHMS(slowTime)}</div>
                                </div>`;
                        }).join('');

                        return `
                                <div class="flex items-center gap-2 mt-4 mb-2 first:mt-0">
                                    <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                                    <span class="text-[0.6rem] sm:text-xs font-semibold text-${group.color}-500 dark:text-${group.color}-400 uppercase tracking-wider">${group.label}</span>
                                    <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 text-center">${cardsHTML}</div>`;
                    }).join('');

                    equivWrapper.innerHTML = `
                    <h3 class="text-xl font-bold mb-1 text-slate-900 dark:text-white">Performance Equivalents</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">Based on a VDOT of <span class="font-bold text-indigo-500 dark:text-indigo-400">${vdot.toFixed(1)}</span></p>
                    ${equivGroupsHTML}
                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-4">
                        Predictions represent a likely performance range (±1.5%) based on Daniels' Running Formula.
                    </p>`;
                    DOMElements.resultsColumn.appendChild(equivWrapper);

                    // --- USTFCCA Conversions Card (collapsed by default) ---
                    let totalConversions = 0;
                    let allConversionsHTML = '';
                    CONFIG.ustfccaDistanceEvents.forEach(({ event: eventName, meters }) => {
                        const timeSec = Calculations.calculateTimeFromVDOT(vdot, meters);
                        const conversions = Calculations.applyUSTFCCA(eventName, timeSec);
                        if (conversions.length > 0) {
                            totalConversions += conversions.length;
                            allConversionsHTML += `
                            <div class="mb-4">
                                <h4 class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 mb-2">From ${eventName} (${Calculations.secToHMS(timeSec)})</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${conversions.map(c => `
                                        <div class="bg-slate-100 dark:bg-slate-700/50 p-3 rounded-xl">
                                            <div class="text-xs font-semibold text-slate-500 dark:text-slate-400">${c.event}</div>
                                            <div class="text-lg font-bold text-slate-900 dark:text-white">${Calculations.secToHMS(c.equivalentTimeSec)}</div>
                                            <div class="text-xs text-slate-400 dark:text-slate-500">× ${c.factor}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        }
                    });

                    if (allConversionsHTML) {
                        const ustfccaWrapper = document.createElement('div');
                        ustfccaWrapper.className = "bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg pc-fade-in";
                        ustfccaWrapper.innerHTML = `
                                <details>
                                    <summary class="cursor-pointer flex items-center justify-between">
                                        <div>
                                            <h3 class="text-xl font-bold text-slate-900 dark:text-white"><i class="ph-arrows-left-right mr-2"></i>USTFCCA Distance Conversions</h3>
                                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">${totalConversions} official conversions available — tap to expand</p>
                                        </div>
                                        <i class="ph-caret-down text-xl text-slate-400 transition-transform"></i>
                                    </summary>
                                    <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                                        ${allConversionsHTML}
                                        <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">Source: USTFCCA Standardized Conversion Factors (Rev. 01/10/12)</p>
                                    </div>
                                </details>
                            `;
                        DOMElements.resultsColumn.appendChild(ustfccaWrapper);
                    }
                    // --- End USTFCCA Conversions Card ---

                    // --- NCAA Track Type Adjustments Card ---

                    if (hasTrackAdj) {
                        const ncaaWrapper = document.createElement('div');
                        ncaaWrapper.className = 'bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg pc-fade-in';

                        let ncaaInnerHTML = `<h3 class="text-xl font-bold text-slate-900 dark:text-white mb-1">Track Type Conversions</h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Based on your selected track type</p>`;

                        const trackEvents = [
                            { name: '200 Meters', meters: 200 },
                            { name: '400 Meters', meters: 400 },
                            { name: '800 Meters', meters: 800 },
                            { name: 'Mile', meters: METERS_PER_MILE },
                            { name: '1500 Meters', meters: 1500 },
                            { name: '3000 Meters', meters: 3000 },
                            { name: '3200 Meters', meters: CONFIG.distMap.threeTwo },
                            { name: '5000 Meters', meters: 5000 },
                        ];
                        const targetTypes = ['flat', 'banked', 'undersized'].filter(t => t !== calcTrackType);
                        let trackCardsHTML = '';
                        trackEvents.forEach(ev => {
                            const predTime = Calculations.calculateTimeFromVDOT(vdot, ev.meters);
                            targetTypes.forEach(toType => {
                                const c = Calculations.convertTrackType(ev.name, predTime, calcTrackType, toType, calcGender);
                                if (c) {
                                    const typeLabel = toType === 'flat' ? '200m Flat' : toType.charAt(0).toUpperCase() + toType.slice(1);
                                    trackCardsHTML += `
                                            <div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800/30 p-3 rounded-xl text-center">
                                                <div class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">${ev.name} → ${typeLabel}</div>
                                                <div class="text-lg font-bold text-slate-900 dark:text-white">${Calculations.secToHMS(c.convertedTime)}</div>
                                                <div class="text-xs text-emerald-500 dark:text-emerald-400">× ${c.factor}</div>
                                            </div>`;
                                }
                            });
                        });
                        if (trackCardsHTML) {
                            const fromLabel = calcTrackType === 'flat' ? '200m Flat' : calcTrackType.charAt(0).toUpperCase() + calcTrackType.slice(1);
                            ncaaInnerHTML += `<div>
                                    <h4 class="text-sm font-semibold text-emerald-600 dark:text-emerald-400 mb-2"><i class="ph-path mr-1"></i>${fromLabel} → Other Track Types</h4>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">${trackCardsHTML}</div>
                                </div>`;
                        }

                        ncaaWrapper.innerHTML = ncaaInnerHTML;
                        DOMElements.resultsColumn.appendChild(ncaaWrapper);
                    }
                    // --- End Track Type Conversions Card ---

                    DOMElements.srAnnouncer.textContent = "Calculation results updated.";
                },
                renderConvertTab() {
                    const container = DOMElements.tabs.convert.content;
                    // Comprehensive distance list — short to long
                    const distances = [
                        { label: '200 Meters', meters: 200 },
                        { label: '300 Meters', meters: 300 },
                        { label: '300 Yards', meters: 274.32 },
                        { label: '400 Meters', meters: 400 },
                        { label: '440 Yards', meters: 402.34 },
                        { label: '500 Meters', meters: 500 },
                        { label: '500 Yards', meters: 457.2 },
                        { label: '600 Meters', meters: 600 },
                        { label: '600 Yards', meters: 548.64 },
                        { label: '800 Meters', meters: 800 },
                        { label: '1000 Meters', meters: 1000 },
                        { label: '1200 Meters', meters: 1200 },
                        { label: '1500 Meters', meters: 1500 },
                        { label: '1600 Meters', meters: 1600 },
                        { label: 'Mile', meters: METERS_PER_MILE },
                        { label: '2000 Meters', meters: 2000 },
                        { label: '3000 Meters', meters: 3000 },
                        { label: '3200 Meters', meters: 3200 },
                        { label: 'Two Mile', meters: 2 * METERS_PER_MILE },
                        { label: 'Three Mile', meters: 3 * METERS_PER_MILE },
                        { label: '5000 Meters', meters: 5000 },
                        { label: '10,000 Meters', meters: 10000 },
                        { label: 'Half Marathon', meters: 21097.5 },
                        { label: 'Marathon', meters: 42195 },
                    ];
                    // Store on CONFIG for reuse
                    CONFIG._convertDistances = distances;

                    container.innerHTML = `
                    <div class="max-w-3xl mx-auto space-y-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2"><i class="ph-arrows-left-right mr-2"></i>Universal Distance Converter</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Enter any distance and time to see equivalent performances across all standard race distances.</p>

                            <div class="space-y-4">
                                <div>
                                    <label for="convert-event-select" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Distance</label>
                                    <select id="convert-event-select" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg">
                                        ${distances.map((d, i) => `<option value="${i}"${d.label === '1500 Meters' ? ' selected' : ''}>${d.label}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="convert-time-format" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Time Format</label>
                                    <select id="convert-time-format" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg">
                                        <option value="mm:ss">MM:SS</option>
                                        <option value="hh:mm:ss">HH:MM:SS</option>
                                        <option value="seconds">Seconds Only</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Time</label>
                                    <div class="flex items-center gap-2 pc-time-input-group">
                                        <input type="number" inputmode="numeric" id="convert-time-m" class="p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg shadow-sm text-slate-900 dark:text-white placeholder-slate-400 transition" placeholder="MM" maxlength="3" data-next="convert-time-s">
                                        <span class="text-2xl font-bold text-slate-400">:</span>
                                        <input type="number" inputmode="numeric" id="convert-time-s" class="p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg shadow-sm text-slate-900 dark:text-white placeholder-slate-400 transition" placeholder="SS" maxlength="2">
                                    </div>
                                    <div id="convert-time-error" class="text-red-500 text-xs mt-1 h-4"></div>
                                </div>

                                <div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-2">
                                    <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">NCAA Adjustments (Optional)</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Gender</label>
                                            <select id="convert-gender" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg">
                                                <option value="men">Male</option>
                                                <option value="women">Female</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Track Type</label>
                                            <select id="convert-track-type" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg">
                                                <option value="flat">200m Flat Track</option>
                                                <option value="banked">Banked / Oversized</option>
                                                <option value="undersized">Undersized (&lt; 200m)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Venue Type Toggle -->
                                    <div class="mb-3">
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Venue Type</label>
                                        <div class="flex gap-1 p-1 bg-slate-200 dark:bg-slate-800 rounded-lg">
                                            <label class="flex-1 cursor-pointer">
                                                <input type="radio" name="convert-venue-type" value="indoor" class="peer sr-only" checked>
                                                <div class="text-center text-xs py-2 rounded-md text-slate-500 dark:text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-600 peer-checked:text-indigo-600 dark:peer-checked:text-white peer-checked:shadow-sm font-semibold transition-all">Indoor</div>
                                            </label>
                                            <label class="flex-1 cursor-pointer">
                                                <input type="radio" name="convert-venue-type" value="outdoor" class="peer sr-only">
                                                <div class="text-center text-xs py-2 rounded-md text-slate-500 dark:text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-600 peer-checked:text-indigo-600 dark:peer-checked:text-white peer-checked:shadow-sm font-semibold transition-all">Outdoor</div>
                                            </label>
                                            <label class="flex-1 cursor-pointer">
                                                <input type="radio" name="convert-venue-type" value="xc" class="peer sr-only">
                                                <div class="text-center text-xs py-2 rounded-md text-slate-500 dark:text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-600 peer-checked:text-indigo-600 dark:peer-checked:text-white peer-checked:shadow-sm font-semibold transition-all">XC</div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Venue Search -->
                                    <div class="mb-3">
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Venue (Auto-fill Altitude)</label>
                                        <input list="convert-venue-options-indoor" id="convert-venue" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg placeholder-slate-400" placeholder="Search indoor venues...">
                                        <datalist id="convert-venue-options-indoor">
                                            ${CONFIG.highAltitudeVenues.filter(v => v.type === 'indoor').map(v => `<option value="${v.name}">${v.city} (${v.elevation} ft)</option>`).join('')}
                                        </datalist>
                                        <datalist id="convert-venue-options-outdoor">
                                            ${CONFIG.highAltitudeVenues.filter(v => v.type === 'outdoor').map(v => `<option value="${v.name}">${v.city} (${v.elevation} ft)</option>`).join('')}
                                        </datalist>
                                        <datalist id="convert-venue-options-xc">
                                            ${CONFIG.highAltitudeVenues.filter(v => v.type === 'xc').map(v => `<option value="${v.name}">${v.city} (Std. to ${v.elevation} ft)</option>`).join('')}
                                        </datalist>
                                    </div>

                                    <!-- Altitude -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Altitude (ft)</label>
                                        <div class="flex gap-2">
                                            <input type="number" inputmode="numeric" id="convert-altitude" class="flex-1 p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg shadow-sm text-slate-900 dark:text-white placeholder-slate-400 transition" placeholder="e.g. 6800">
                                            <button type="button" id="convert-altitude-preset" class="px-3 py-2 bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-400 text-xs font-bold rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/60 transition whitespace-nowrap" title="Monument, CO elevation">🏔 7,200</button>
                                        </div>
                                    </div>
                                </div>

                                <button id="convert-calc-btn" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-transform hover:scale-105">
                                    <i class="ph-arrows-left-right"></i><span>Convert</span>
                                </button>
                            </div>
                        </div>
                        <div id="convert-results" class="space-y-4"></div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                            <details class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors duration-200">
                                <summary class="font-semibold text-md cursor-pointer text-slate-800 dark:text-indigo-400 flex justify-between items-center">How This Converter Works <i class="ph-caret-down transition-transform"></i></summary>
                                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-600 text-sm text-slate-600 dark:text-slate-400 space-y-2">
                                    <p>This converter uses <strong class="text-slate-700 dark:text-slate-300">four methods</strong> to analyze performances:</p>
                                    <ol class="list-decimal pl-5 space-y-2">
                                        <li><strong class="text-indigo-600 dark:text-indigo-400">VDOT (Daniels' Model)</strong> — Calculates your fitness level from the entered time, then predicts equivalent times for all distances 800m and above.</li>
                                        <li><strong class="text-amber-600 dark:text-amber-400">USTFCCA Factors</strong> — Official conversion factors for direct distance-to-distance conversions.</li>
                                        <li><strong class="text-emerald-600 dark:text-emerald-400">NCAA Track Type</strong> — Official NCAA conversion factors between flat (200m), banked/oversized, and undersized indoor tracks. Gender-specific factors per event.</li>
                                        <li><strong class="text-rose-600 dark:text-rose-400">NCAA Altitude Adjustment</strong> — Adjusts times run at altitude (≥ 3,000 ft) to sea-level equivalents. Calibrated from official NCAA facility data. Applies to events 800m and above.</li>
                                    </ol>
                                    <div class="mt-3 bg-slate-100 dark:bg-slate-700/50 p-3 rounded-lg">
                                        <p class="font-semibold text-slate-700 dark:text-slate-300">Colorado Athletes:</p>
                                        <p>Training at altitude (Monument is ~7,200 ft) significantly impacts race times. Use the altitude field to see your sea-level equivalent — critical for NCAA qualifying comparisons!</p>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                `;
                },
                renderConvertResults(distIndex, timeInSeconds, gender, trackType, altitudeFt) {
                    const resultsContainer = document.getElementById('convert-results');
                    if (!resultsContainer) return;

                    const distances = CONFIG._convertDistances;
                    const fromDist = distances[distIndex];
                    if (!fromDist || timeInSeconds <= 0) {
                        resultsContainer.innerHTML = `
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg text-center">
                                    <p class="text-slate-600 dark:text-slate-400">Please enter a valid time.</p>
                                </div>`;
                        return;
                    }

                    let topHTML = '';

                    // === VDOT Performance Equivalents (always visible hero card) ===
                    if (fromDist.meters >= 800) {
                        const vdot = Calculations.calculateVDOT(fromDist.meters, timeInSeconds);
                        const vdotDistances = distances.filter(d => d.meters >= 800 && d.label !== fromDist.label);
                        const vdotRows = vdotDistances.map(d => ({
                            label: d.label,
                            time: Calculations.calculateTimeFromVDOT(vdot, d.meters),
                            distIndex: distances.indexOf(d),
                        }));

                        topHTML = `
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg pc-fade-in">
                                    <h3 class="text-xl font-bold mb-1 text-slate-900 dark:text-white"><i class="ph-lightning mr-2"></i>Performance Equivalents</h3>
                                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">${fromDist.label}: <span class="font-bold text-indigo-500 dark:text-indigo-400">${Calculations.secToHMS(timeInSeconds)}</span> → VDOT <span class="font-bold text-indigo-500 dark:text-indigo-400">${vdot.toFixed(1)}</span></p>
                                    <p class="text-xs text-slate-400 dark:text-slate-500 mb-4">Click any distance to convert to it</p>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                                        ${vdotRows.map(r => `
                                            <div class="bg-gradient-to-br from-indigo-50 to-slate-100 dark:from-indigo-900/30 dark:to-slate-700/50 p-3 rounded-xl text-center cursor-pointer hover:ring-2 hover:ring-indigo-400 hover:shadow-md transition-all active:scale-95" data-convert-to-index="${r.distIndex}" data-convert-to-time="${r.time.toFixed(2)}">
                                                <div class="text-xs font-semibold text-indigo-600 dark:text-indigo-400">${r.label}</div>
                                                <div class="text-lg font-bold text-slate-900 dark:text-white">${Calculations.secToHMS(r.time)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>`;
                    }

                    // === Build sub-tab content ===

                    // Tab 1: Altitude Conversions
                    let altitudeContent = '';
                    let altHasData = false;
                    if (altitudeFt && altitudeFt >= 3000 && fromDist.meters >= 800) {
                        const altResult = Calculations.adjustAltitude(timeInSeconds, altitudeFt, fromDist.meters, gender);
                        if (altResult) {
                            altHasData = true;
                            altitudeContent = `
                                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${fromDist.label} at <span class="font-bold text-rose-500 dark:text-rose-400">${altitudeFt.toLocaleString()} ft</span></p>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                        <div class="bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800/40 p-4 rounded-xl text-center">
                                            <div class="text-xs font-semibold text-rose-700 dark:text-rose-400">Sea-Level Equivalent</div>
                                            <div class="text-2xl font-bold text-slate-900 dark:text-white">${Calculations.secToHMS(altResult.seaLevelTime)}</div>
                                        </div>
                                        <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl text-center">
                                            <div class="text-xs font-semibold text-slate-500 dark:text-slate-400">Time Removed</div>
                                            <div class="text-xl font-bold text-emerald-600 dark:text-emerald-400">−${altResult.adjustment.toFixed(1)}s</div>
                                        </div>
                                        <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl text-center">
                                            <div class="text-xs font-semibold text-slate-500 dark:text-slate-400">Adjustment</div>
                                            <div class="text-xl font-bold text-slate-700 dark:text-slate-300">${altResult.adjustmentPct.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">NCAA DI/III altitude model (verified 2025-26 via TFRRS).</p>`;
                        }
                    }
                    if (!altitudeContent) {
                        const reason = fromDist.meters < 800 ? 'Altitude adjustments apply to events ≥ 800m only.'
                            : (!altitudeFt || altitudeFt < 3000) ? 'Enter an altitude ≥ 3,000 ft above to see adjustments. Click 🏔 for Monument, CO.'
                                : 'No altitude data available.';
                        altitudeContent = `<div class="text-center py-6"><i class="ph-mountains text-3xl text-slate-300 dark:text-slate-600 mb-2"></i><p class="text-sm text-slate-400 dark:text-slate-500">${reason}</p></div>`;
                    }

                    // Tab 2: Flat Track Conversions
                    let flatTrackContent = '';
                    let flatHasData = false;
                    const trackTypeLabels = { flat: '200m Flat', banked: 'Banked/Oversized', undersized: 'Undersized' };
                    if (trackType && trackType !== 'flat') {
                        const otherTypes = ['flat', 'banked', 'undersized'].filter(t => t !== trackType);
                        const trackResults = otherTypes.map(toType => {
                            const result = Calculations.convertTrackType(fromDist.label, timeInSeconds, trackType, toType, gender);
                            return result ? { label: trackTypeLabels[toType], ...result } : null;
                        }).filter(Boolean);

                        if (trackResults.length > 0) {
                            flatHasData = true;
                            flatTrackContent = `
                                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${fromDist.label} on <span class="font-bold text-emerald-500 dark:text-emerald-400">${trackTypeLabels[trackType]}</span>: ${Calculations.secToHMS(timeInSeconds)} (${gender === 'men' ? 'Male' : 'Female'})</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        ${trackResults.map(r => `
                                            <div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800/40 p-4 rounded-xl text-center">
                                                <div class="text-xs font-semibold text-emerald-700 dark:text-emerald-400">${r.label}</div>
                                                <div class="text-xl font-bold text-slate-900 dark:text-white">${Calculations.secToHMS(r.convertedTime)}</div>
                                                <div class="text-xs text-slate-400 dark:text-slate-500 mt-1">× ${r.factor}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">Source: NCAA Indoor Track Type Conversion Factors</p>`;
                        }
                    }
                    if (!flatTrackContent) {
                        const reason = trackType === 'flat' ? 'Select a non-flat track type above (Banked or Undersized) to see flat-track equivalents.'
                            : 'No track type conversion factors available for this event.';
                        flatTrackContent = `<div class="text-center py-6"><i class="ph-buildings text-3xl text-slate-300 dark:text-slate-600 mb-2"></i><p class="text-sm text-slate-400 dark:text-slate-500">${reason}</p></div>`;
                    }

                    // Tab 3: USTFCCA Conversions
                    let ustfccaContent = '';
                    let ustfccaHasData = false;
                    const ustfccaConversions = Calculations.applyUSTFCCA(fromDist.label, timeInSeconds);
                    if (ustfccaConversions.length > 0) {
                        ustfccaHasData = true;
                        ustfccaContent = `
                                <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">From ${fromDist.label}: <span class="font-bold text-amber-500 dark:text-amber-400">${Calculations.secToHMS(timeInSeconds)}</span></p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${ustfccaConversions.map(c => `
                                        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/40 p-4 rounded-xl text-center">
                                            <div class="text-xs font-semibold text-amber-700 dark:text-amber-400">${c.event}</div>
                                            <div class="text-xl font-bold text-slate-900 dark:text-white">${Calculations.secToHMS(c.equivalentTimeSec)}</div>
                                            <div class="text-xs text-slate-400 dark:text-slate-500 mt-1">× ${c.factor}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <p class="text-xs text-slate-400 dark:text-slate-500 mt-3">Source: USTFCCA Standardized Conversion Factors (Rev. 01/10/12)</p>`;
                    } else {
                        ustfccaContent = `<div class="text-center py-6"><i class="ph-seal-check text-3xl text-slate-300 dark:text-slate-600 mb-2"></i><p class="text-sm text-slate-400 dark:text-slate-500">No USTFCCA conversion factors available for ${fromDist.label}.</p></div>`;
                    }

                    // === Count badges (show data availability at a glance) ===
                    const altBadge = altHasData ? '<span class="ml-1.5 w-2 h-2 rounded-full bg-rose-500 inline-block"></span>' : '';
                    const flatBadge = flatHasData ? '<span class="ml-1.5 w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>' : '';
                    const ustfccaBadge = ustfccaHasData ? '<span class="ml-1.5 w-2 h-2 rounded-full bg-amber-500 inline-block"></span>' : '';

                    // === Determine which sub-tab to auto-select ===
                    // If altitude has no data but USTFCCA does, auto-select USTFCCA (e.g. 300m, 600m)
                    const defaultTab = (!altHasData && ustfccaHasData && !flatHasData) ? 'ustfcca'
                        : (!altHasData && flatHasData) ? 'flattrack'
                            : 'altitude';
                    const tabColors = { altitude: 'rose', flattrack: 'emerald', ustfcca: 'amber' };

                    function subTabClasses(tab) {
                        const color = tabColors[tab];
                        if (tab === defaultTab) {
                            return `border-${color}-500 text-${color}-600 dark:text-${color}-400 bg-${color}-50/50 dark:bg-${color}-900/10`;
                        }
                        return `border-transparent text-slate-500 dark:text-slate-400 hover:text-${color}-600 dark:hover:text-${color}-400`;
                    }

                    // === Assemble the sub-tabbed card ===
                    const subTabsCard = `
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg pc-fade-in overflow-hidden">
                                <div class="flex border-b border-slate-200 dark:border-slate-700" id="convert-sub-tabs">
                                    <button class="convert-sub-tab flex-1 px-3 py-3 text-sm font-semibold transition-all duration-200 border-b-2 ${subTabClasses('altitude')}" data-tab="altitude">
                                        <i class="ph-mountains mr-1"></i>Altitude${altBadge}
                                    </button>
                                    <button class="convert-sub-tab flex-1 px-3 py-3 text-sm font-semibold transition-all duration-200 border-b-2 ${subTabClasses('flattrack')}" data-tab="flattrack">
                                        <i class="ph-buildings mr-1"></i>Flat Track${flatBadge}
                                    </button>
                                    <button class="convert-sub-tab flex-1 px-3 py-3 text-sm font-semibold transition-all duration-200 border-b-2 ${subTabClasses('ustfcca')}" data-tab="ustfcca">
                                        <i class="ph-seal-check mr-1"></i>USTFCCA${ustfccaBadge}
                                    </button>
                                </div>
                                <div class="p-6">
                                    <div id="convert-sub-panel-altitude" class="convert-sub-panel" style="${defaultTab === 'altitude' ? 'animation: pcFadeIn 0.25s ease' : 'display:none'}">${altitudeContent}</div>
                                    <div id="convert-sub-panel-flattrack" class="convert-sub-panel" style="${defaultTab === 'flattrack' ? 'animation: pcFadeIn 0.25s ease' : 'display:none'}">${flatTrackContent}</div>
                                    <div id="convert-sub-panel-ustfcca" class="convert-sub-panel" style="${defaultTab === 'ustfcca' ? 'animation: pcFadeIn 0.25s ease' : 'display:none'}">${ustfccaContent}</div>
                                </div>
                            </div>`;

                    resultsContainer.innerHTML = topHTML + subTabsCard;
                },
                renderHistoryTab() {
                    const historyContainer = DOMElements.tabs.history.content;
                    historyContainer.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                           <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Progress History</h2>
                           <div class="flex gap-2">
                                <button id="importHistoryBtn" aria-label="Import history from a file" class="flex items-center gap-2 text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="ph-upload"></i><span>Import</span></button>
                                <button id="exportHistoryBtn" aria-label="Export history to a file" class="flex items-center gap-2 text-sm bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition"><i class="ph-download"></i><span>Export</span></button>
                                <button id="clearHistoryBtn" aria-label="Clear all history" class="flex items-center gap-2 text-sm bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition"><i class="ph-trash"></i><span>Clear</span></button>
                           </div>
                        </div>
                        <div class="flex flex-wrap justify-end items-center mb-4 gap-4">
                            <label for="history-sort-by" class="sr-only">Sort by</label>
                            <select id="history-sort-by" class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0">
                                <option value="date" ${state.settings.historySort.by === 'date' ? 'selected' : ''}>Date</option>
                                <option value="vdot" ${state.settings.historySort.by === 'vdot' ? 'selected' : ''}>VDOT</option>
                                <option value="mode" ${state.settings.historySort.by === 'mode' ? 'selected' : ''}>Mode</option>
                            </select>
                            <label for="history-sort-order" class="sr-only">Sort order</label>
                            <select id="history-sort-order" class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0">
                                <option value="desc" ${state.settings.historySort.order === 'desc' ? 'selected' : ''}>Descending</option>
                                <option value="asc" ${state.settings.historySort.order === 'asc' ? 'selected' : ''}>Ascending</option>
                            </select>
                        </div>
                        <div id="history-content-container" class="space-y-8"></div>
                    </div>`;

                    const historyContent = document.getElementById('history-content-container');
                    if (state.history.length === 0) {
                        historyContent.innerHTML = `<div class="text-center py-10"><i class="ph-timer text-6xl text-slate-400 dark:text-slate-500"></i><h3 class="text-xl font-bold mt-4 text-slate-800 dark:text-slate-200">No History Yet</h3><p class="text-slate-500 dark:text-slate-400 mt-1">Calculate a pace and click "Save Pace" to start tracking your progress.</p></div>`;
                        return;
                    }

                    const insights = AppLogic.analyzeHistory();
                    historyContent.innerHTML = `
                    ${this.renderHistoryInsights(insights)}
                    <div id="progressChartContainer" class="mb-8"><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">VDOT Progress</h3><div id="vdotChartWrapper" class="relative"><div id="vdotChart"></div><div id="chartTooltip" class="pc-chart-tooltip absolute bg-slate-800 dark:bg-slate-900 text-white text-xs rounded py-1 px-2 opacity-0"></div></div></div>
                    <div id="historyListContainer"><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Saved Paces</h3><ul id="historyList" class="space-y-3"></ul></div>
                `;

                    this.renderHistoryList();
                    this.renderProgressChart();
                },
                renderHistoryInsights(insights) {
                    if (!insights) return '';

                    const getTrendColor = (change) => change > 0 ? 'text-green-500' : 'text-red-500';
                    const getTrendIcon = (change) => change > 0 ? 'ph-arrow-up' : 'ph-arrow-down';
                    const formatVdotChange = (change) => {
                        const sign = change > 0 ? '+' : '';
                        return `${sign}${change.toFixed(1)}`;
                    };

                    return `
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Progress Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${insights.overallVdotChange !== null ? `
                            <div class="bg-slate-100 dark:bg-slate-700/50 p-4 rounded-xl flex items-center gap-4">
                                <i class="ph-rocket-launch text-3xl ${getTrendColor(insights.overallVdotChange)}"></i>
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Overall Progress</p>
                                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${formatVdotChange(insights.overallVdotChange)} VDOT</p>
                                </div>
                            </div>` : ''}
                            ${insights.recentVdotChange !== null ? `
                            <div class="bg-slate-100 dark:bg-slate-700/50 p-4 rounded-xl flex items-center gap-4">
                                <i class="${getTrendIcon(insights.recentVdotChange)} text-3xl ${getTrendColor(insights.recentVdotChange)}"></i>
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Recent Trend</p>
                                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${formatVdotChange(insights.recentVdotChange)} VDOT</p>
                                </div>
                            </div>` : ''}
                            ${insights.bestVdotEntry ? `
                            <div class="bg-slate-100 dark:bg-slate-700/50 p-4 rounded-xl flex items-center gap-4">
                                <i class="ph-trophy text-3xl text-yellow-500"></i>
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Personal Best</p>
                                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${insights.bestVdotEntry.vdot} VDOT</p>
                                </div>
                            </div>` : ''}
                            ${insights.monthlyChange !== null ? `
                            <div class="bg-slate-100 dark:bg-slate-700/50 p-4 rounded-xl flex items-center gap-4">
                                <i class="ph-calendar-check text-3xl ${getTrendColor(insights.monthlyChange)}"></i>
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Last 30 Days</p>
                                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${formatVdotChange(insights.monthlyChange)} VDOT</p>
                                </div>
                            </div>` : ''}
                             ${insights.mostCommonBasis ? `
                            <div class="bg-slate-100 dark:bg-slate-700/50 p-4 rounded-xl flex items-center gap-4">
                                <i class="ph-repeat text-3xl text-blue-500"></i>
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">Your Go-To</p>
                                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${CONFIG.inputLabels[insights.mostCommonBasis]}</p>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
                },
                renderHistoryList() {
                    const listEl = document.getElementById('historyList');
                    if (!listEl) return;

                    const sortedHistory = AppLogic.sortHistory();

                    listEl.innerHTML = sortedHistory.map(item => {
                        const date = new Date(item.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        const modeLabel = CONFIG.inputLabels[item.mode].split(' (')[0];
                        return `<li class="flex items-center justify-between p-4 bg-slate-100 dark:bg-slate-700/50 rounded-lg shadow-sm">
                        <div>
                            <p class="font-bold text-slate-800 dark:text-slate-200">${date}</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">${modeLabel}: ${item.timeStr} → <span class="font-semibold text-indigo-500 dark:text-indigo-400">VDOT ${item.vdot}</span></p>
                        </div>
                        <button data-id="${item.id}" aria-label="Delete history entry from ${date}" class="delete-history-btn text-slate-400 hover:text-red-500 dark:hover:text-red-400 p-2 rounded-full transition"><i class="ph-x text-xl"></i></button>
                    </li>`;
                    }).join('');
                },
                renderProgressChart() {
                    clearTimeout(state.debounceTimer);
                    state.debounceTimer = setTimeout(() => {
                        const chartContainer = document.getElementById('vdotChart');
                        const tooltipEl = document.getElementById('chartTooltip');
                        if (!chartContainer || !tooltipEl || chartContainer.clientWidth === 0) return;
                        if (state.history.length < 2) {
                            chartContainer.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400">Need at least two saved points to show a progress chart.</p>';
                            return;
                        }
                        const historyData = [...state.history].sort((a, b) => new Date(a.date) - new Date(b.date));

                        const colors = {
                            bg: 'transparent', grid: state.isDark ? '#334155' : '#e2e8f0',
                            text: state.isDark ? '#94a3b8' : '#64748b', line: '#4f46e5',
                            dot: state.isDark ? '#a5b4fc' : '#4f46e5', dotBorder: state.isDark ? '#1e293b' : '#ffffff'
                        };
                        const width = chartContainer.clientWidth;
                        const height = 300;
                        const padding = { top: 20, right: 20, bottom: 50, left: 40 };
                        const vdots = historyData.map(d => d.vdot);
                        const dates = historyData.map(d => new Date(d.date));
                        const minVdot = Math.floor(Math.min(...vdots) - 2);
                        const maxVdot = Math.ceil(Math.max(...vdots) + 2);
                        const [minDate, maxDate] = [dates[0], dates[dates.length - 1]];

                        const xScale = (date) => padding.left + (date - minDate) / (maxDate - minDate || 1) * (width - padding.left - padding.right);
                        const yScale = (vdot) => height - padding.bottom - (vdot - minVdot) / (maxVdot - minVdot || 1) * (height - padding.top - padding.bottom);

                        let yAxisLabels = [];
                        for (let i = minVdot; i <= maxVdot; i++) { if (i % 2 === 0) yAxisLabels.push(i); }
                        const xAxisLabels = historyData.map(d => ({ x: xScale(new Date(d.date)), label: new Date(d.date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' }) }));
                        const points = historyData.map(d => `${xScale(new Date(d.date))},${yScale(d.vdot)}`).join(' ');

                        const circlesHTML = historyData.map((d, i) =>
                            `<circle data-index="${i}" cx="${xScale(new Date(d.date))}" cy="${yScale(d.vdot)}" r="5" fill="${colors.dot}" stroke="${colors.dotBorder}" stroke-width="2" class="cursor-pointer chart-dot" aria-label="VDOT of ${d.vdot} on ${new Date(d.date).toLocaleDateString()}"/>`
                        ).join('');

                        chartContainer.innerHTML = `<svg width="${width}" height="${height}" style="font-family: Inter, sans-serif; font-size: 12px;"><rect width="100%" height="100%" fill="${colors.bg}" />${yAxisLabels.map(l => `<line x1="${padding.left}" y1="${yScale(l)}" x2="${width - padding.right}" y2="${yScale(l)}" stroke="${colors.grid}" stroke-dasharray="2,2"/>`).join('')}${yAxisLabels.map(l => `<text x="${padding.left - 8}" y="${yScale(l) + 4}" fill="${colors.text}" text-anchor="end">${l}</text>`).join('')}${xAxisLabels.map(item => `<text x="${item.x}" y="${height - padding.bottom + 20}" fill="${colors.text}" text-anchor="middle">${item.label}</text>`).join('')}<polyline fill="none" stroke="${colors.line}" stroke-width="2" points="${points}" />${circlesHTML}</svg>`;
                    }, 100);
                },
                renderInfo() {
                    DOMElements.infoContainer.innerHTML = '';
                    INFO_CONTENT.forEach(item => {
                        if (item.type === 'header') {
                            const header = document.createElement('h4');
                            header.className = "text-lg font-semibold border-b border-slate-200 dark:border-slate-700 pb-2 mt-4 text-slate-900 dark:text-white";
                            header.textContent = item.title;
                            DOMElements.infoContainer.appendChild(header);
                        } else if (item.type === 'details') {
                            const details = document.createElement('details');
                            details.className = "p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors duration-200";
                            details.innerHTML = `<summary class="font-semibold text-md cursor-pointer text-slate-800 dark:text-indigo-400 flex justify-between items-center">${item.title}<i class="ph-caret-down transition-transform"></i></summary><div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-600">${item.content}</div>`;
                            details.addEventListener('toggle', (e) => { e.target.querySelector('i').style.transform = e.target.open ? 'rotate(180deg)' : 'rotate(0deg)'; });
                            DOMElements.infoContainer.appendChild(details);
                        }
                    });
                },
                renderCalculatorStep(direction) {
                    const form = DOMElements.mainCalcForm;
                    const currentStepEl = form.querySelector('.wizard-step');
                    const slideClass = direction === 'back' ? 'pc-slide-left' : (direction === 'forward' ? 'pc-slide-right' : 'pc-fade-in');

                    const renderNewStep = () => {
                        let newStepHTML = '';
                        switch (state.currentStep) {
                            case 1:
                                newStepHTML = this._getBasisStepHTML();
                                break;
                            case 2:
                                newStepHTML = this._getTimeStepHTML();
                                break;
                        }
                        form.innerHTML = newStepHTML;
                        const newStepEl = form.querySelector('.wizard-step');
                        newStepEl.classList.add(slideClass);

                        if (state.currentStep === 2) {
                            setTimeout(() => document.getElementById('timeInput-m')?.focus(), 0);
                            this.renderActionButtons('action-buttons');
                            this._initLiveVDOTPreview();
                            this._initTemperatureSlider();
                            this._initSmartTimeInput();
                        }
                    };

                    if (currentStepEl) {
                        currentStepEl.classList.add('pc-fade-out');
                        currentStepEl.addEventListener('animationend', renderNewStep, { once: true });
                    } else {
                        renderNewStep();
                    }
                },
                _initLiveVDOTPreview() {
                    const mInput = document.getElementById('timeInput-m');
                    const sInput = document.getElementById('timeInput-s');
                    const badge = document.getElementById('live-vdot-badge');
                    const valueEl = document.getElementById('live-vdot-value');
                    if (!mInput || !sInput || !badge || !valueEl) return;

                    const update = () => {
                        const m = parseInt(mInput.value) || 0;
                        const s = parseInt(sInput.value) || 0;
                        const totalSec = m * 60 + s;
                        if (totalSec <= 0) {
                            badge.classList.remove('active');
                            return;
                        }
                        const mode = state.selectedBasis;
                        let distMeters = CONFIG.distMap[mode] || CONFIG.distMap.fiveK;
                        if (mode === 'custom') {
                            const customDist = parseFloat(document.getElementById('custom-distance')?.value) || 0;
                            const customUnit = document.getElementById('custom-distance-unit')?.value || 'miles';
                            distMeters = customUnit === 'miles' ? customDist * 1609.344 : customDist * 1000;
                        }
                        if (mode === 'pace') {
                            const paceKey = document.getElementById('paceDistance')?.value || 'fiveK';
                            distMeters = CONFIG.distMap[paceKey] || 5000;
                        }
                        if (distMeters <= 0) return;
                        // Apply course factor for live VDOT preview
                        let adjustedSec = totalSec;
                        if (CONFIG.courseFactors[mode]) {
                            adjustedSec = totalSec * CONFIG.courseFactors[mode];
                        }
                        const vdot = Calculations.calculateVDOT(distMeters, adjustedSec);
                        if (vdot > 0 && vdot < 100) {
                            const newVal = vdot.toFixed(1);
                            if (valueEl.textContent !== newVal) {
                                valueEl.textContent = newVal;
                                // (pulse removed for cleaner UX)
                            }
                            badge.classList.add('active');
                        } else {
                            badge.classList.remove('active');
                        }
                    };
                    mInput.addEventListener('input', update);
                    sInput.addEventListener('input', update);
                    // Trigger on load if values are pre-filled
                    update();
                },
                _initSmartTimeInput() {
                    const mInput = document.getElementById('timeInput-m');
                    const sInput = document.getElementById('timeInput-s');
                    if (!mInput || !sInput) return;

                    mInput.addEventListener('input', () => {
                        // Auto-advance when 2+ digits entered in minutes
                        if (mInput.value.length >= 2) {
                            sInput.focus();
                            sInput.select();
                        }
                    });
                },
                _initTapToCopy() {
                    DOMElements.resultsColumn.addEventListener('click', (e) => {
                        const card = e.target.closest('.pc-mobile-pace-card');
                        if (!card) return;

                        // Find the pace text
                        const paceEl = card.querySelector('.text-2xl, .text-xl');
                        if (!paceEl) return;

                        const paceText = paceEl.textContent.trim();
                        if (!paceText || paceText === '—') return;

                        // Get zone name
                        const nameEl = card.querySelector('h4, .font-bold');
                        const name = nameEl ? nameEl.textContent.trim() : '';

                        const copyStr = name ? `${name}: ${paceText}` : paceText;

                        navigator.clipboard.writeText(copyStr).then(() => {
                            // Visual feedback — flash
                            card.classList.remove('pc-copy-flash');
                            void card.offsetWidth;
                            card.classList.add('pc-copy-flash');

                            // Tiny toast
                            const toast = document.createElement('div');
                            toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-900 text-sm font-semibold rounded-full shadow-lg z-50 transition-opacity';
                            toast.textContent = `📋 Copied: ${copyStr}`;
                            document.body.appendChild(toast);
                            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 1500);
                        }).catch(() => { });
                    });
                },
                _initTemperatureSlider() {
                    const slider = document.getElementById('calc-temperature');
                    const label = document.getElementById('calc-temp-value');
                    if (!slider || !label) return;

                    slider.addEventListener('input', () => {
                        const temp = parseInt(slider.value);
                        let desc = '', color = 'text-emerald-500';
                        if (temp <= 49) { desc = 'Cold'; color = 'text-blue-500'; }
                        else if (temp <= 59) { desc = 'Cool'; color = 'text-cyan-500'; }
                        else if (temp <= 69) { desc = 'Ideal'; color = 'text-emerald-500'; }
                        else if (temp <= 79) { desc = 'Warm'; color = 'text-amber-500'; }
                        else if (temp <= 89) { desc = 'Hot'; color = 'text-orange-500'; }
                        else { desc = 'Dangerous'; color = 'text-red-600'; }

                        // Performance impact (research-based: ~1-3% per 10°F above 60)
                        const degreesAboveIdeal = Math.max(0, temp - 60);
                        const impactPct = (degreesAboveIdeal * 0.15).toFixed(1);
                        const impactStr = degreesAboveIdeal > 0 ? ` (+${impactPct}%)` : '';

                        label.innerHTML = `${temp}°F <span class="${color} font-normal">${desc}${impactStr}</span>`;
                    });
                },
                triggerConfetti() {
                    const container = document.createElement('div');
                    container.className = 'pc-confetti-container';
                    const colors = ['#6366f1', '#818cf8', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
                    for (let i = 0; i < 40; i++) {
                        const piece = document.createElement('div');
                        piece.className = 'pc-confetti-piece';
                        piece.style.left = Math.random() * 100 + '%';
                        piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        piece.style.animationDelay = Math.random() * 0.8 + 's';
                        piece.style.animationDuration = (1.5 + Math.random() * 1.5) + 's';
                        piece.style.width = (5 + Math.random() * 6) + 'px';
                        piece.style.height = (5 + Math.random() * 6) + 'px';
                        container.appendChild(piece);
                    }
                    document.body.appendChild(container);
                    setTimeout(() => container.remove(), 3500);
                },
                _buildNudgeHTML(vdot, mode) {
                    // Common milestone VDOT targets
                    const milestones = [
                        { vdot: 30, label: 'Sub-25 5K' },
                        { vdot: 35, label: 'Sub-22 5K' },
                        { vdot: 40, label: 'Sub-20 5K' },
                        { vdot: 45, label: 'Sub-18 5K' },
                        { vdot: 50, label: 'Sub-17 5K' },
                        { vdot: 55, label: 'Sub-16 5K' },
                        { vdot: 60, label: 'Sub-15 5K' },
                        { vdot: 65, label: 'Elite 5K' },
                    ];
                    // Find the next milestone above current VDOT
                    const next = milestones.find(m => m.vdot > vdot && m.vdot - vdot <= 5);
                    if (!next) return '';

                    const gap = (next.vdot - vdot).toFixed(1);
                    const targetTime = Calculations.secToHMS(Calculations.calculateTimeFromVDOT(next.vdot, CONFIG.distMap.fiveK));
                    return `
                        <div class="pc-nudge-card mt-4">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">🎯</span>
                                <div>
                                    <p class="font-bold text-amber-900 dark:text-amber-200 text-sm">You're ${gap} VDOT points from ${next.label}!</p>
                                    <p class="text-xs text-amber-800 dark:text-amber-300 mt-1">Target 5K: <span class="font-bold">${targetTime}</span> — Keep training consistently and you'll get there.</p>
                                </div>
                            </div>
                        </div>`;
                },
                async shareAsImage() {
                    if (!state.latestCalculation) return;
                    const { vdot } = state.latestCalculation;
                    const anchor5k = Calculations.secToHMS(Calculations.calculateTimeFromVDOT(vdot, CONFIG.distMap.fiveK));

                    // Create a styled div for the share card
                    const card = document.createElement('div');
                    card.style.cssText = 'position:fixed;left:-9999px;width:600px;height:400px;padding:40px;background:linear-gradient(135deg,#312e81,#4f46e5,#7c3aed);border-radius:24px;color:white;font-family:Inter,sans-serif;display:flex;flex-direction:column;justify-content:space-between;';
                    card.innerHTML = `
                            <div>
                                <div style="font-size:14px;font-weight:600;letter-spacing:2px;text-transform:uppercase;opacity:0.7">Bears Track Club</div>
                                <div style="font-size:72px;font-weight:800;margin-top:8px">${vdot.toFixed(1)}</div>
                                <div style="font-size:18px;font-weight:600;opacity:0.8;margin-top:4px">VDOT Score</div>
                            </div>
                            <div style="display:flex;gap:32px;align-items:flex-end">
                                <div>
                                    <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;opacity:0.6">Equivalent 5K</div>
                                    <div style="font-size:28px;font-weight:700;margin-top:4px">${anchor5k}</div>
                                </div>
                                <div style="flex:1;text-align:right;font-size:11px;opacity:0.5">bearstc.com/pace</div>
                            </div>
                        `;
                    document.body.appendChild(card);

                    try {
                        if (typeof html2canvas !== 'undefined') {
                            const canvas = await html2canvas(card, { scale: 2, backgroundColor: null });
                            card.remove();
                            canvas.toBlob(async (blob) => {
                                if (navigator.share && navigator.canShare) {
                                    const file = new File([blob], 'pace-card.png', { type: 'image/png' });
                                    try {
                                        await navigator.share({ files: [file], title: `VDOT ${vdot.toFixed(1)} - Bears TC` });
                                    } catch { /* user cancelled */ }
                                } else {
                                    // Fallback: download
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url; a.download = `bears-tc-vdot-${vdot.toFixed(1)}.png`;
                                    a.click(); URL.revokeObjectURL(url);
                                }
                            }, 'image/png');
                        } else {
                            card.remove();
                            alert('Image generation library not loaded. Please try again.');
                        }
                    } catch (e) { card.remove(); console.error(e); }
                },
                renderVDOTChart() {
                    const history = JSON.parse(localStorage.getItem('paceCalcHistory') || '[]');
                    if (history.length < 2) return ''; // Need at least 2 points

                    const recentHistory = history
                        .filter(h => h.vdot && h.timestamp)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .slice(-10); // Last 10 calculations

                    if (recentHistory.length < 2) return '';

                    const vdots = recentHistory.map(h => h.vdot);
                    const minV = Math.floor(Math.min(...vdots)) - 1;
                    const maxV = Math.ceil(Math.max(...vdots)) + 1;
                    const range = maxV - minV || 1;

                    const w = 320, h = 120, pad = 30;
                    const chartW = w - pad * 2, chartH = h - pad * 2;
                    const stepX = chartW / (recentHistory.length - 1);

                    const points = recentHistory.map((entry, i) => {
                        const x = pad + i * stepX;
                        const y = pad + chartH - ((entry.vdot - minV) / range) * chartH;
                        return { x, y, vdot: entry.vdot };
                    });

                    // Build SVG path
                    const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
                    const fillD = pathD + ` L${points[points.length - 1].x},${h - pad} L${pad},${h - pad} Z`;

                    const dots = points.map(p =>
                        `<circle cx="${p.x}" cy="${p.y}" r="3" fill="#6366f1" stroke="white" stroke-width="1.5"/>`
                    ).join('');

                    const latestDot = points[points.length - 1];
                    const trend = vdots[vdots.length - 1] >= vdots[0] ? '📈' : '📉';

                    return `
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg pc-fade-in mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200">${trend} VDOT Trend</h4>
                                <span class="text-xs text-slate-400">${recentHistory.length} calculations</span>
                            </div>
                            <svg viewBox="0 0 ${w} ${h}" class="w-full" style="max-height:120px">
                                <defs>
                                    <linearGradient id="vdot-fill" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="0%" stop-color="#6366f1" stop-opacity="0.3"/>
                                        <stop offset="100%" stop-color="#6366f1" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                                <path d="${fillD}" fill="url(#vdot-fill)"/>
                                <path d="${pathD}" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                ${dots}
                                <text x="${latestDot.x}" y="${latestDot.y - 8}" text-anchor="middle" fill="#6366f1" font-size="10" font-weight="700">${latestDot.vdot.toFixed(1)}</text>
                                <text x="${pad}" y="${h - 5}" fill="#94a3b8" font-size="8">${minV}</text>
                                <text x="${w - pad}" y="${h - 5}" fill="#94a3b8" font-size="8" text-anchor="end">${maxV}</text>
                            </svg>
                        </div>`;
                },
                _getBasisStepHTML() {
                    const basisOptions = [
                        { value: 'fiveK', label: '5K Time', sub: 'Standard', icon: '🏃' },
                        { value: 'oneSix', label: '1600m', sub: 'Track', icon: '⏱' },
                        { value: 'threeTwo', label: '3200m', sub: 'Track', icon: '🏟' },
                        { value: 'pace', label: 'Pace', sub: 'Per Mile', icon: '⚡' },
                        { value: 'custom', label: 'Custom', sub: 'Distance', icon: '📐' },
                        { value: '_divider', label: 'Bears TC Races', divider: true },
                        { value: 'bear', label: 'Bear Time', sub: '1.17 miles', icon: '🐻' },
                        { value: 'palmerLake', label: 'Palmer Lake', sub: '4 Miler', icon: '🏔' },
                        { value: '_divider2', label: 'XC Courses', divider: true },
                        { value: 'mvp', label: 'MVP', sub: '5K · 6,109 ft', icon: '🌲' },
                        { value: 'stateXC', label: 'State XC', sub: 'Norris Penrose', icon: '🏆' }
                    ];

                    return `
                    <div class="wizard-step" data-step="1">
                        <div class="text-center mb-3 sm:mb-8">
                             <h3 class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white">Choose Your Performance</h3>
                             <p class="text-xs sm:text-base text-slate-500 dark:text-slate-400 mt-1 sm:mt-2">Select a race or pace to calculate training zones.</p>
                             <div class="flex flex-wrap justify-center gap-1.5 sm:gap-2 mt-2 sm:mt-3">
                                 <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 dark:bg-indigo-900/20 text-[0.6rem] sm:text-xs font-semibold text-indigo-600 dark:text-indigo-400">🏟 NCAA Altitude Calc</span>
                                 <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 dark:bg-emerald-900/20 text-[0.6rem] sm:text-xs font-semibold text-emerald-600 dark:text-emerald-400">🔄 Flat Track Conversions</span>
                                 <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-50 dark:bg-amber-900/20 text-[0.6rem] sm:text-xs font-semibold text-amber-600 dark:text-amber-400">📊 USTFCCCA Alt. Events</span>
                             </div>
                        </div>
                        <fieldset>
                            <legend class="sr-only">Performance Basis</legend>
                            <div class="pc-basis-grid grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4">
                                ${basisOptions.map(opt => {
                        if (opt.divider) return `
                                    <div class="col-span-2 sm:col-span-3 flex items-center gap-2 mt-1 mb--1">
                                        <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                                        <span class="text-[0.6rem] sm:text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider">${opt.label}</span>
                                        <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                                    </div>`;
                        return `
                                <div class="relative group">
                                    <input type="radio" name="mode" value="${opt.value}" id="mode-${opt.value}" class="peer sr-only" ${state.selectedBasis === opt.value ? 'checked' : ''}>
                                    <label for="mode-${opt.value}" class="pc-basis-card flex flex-col items-center justify-center p-2.5 sm:p-6 h-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl sm:rounded-2xl cursor-pointer transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5 hover:border-indigo-400 peer-checked:border-indigo-600 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900/20 peer-checked:shadow-indigo-500/20">
                                        <span class="text-xl sm:text-4xl mb-1 sm:mb-3">${opt.icon}</span>
                                        <span class="pc-card-label font-bold text-xs sm:text-lg text-slate-700 dark:text-slate-200">${opt.label}</span>
                                        ${opt.sub ? `<span class="pc-card-sub text-[0.55rem] sm:text-xs font-semibold text-slate-400 dark:text-slate-500 uppercase tracking-wider mt-0.5 sm:mt-1">${opt.sub}</span>` : ''}
                                    </label>
                                </div>
                                `;
                    }).join('')}
                            </div>
                        </fieldset>
                        <button id="next-step-btn" class="mt-3 sm:mt-8 w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold text-sm sm:text-lg py-2.5 sm:py-4 px-4 sm:px-8 rounded-xl shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 hover:shadow-indigo-600/40 focus:outline-none focus:ring-4 focus:ring-indigo-500/20 transition-all transform hover:scale-[1.02]">
                            <span>Continue</span>
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                `;
                },
                _getTimeStepHTML() {
                    const mode = state.selectedBasis;
                    const commonInputClasses = "p-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg shadow-sm text-slate-900 dark:text-white placeholder-slate-400 transition";

                    const lastInputs = JSON.parse(localStorage.getItem('lastInputs') || '{}');
                    const [m = '', s = ''] = (lastInputs.mode === mode && lastInputs.timeStr) ? lastInputs.timeStr.split(':') : [];

                    const timeFormatSelectorHTML = `
                    <div class="mb-4">
                        <label for="timeFormat" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Time Format</label>
                        <select id="timeFormat" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg">
                            <option value="mm:ss">MM:SS</option>
                            <option value="hh:mm:ss">HH:MM:SS</option>
                        </select>
                    </div>
                `;

                    const customDistanceHTML = mode === 'custom' ? `
                    <div class="mt-4">
                        <label for="custom-distance" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Distance</label>
                        <div class="flex gap-2">
                            <input type="number" id="custom-distance" min="0.1" max="1000" step="0.1" placeholder="e.g., 3.1" class="w-full ${commonInputClasses}">
                            <select id="custom-distance-unit" class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg p-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0">
                                <option value="miles">mi</option>
                                <option value="km">km</option>
                            </select>
                        </div>
                        <div id="custom-distance-error" class="text-red-500 text-xs mt-1 h-4"></div>
                    </div>
                ` : '';


                    const fieldsHTML = `
                    <input type="number" inputmode="numeric" id="timeInput-m" class="${commonInputClasses}" placeholder="${CONFIG.inputPlaceholders.m}" maxlength="3" data-next="timeInput-s" value="${m}">
                    <span class="text-2xl font-bold text-slate-400">:</span>
                    <input type="number" inputmode="numeric" id="timeInput-s" class="${commonInputClasses}" placeholder="${CONFIG.inputPlaceholders.s}" maxlength="2" value="${s}">
                `;

                    return `
                    <div class="wizard-step" data-step="2">
                        <div class="text-center mb-5 sm:mb-8">
                            <h3 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white tracking-tight">Enter ${CONFIG.inputLabels[mode]}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">We'll generate your personalized training zones.</p>
                        </div>

                        <!-- Time Format -->
                        <div class="mb-4">
                            <select id="timeFormat" class="w-full p-2.5 text-sm bg-slate-50 dark:bg-slate-700/50 text-slate-700 dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl focus:border-indigo-500 focus:ring-0 transition">
                                <option value="mm:ss">MM:SS</option>
                                <option value="hh:mm:ss">HH:MM:SS</option>
                            </select>
                        </div>

                        <!-- Time Input -->
                        <div class="pc-time-entry-card bg-gradient-to-br from-slate-50 to-white dark:from-slate-700/60 dark:to-slate-800/80 border border-slate-200/80 dark:border-slate-600/50 rounded-2xl p-5 sm:p-6 mb-4">
                            <label for="timeInput-m" class="block text-[0.65rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 text-center">Your Time</label>
                            <div class="flex items-center justify-center gap-3">
                                <div class="relative">
                                    <input type="number" inputmode="numeric" id="timeInput-m" class="w-20 sm:w-24 h-16 sm:h-20 text-center text-3xl sm:text-4xl font-bold bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 focus:border-indigo-500 focus:ring-0 rounded-xl shadow-sm text-slate-900 dark:text-white placeholder-slate-300 dark:placeholder-slate-600 transition" placeholder="${CONFIG.inputPlaceholders.m}" maxlength="3" data-next="timeInput-s" value="${m}">
                                    <span class="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[0.55rem] font-semibold text-slate-400 dark:text-slate-500 uppercase">min</span>
                                </div>
                                <span class="text-3xl sm:text-4xl font-bold text-slate-300 dark:text-slate-600 -mt-4">:</span>
                                <div class="relative">
                                    <input type="number" inputmode="numeric" id="timeInput-s" class="w-20 sm:w-24 h-16 sm:h-20 text-center text-3xl sm:text-4xl font-bold bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 focus:border-indigo-500 focus:ring-0 rounded-xl shadow-sm text-slate-900 dark:text-white placeholder-slate-300 dark:placeholder-slate-600 transition" placeholder="${CONFIG.inputPlaceholders.s}" maxlength="2" value="${s}">
                                    <span class="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[0.55rem] font-semibold text-slate-400 dark:text-slate-500 uppercase">sec</span>
                                </div>
                            </div>
                            <div class="flex justify-center mt-5">
                                <div id="live-vdot-badge" class="pc-vdot-preview">
                                    <span class="vdot-label">VDOT</span>
                                    <span id="live-vdot-value">--</span>
                                </div>
                            </div>
                            <div id="time-input-error" class="text-red-500 text-xs mt-2 text-center h-4"></div>
                        </div>

                        <!-- Quick Example Benchmarks -->
                        <div class="mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Try an example</span>
                                <div class="flex-1 h-px bg-slate-200 dark:bg-slate-700"></div>
                            </div>
                            <div class="flex flex-wrap gap-1.5">
                                <button type="button" id="example-link" class="pc-example-chip px-3 py-1.5 text-xs font-semibold bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 border border-indigo-200 dark:border-indigo-800/40 rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-all active:scale-95">
                                    ⚡ Quick Fill
                                </button>
                                <button type="button" data-example-m="19" data-example-s="45" class="pc-example-chip pc-example-preset px-3 py-1.5 text-xs font-semibold bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-white transition-all active:scale-95">
                                    Sub-20 5K
                                </button>
                                <button type="button" data-example-m="5" data-example-s="30" class="pc-example-chip pc-example-preset px-3 py-1.5 text-xs font-semibold bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-white transition-all active:scale-95">
                                    Sub-5:30 Mile
                                </button>
                                <button type="button" data-example-m="12" data-example-s="00" class="pc-example-chip pc-example-preset px-3 py-1.5 text-xs font-semibold bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-800 dark:hover:text-white transition-all active:scale-95">
                                    12:00 3200m
                                </button>
                            </div>
                        </div>

                        ${customDistanceHTML}
                        ${mode === 'pace' ? `
                        <div class="mb-4">
                            <label for="paceDistance" class="block text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5">For Distance</label>
                            <select id="paceDistance" class="w-full p-2.5 text-sm bg-slate-50 dark:bg-slate-700/50 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl focus:border-indigo-500 focus:ring-0 transition">
                                <option value="fiveK">5K</option><option value="tenK">10K</option><option value="halfMarathon">Half Marathon</option><option value="marathon">Marathon</option>
                            </select>
                        </div>` : ''}

                        <!-- Advanced Settings -->
                        <details class="pc-advanced-settings mt-2 mb-4 bg-gradient-to-br from-slate-50/80 to-slate-100/50 dark:from-slate-700/30 dark:to-slate-800/20 border border-slate-200/80 dark:border-slate-700/50 rounded-2xl overflow-hidden">
                            <summary class="cursor-pointer px-4 py-3 flex items-center gap-2 text-sm font-semibold text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition select-none">
                                <svg class="w-4 h-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
                                <span>Race Conditions</span>
                                <span class="text-[0.6rem] font-medium text-slate-400 dark:text-slate-500 ml-1">optional</span>
                                <svg class="w-3.5 h-3.5 ml-auto transition-transform duration-200 pc-details-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-4 pb-4 pt-1 space-y-3 border-t border-slate-200/80 dark:border-slate-700/50">
                                <!-- Gender + Track Type -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Gender</label>
                                        <select id="calc-gender" class="w-full p-2 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-600 rounded-lg focus:border-indigo-500 focus:ring-0">
                                            <option value="men">Male</option>
                                            <option value="women">Female</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Track Type</label>
                                        <select id="calc-track-type" class="w-full p-2 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-600 rounded-lg focus:border-indigo-500 focus:ring-0">
                                            <option value="flat">200m Flat (Standard)</option>
                                            <option value="banked">Banked / Oversized</option>
                                            <option value="undersized">Undersized (&lt; 200m)</option>
                                        </select>
                                    </div>
                                </div>
                                </div>

                                <!-- Venue Type Toggle -->
                                <div class="mb-2">
                                    <label class="block text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Venue Type</label>
                                    <div class="flex gap-1 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg">
                                        <label class="flex-1 cursor-pointer">
                                            <input type="radio" name="venue-type" value="indoor" class="peer sr-only" checked>
                                            <div class="text-center text-xs py-1.5 rounded-md text-slate-500 dark:text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-600 peer-checked:text-indigo-600 dark:peer-checked:text-white peer-checked:shadow-sm font-semibold transition-all">Indoor</div>
                                        </label>
                                        <label class="flex-1 cursor-pointer">
                                            <input type="radio" name="venue-type" value="outdoor" class="peer sr-only">
                                            <div class="text-center text-xs py-1.5 rounded-md text-slate-500 dark:text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-600 peer-checked:text-indigo-600 dark:peer-checked:text-white peer-checked:shadow-sm font-semibold transition-all">Outdoor</div>
                                        </label>
                                        <label class="flex-1 cursor-pointer">
                                            <input type="radio" name="venue-type" value="xc" class="peer sr-only">
                                            <div class="text-center text-xs py-1.5 rounded-md text-slate-500 dark:text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-600 peer-checked:text-indigo-600 dark:peer-checked:text-white peer-checked:shadow-sm font-semibold transition-all">XC</div>
                                        </label>
                                    </div>
                                </div>

                                <!-- Venue Search -->
                                <div>
                                    <label class="block text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Venue (Auto-fill Altitude)</label>
                                    <input list="venue-options-indoor" id="calc-venue" class="w-full p-2 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-600 rounded-lg focus:border-indigo-500 focus:ring-0 placeholder-slate-400" placeholder="Search venues...">
                                    <datalist id="venue-options-indoor">
                                        ${CONFIG.highAltitudeVenues.filter(v => v.type === 'indoor').map(v => `<option value="${v.name}">${v.city} (${v.elevation} ft)</option>`).join('')}
                                    </datalist>
                                    <datalist id="venue-options-outdoor">
                                        ${CONFIG.highAltitudeVenues.filter(v => v.type === 'outdoor').map(v => `<option value="${v.name}">${v.city} (${v.elevation} ft)</option>`).join('')}
                                    </datalist>
                                    <datalist id="venue-options-xc">
                                        ${CONFIG.highAltitudeVenues.filter(v => v.type === 'xc').map(v => `<option value="${v.name}">${v.city} (Std. to ${v.elevation} ft)</option>`).join('')}
                                    </datalist>
                                </div>

                                <!-- Altitude -->
                                <div>
                                    <label class="block text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Altitude (ft)</label>
                                    <div class="flex gap-2">
                                        <input type="number" inputmode="numeric" id="calc-altitude" class="flex-1 p-2 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-600 rounded-lg focus:border-indigo-500 focus:ring-0 placeholder-slate-400" placeholder="e.g. 7200">
                                        <button type="button" id="calc-altitude-preset" class="px-3 py-1.5 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-xs font-bold rounded-lg border border-emerald-200 dark:border-emerald-800/40 hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition whitespace-nowrap" title="Monument, CO elevation">🏔 7,200</button>
                                    </div>
                                </div>

                                <!-- Temperature -->
                                <div>
                                    <label class="block text-[0.6rem] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">Temperature</label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-blue-500">❄️</span>
                                        <input type="range" id="calc-temperature" class="pc-temp-slider flex-1" min="40" max="100" value="60" step="1">
                                        <span class="text-xs text-red-500">🔥</span>
                                    </div>
                                    <div class="flex justify-between mt-0.5">
                                        <span class="text-[0.55rem] text-slate-400">40°F</span>
                                        <span id="calc-temp-value" class="text-xs font-bold text-slate-600 dark:text-slate-300">60°F <span class="text-emerald-500 font-normal">Ideal</span></span>
                                        <span class="text-[0.55rem] text-slate-400">100°F</span>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Action Buttons -->
                        <div id="action-buttons"></div>
                        <button id="back-btn" class="mt-3 w-full flex items-center justify-center gap-2 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 font-semibold py-2.5 px-6 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 transition-all text-sm">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                            <span>Back to Step 1</span>
                        </button>
                    </div>
                `;
                },
                renderGoalPaceForm() {
                    DOMElements.goalPaceForm.innerHTML = `
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">Interactive Goal Pace</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="goalDistanceSlider" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">
                                Distance: <span id="goalDistanceValue" class="font-bold text-indigo-600 dark:text-indigo-400">10 km</span>
                            </label>
                            <input id="goalDistanceSlider" type="range" min="0.1" max="50" value="10" step="0.1" class="w-full" aria-controls="goalPaceResult">
                        </div>
                        <div>
                            <label for="goalTimeSlider" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">
                                Target Time: <span id="goalTimeValue" class="font-bold text-indigo-600 dark:text-indigo-400">45:00</span>
                            </label>
                            <input id="goalTimeSlider" type="range" min="12" max="7200" value="2700" step="1" class="w-full" aria-controls="goalPaceResult">
                        </div>
                    </div>
                    <div id="goalPaceResult" class="space-y-2"></div>`;

                    EventHandlers.handleGoalPace();
                },
                renderSettingsTab() {
                    const achievements = AppLogic.checkAchievements();
                    DOMElements.tabs.settings.content.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg space-y-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">Personalization</h2>
                            <div class="mb-4">
                                <label for="userName" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Name (for Pace Card)</label>
                                <input id="userName" type="text" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg" placeholder="e.g., Alex">
                            </div>
                            <div class="mb-6">
                                <label for="fontSizeSlider" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Font Size</label>
                                <input id="fontSizeSlider" type="range" min="12" max="20" value="${localStorage.getItem('fontSize') || 16}" class="w-full" aria-label="Adjust font size">
                            </div>
                        </div>
                        <div>
                           <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Achievements</h3>
                           <div id="achievements-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                               ${achievements.map(a => `
                               <div class="bg-slate-100 dark:bg-slate-700/50 p-4 rounded-xl flex items-center gap-4">
                                   <i class="${a.icon} text-3xl ${a.color}"></i>
                                   <div>
                                       <p class="font-bold text-slate-800 dark:text-slate-200">${a.name}</p>
                                       <p class="text-xs text-slate-500 dark:text-slate-400">${a.description}</p>
                                   </div>
                               </div>
                               `).join('')}
                           </div>
                           ${achievements.length === 0 ? '<p class="text-center text-slate-500 dark:text-slate-400">No achievements yet. Keep tracking!</p>' : ''}
                        </div>
                        <div>
                           <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Default Heart Rate Zones</h3>
                           <div class="space-y-4">
                               <div>
                                   <label for="defaultMhr" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Max Heart Rate (MHR)</label>
                                   <div class="relative"><i class="ph-heart absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input id="defaultMhr" type="number" class="w-full pl-10 p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg" placeholder="e.g., 195"></div>
                               </div>
                               <div>
                                   <label for="defaultLthr" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Lactate Threshold HR (LTHR)</label>
                                   <div class="relative"><i class="ph-activity absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input id="defaultLthr" type="number" class="w-full pl-10 p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg" placeholder="e.g., 178"></div>
                               </div>
                           </div>
                        </div>
                        <div>
                            <details class="p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors duration-200">
                                <summary class="font-semibold text-md cursor-pointer text-slate-800 dark:text-indigo-400 flex justify-between items-center">Advanced Settings <i class="ph-caret-down transition-transform"></i></summary>
                                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-600 space-y-6">
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Pace Card Customization</h4>
                                        <div>
                                            <label for="motivationalQuote" class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Motivational Quote</label>
                                            <input id="motivationalQuote" type="text" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg" placeholder="e.g., Run your own race.">
                                        </div>
                                        <div class="mt-4">
                                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">Paces to Show on Card</label>
                                            <div id="pace-card-splits-list" class="grid grid-cols-2 gap-2"></div>
                                        </div>
                                    </div>
                                    <div>
                                       <h4 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Custom Pace Splits</h4>
                                       <div id="custom-splits-list" class="space-y-3"></div>
                                       <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
                                           <input id="new-split-name" type="text" class="sm:col-span-2 w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg" placeholder="Loop Name">
                                           <input id="new-split-dist" type="number" class="w-full p-3 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-transparent focus:border-indigo-500 focus:ring-0 rounded-lg" placeholder="Distance (meters)">
                                       </div>
                                       <button id="add-split-btn" class="mt-3 w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition">
                                           <i class="ph-plus-circle"></i> Add Custom Split
                                       </button>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Tutorial</h4>
                                        <button id="show-tutorial-btn" class="w-full flex items-center justify-center gap-2 bg-slate-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-600 transition">
                                            <i class="ph-info"></i><span>Show Tutorial Again</span>
                                        </button>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>`;

                    document.getElementById('userName').value = state.settings.name;
                    document.getElementById('defaultMhr').value = state.settings.hrData.mhr;
                    document.getElementById('defaultLthr').value = state.settings.hrData.lthr;
                    document.getElementById('motivationalQuote').value = state.settings.motivationalQuote;
                    this.renderCustomSplits();
                    this.renderPaceCardSplitOptions();
                },
                renderCustomSplits() {
                    const listEl = document.getElementById('custom-splits-list');
                    if (!listEl) return;
                    if (state.settings.customSplits.length === 0) {
                        listEl.innerHTML = `<p class="text-sm text-slate-500 dark:text-slate-400 text-center">No custom splits added yet.</p>`;
                        return;
                    }
                    listEl.innerHTML = state.settings.customSplits.map((split, index) => `
                    <li class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700/50 rounded-lg">
                        <div>
                            <p class="font-semibold text-slate-800 dark:text-slate-200">${split.label}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${split.dist} meters</p>
                        </div>
                        <button data-index="${index}" aria-label="Delete custom split ${split.label}" class="delete-split-btn text-slate-400 hover:text-red-500 dark:hover:text-red-400 p-2 rounded-full transition"><i class="ph-x text-xl"></i></button>
                    </li>
                `).join('');
                },
                renderPaceCardSplitOptions() {
                    const container = document.getElementById('pace-card-splits-list');
                    if (!container) return;

                    const paces = CONFIG.allPaces.map(p => p.name);
                    container.innerHTML = paces.map(pace => {
                        const isChecked = state.settings.paceCardSplits.includes(pace);
                        return `
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" value="${pace}" class="pace-card-split-checkbox" ${isChecked ? 'checked' : ''}>
                            <span class="text-sm text-slate-700 dark:text-slate-300">${pace}</span>
                        </label>
                    `;
                    }).join('');
                }
            };

            const AppLogic = {
                getTimeStringFromInputs(prefix) {
                    const mEl = document.getElementById(`${prefix}-m`);
                    const sEl = document.getElementById(`${prefix}-s`);

                    const m = mEl ? mEl.value || '0' : '0';
                    const s = sEl ? sEl.value || '0' : '0';

                    return `${m}:${s}`;
                },
                analyzeHistory() {
                    if (state.history.length < 2) {
                        return null;
                    }

                    const sortedHistory = [...state.history].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const firstEntry = sortedHistory[0];
                    const lastEntry = sortedHistory[sortedHistory.length - 1];

                    const overallVdotChange = lastEntry.vdot - firstEntry.vdot;
                    const recentVdotChange = sortedHistory.length > 1 ? lastEntry.vdot - sortedHistory[sortedHistory.length - 2].vdot : null;
                    const bestVdotEntry = sortedHistory.reduce((max, entry) => entry.vdot > max.vdot ? entry : max, sortedHistory[0]);

                    const oneMonthAgo = new Date();
                    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                    const lastMonthEntry = sortedHistory.find(entry => new Date(entry.date) <= oneMonthAgo);
                    const monthlyChange = lastMonthEntry ? lastEntry.vdot - lastMonthEntry.vdot : null;

                    const basisCounts = state.history.reduce((acc, entry) => {
                        acc[entry.mode] = (acc[entry.mode] || 0) + 1;
                        return acc;
                    }, {});
                    const mostCommonBasis = Object.keys(basisCounts).reduce((a, b) => basisCounts[a] > basisCounts[b] ? a : b, null);

                    return {
                        overallVdotChange,
                        recentVdotChange,
                        bestVdotEntry,
                        monthlyChange,
                        mostCommonBasis,
                    };
                },
                checkAchievements() {
                    const achievements = [
                        {
                            name: "Bear Conqueror",
                            description: "Log a Bear Time under 7 minutes.",
                            icon: "ph-mountains",
                            color: "text-red-500",
                            condition: state.history.some(h => h.mode === 'bear' && Calculations.timeToSec(h.timeStr) < 420)
                        },
                        {
                            name: "Consistent Tracker",
                            description: "Save 10 or more pace calculations.",
                            icon: "ph-chart-line-up",
                            color: "text-blue-500",
                            condition: state.history.length >= 10
                        },
                        {
                            name: "VDOT Improver",
                            description: "Improve your VDOT by 2+ points.",
                            icon: "ph-trend-up",
                            color: "text-green-500",
                            condition: state.history.length >= 2 && (state.history[state.history.length - 1].vdot - state.history[0].vdot) >= 2
                        }
                    ];
                    return achievements.filter(a => a.condition);
                },
                calculateAndDisplay(isLive = false) {
                    const mode = state.selectedBasis;
                    const timeStr = this.getTimeStringFromInputs('timeInput');

                    if (!isLive) {
                        localStorage.setItem('lastInputs', JSON.stringify({ mode: state.selectedBasis, timeStr }));
                    }

                    const format = document.getElementById('timeFormat')?.value || 'mm:ss';
                    let totalTimeInSec, distanceMeters;

                    if (mode === 'pace') {
                        const paceInSec = Calculations.timeToSec(timeStr, format);
                        const paceDistanceKey = document.getElementById('paceDistance').value;
                        distanceMeters = CONFIG.distMap[paceDistanceKey];
                        totalTimeInSec = (paceInSec / METERS_PER_MILE) * distanceMeters;
                    } else if (mode === 'custom') {
                        const distInput = document.getElementById('custom-distance');
                        const distUnit = document.getElementById('custom-distance-unit').value;
                        const customDist = parseFloat(distInput.value);

                        if (isNaN(customDist) || customDist <= 0 || customDist > 1000) {
                            if (!isLive) UI.showToast('Please enter a valid custom distance (0.1 - 1000).', 'error');
                            distInput.classList.add('border-red-500');
                            return;
                        }
                        distInput.classList.remove('border-red-500');
                        distanceMeters = customDist * (distUnit === 'km' ? METERS_PER_KM : METERS_PER_MILE);
                        totalTimeInSec = Calculations.timeToSec(timeStr, format);
                    } else {
                        totalTimeInSec = Calculations.timeToSec(timeStr, format);
                        distanceMeters = CONFIG.distMap[mode];
                        // Course standardizer: convert course time to standard 5K equivalent
                        if (CONFIG.courseFactors[mode]) {
                            totalTimeInSec = totalTimeInSec * CONFIG.courseFactors[mode];
                            distanceMeters = CONFIG.distMap.fiveK; // VDOT uses standard 5K
                        }
                    }

                    const m = parseInt(document.getElementById('timeInput-m').value, 10);
                    if (m > 999) {
                        if (!isLive) UI.showToast('Minutes must be between 0 and 999.', 'error');
                        return;
                    }

                    if (!isLive && (isNaN(totalTimeInSec) || totalTimeInSec <= 0)) {
                        UI.showModal(`
                        <div class="p-6 text-center">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Invalid Time</h3>
                            <p class="text-slate-600 dark:text-slate-400 mb-6">Please enter a valid, positive time (e.g., 8:30).</p>
                            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">OK</button>
                        </div>
                    `);
                        return;
                    }

                    DOMElements.resultsColumn.innerHTML = `
                            <div class="space-y-4 animate-pulse">
                                <div class="pc-skeleton h-36 w-full"></div>
                                <div class="pc-skeleton h-16 w-full"></div>
                                <div class="pc-skeleton h-20 w-full"></div>
                                <div class="pc-skeleton h-20 w-full"></div>
                                <div class="pc-skeleton h-20 w-full"></div>
                            </div>`;

                    setTimeout(() => {
                        let anchor5kTime;
                        let xcAdjustmentMsg = '';
                        let effectiveAltitude = 0;

                        if (mode === 'bear') {
                            anchor5kTime = Calculations.getInterpolated5kTime(totalTimeInSec, CONFIG.benchmarks);
                        } else {
                            // XC Venue Standardization Logic
                            const venueName = document.getElementById('calc-venue').value;
                            const selectedVenue = CONFIG.highAltitudeVenues.find(v => v.name === venueName);

                            if (selectedVenue && selectedVenue.type === 'xc' && selectedVenue.xcFactor) {
                                // Apply XC Factor to get "Liberty Bell Equivalent" time
                                const standardizedTime = totalTimeInSec * selectedVenue.xcFactor;

                                // Use this standardized time as if it were run at the base elevation (5340ft)
                                // calculated VDOT will be based on this standardized performance
                                const vdotForPace = Calculations.calculateVDOT(distanceMeters, standardizedTime);
                                anchor5kTime = Calculations.calculateTimeFromVDOT(vdotForPace, CONFIG.distMap.fiveK);

                                xcAdjustmentMsg = `(Std. to Liberty Bell)`;
                                effectiveAltitude = selectedVenue.elevation; // 5340 for LB
                            } else {
                                const vdotForPace = Calculations.calculateVDOT(distanceMeters, totalTimeInSec);
                                anchor5kTime = Calculations.calculateTimeFromVDOT(vdotForPace, CONFIG.distMap.fiveK);
                            }
                        }

                        const vdot = Calculations.calculateVDOT(CONFIG.distMap.fiveK, anchor5kTime);

                        if (vdot <= 0 || !isFinite(vdot)) {
                            UI.renderEmptyState();
                            UI.showToast("Could not calculate a valid VDOT.", 'error');
                            return;
                        }

                        // Temperature adjustment — degrade paces for heat
                        const tempSlider = document.getElementById('calc-temperature');
                        const tempF = tempSlider ? parseInt(tempSlider.value) : 60;
                        const degreesAboveIdeal = Math.max(0, tempF - 60);
                        const tempPenaltyPct = degreesAboveIdeal * 0.15; // ~0.15% per degree above 60°F
                        const adjustedVdot = vdot * (1 - tempPenaltyPct / 100);
                        const finalVdot = tempPenaltyPct > 0 ? adjustedVdot : vdot;

                        state.latestCalculation = {
                            id: Date.now(),
                            timestamp: Date.now(),
                            date: new Date().toISOString(),
                            mode,
                            timeStr,
                            dist: mode === 'pace' ? document.getElementById('paceDistance').value : mode,
                            vdot: parseFloat(finalVdot.toFixed(1)),
                            rawVdot: parseFloat(vdot.toFixed(1)),
                            tempF,
                            isSaved: false,
                            xcAdjustmentMsg,
                            effectiveAltitude
                        };

                        // Save to history for VDOT Progress Chart (deferred)
                        // Capture data synchronously to ensure correctness if state updates before callback runs
                        const historyEntry = { vdot: state.latestCalculation.vdot, timestamp: Date.now() };
                        const saveHistory = () => {
                            try {
                                const history = JSON.parse(localStorage.getItem('paceCalcHistory') || '[]');
                                history.push(historyEntry);
                                // Keep last 50 entries
                                if (history.length > 50) history.splice(0, history.length - 50);
                                localStorage.setItem('paceCalcHistory', JSON.stringify(history));
                            } catch (e) {
                                console.error('Failed to save history', e);
                            }
                        };

                        if ('requestIdleCallback' in window) {
                            requestIdleCallback(saveHistory);
                        } else {
                            setTimeout(saveHistory, 0);
                        }

                        UI.renderResults();
                        UI.renderActionButtons('action-buttons');

                        // Auto-scroll to results on mobile
                        if (window.innerWidth < 768) {
                            setTimeout(() => {
                                DOMElements.resultsColumn.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 200);
                        }
                    }, 50);
                },
                savePace() {
                    if (!state.latestCalculation) {
                        UI.showToast('No calculation to save.', 'error'); return;
                    }
                    if (state.latestCalculation.isSaved) {
                        UI.showToast('This calculation has already been saved.', 'error'); return;
                    }

                    const action = { type: 'save', data: { ...state.latestCalculation } };
                    this.pushToUndoStack(action);

                    state.history.push(state.latestCalculation);
                    state.latestCalculation.isSaved = true;

                    this.saveHistoryToStorage();
                    UI.showToast('Pace saved to history!', 'success');
                    UI.renderActionButtons('action-buttons');
                },
                deleteHistoryItem(id) {
                    const itemToDelete = state.history.find(item => item.id === id);
                    if (itemToDelete) {
                        const action = { type: 'delete', data: itemToDelete };
                        this.pushToUndoStack(action);
                    }

                    state.history = state.history.filter(item => item.id !== id);
                    this.saveHistoryToStorage();
                    UI.renderHistoryTab();
                    UI.showToast('Entry deleted.', 'success');
                },
                pushToUndoStack(action) {
                    state.undoStack.push(action);
                    if (state.undoStack.length > 5) {
                        state.undoStack.shift();
                    }
                },
                undoLastAction() {
                    if (state.undoStack.length === 0) return;
                    const lastAction = state.undoStack.pop();

                    if (lastAction.type === 'save') {
                        state.history.pop();
                        if (state.latestCalculation && state.latestCalculation.id === lastAction.data.id) {
                            state.latestCalculation.isSaved = false;
                        }
                        UI.showToast('Save undone!', 'success');
                    } else if (lastAction.type === 'delete') {
                        state.history.push(lastAction.data);
                        UI.showToast('Delete undone!', 'success');
                    }
                    this.saveHistoryToStorage();
                    UI.renderActionButtons('action-buttons');
                    if (DOMElements.tabs.history.content.classList.contains('active')) {
                        UI.renderHistoryTab();
                    }
                },
                clearHistory() {
                    state.history = [];
                    this.saveHistoryToStorage();
                    UI.renderHistoryTab();
                },
                saveHistoryToStorage() {
                    localStorage.setItem('paceCalcHistory', JSON.stringify(state.history));
                },
                loadHistoryFromStorage() {
                    const storedHistory = localStorage.getItem('paceCalcHistory');
                    state.history = storedHistory ? JSON.parse(storedHistory) : [];
                },
                sortHistory() {
                    const { by, order } = state.settings.historySort;
                    const sorted = [...state.history].sort((a, b) => {
                        let valA, valB;
                        if (by === 'date') {
                            valA = new Date(a.date);
                            valB = new Date(b.date);
                        } else if (by === 'vdot') {
                            valA = a.vdot;
                            valB = b.vdot;
                        } else { // mode
                            valA = a.mode;
                            valB = b.mode;
                        }

                        if (valA < valB) return -1;
                        if (valA > valB) return 1;
                        return 0;
                    });

                    if (order === 'desc') {
                        sorted.reverse();
                    }
                    return sorted;
                },
                saveSettings() {
                    state.settings.name = document.getElementById('userName').value;
                    state.settings.hrData.mhr = document.getElementById('defaultMhr').value;
                    state.settings.hrData.lthr = document.getElementById('defaultLthr').value;
                    state.settings.motivationalQuote = document.getElementById('motivationalQuote').value;

                    const unitPref = document.getElementById('unit-toggle');
                    if (unitPref) {
                        state.settings.displayUnit = unitPref.value;
                        localStorage.setItem('paceCalcUnit', unitPref.value);
                    }

                    const selectedSplits = [];
                    document.querySelectorAll('.pace-card-split-checkbox:checked').forEach(checkbox => {
                        selectedSplits.push(checkbox.value);
                    });
                    state.settings.paceCardSplits = selectedSplits;

                    localStorage.setItem('paceCalcSettings', JSON.stringify(state.settings));
                    UI.showToast('Settings saved!', 'success');
                    if (state.latestCalculation) {
                        UI.renderResults();
                    }
                },
                loadSettings() {
                    const storedSettings = localStorage.getItem('paceCalcSettings');
                    if (storedSettings) {
                        const loaded = JSON.parse(storedSettings);
                        state.settings = { ...state.settings, ...loaded };
                    }
                },
                addCustomSplit() {
                    const nameInput = document.getElementById('new-split-name');
                    const distInput = document.getElementById('new-split-dist');
                    const name = nameInput.value.trim();
                    const dist = parseInt(distInput.value, 10);
                    if (name && dist > 0) {
                        state.settings.customSplits.push({ label: name, dist });
                        this.saveSettings();
                        UI.renderCustomSplits();
                        nameInput.value = '';
                        distInput.value = '';
                    } else {
                        UI.showToast('Please enter a valid name and distance.', 'error');
                    }
                },
                deleteCustomSplit(index) {
                    state.settings.customSplits.splice(index, 1);
                    this.saveSettings();
                    UI.renderCustomSplits();
                },
                getHRZone(paceName) {
                    const { mhr, lthr } = state.settings.hrData;
                    if (!mhr && !lthr) return 'N/A';

                    let base, zones;
                    if (lthr) {
                        base = lthr;
                        zones = CONFIG.hrZones.lthr;
                    } else {
                        base = mhr;
                        zones = CONFIG.hrZones.mhr;
                    }

                    const zone = zones.find(z => z.name === paceName);
                    if (!zone) return 'N/A';

                    const low = Math.round(base * zone.low);
                    const high = Math.round(base * zone.high);
                    return `${low} - ${high}`;
                },
                copyTable() {
                    const table = document.getElementById("paceTable");
                    if (!table || !table.querySelector('tbody').hasChildNodes()) {
                        UI.showToast('Please calculate paces first.', 'error'); return;
                    }
                    let textToCopy = '';
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
                    textToCopy += headers.join('\t') + '\n';

                    table.querySelectorAll('tbody tr').forEach(row => {
                        const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText);
                        textToCopy += cells.join('\t') + '\n';
                    });

                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        UI.showToast('Table copied to clipboard!');
                    } catch (e) {
                        console.error("Copy failed", e);
                        UI.showToast('Could not copy table.', 'error');
                    }
                    document.body.removeChild(textarea);
                },
                generateShareLink() {
                    if (!state.latestCalculation) return;
                    const params = new URLSearchParams({
                        vdot: state.latestCalculation.vdot,
                        mhr: state.settings.hrData.mhr || '',
                        lthr: state.settings.hrData.lthr || ''
                    });
                    const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                    const text = `Just hit a VDOT of ${state.latestCalculation.vdot} with the Bears TC Pace Calculator! 🏃‍♂️ #Running`;
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;

                    const modalHTML = `
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Share Calculation</h4>
                    <p class="text-slate-600 dark:text-slate-400 mb-4">Copy this link to share your results or post to X.</p>
                    <div class="relative">
                        <input id="share-link-input" type="text" class="w-full p-3 pr-24 bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white border-2 border-slate-200 dark:border-slate-600 rounded-lg" value="${url}" readonly>
                        <button id="modal-copy-btn" class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition">
                            <i class="ph-copy"></i><span>Copy</span>
                        </button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 mt-6">
                        <button id="modal-close-btn" class="w-full text-center bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Close</button>
                        <a href="${twitterUrl}" target="_blank" class="w-full flex items-center justify-center gap-2 bg-black text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-800 transition">
                           <i class="ph-x-logo"></i><span>Post to X</span>
                        </a>
                    </div>
                `;

                    UI.showModal(modalHTML);
                },
                applyUrlParams() {
                    const params = new URLSearchParams(window.location.search);
                    const vdot = parseFloat(params.get('vdot'));
                    const mhr = params.get('mhr');
                    const lthr = params.get('lthr');

                    if (vdot) {
                        state.latestCalculation = {
                            id: Date.now(),
                            date: new Date().toISOString(),
                            vdot: vdot,
                            isSaved: false
                        };
                        if (mhr) state.settings.hrData.mhr = mhr;
                        if (lthr) state.settings.hrData.lthr = lthr;

                        UI.renderResults();
                        state.currentStep = 2;
                        UI.renderCalculatorStep();
                    }
                },
                generatePaceCard() {
                    if (typeof html2canvas === 'undefined' || typeof QRCode === 'undefined') {
                        UI.showToast('Pace card feature is currently unavailable. Please try again later.', 'error');
                        console.error('html2canvas or QRCode library not loaded.');
                        return;
                    }

                    if (!state.paceCardData) {
                        UI.showToast('Please calculate your paces first.', 'error');
                        return;
                    }

                    const vdot = state.paceCardData.vdot;

                    const raceEquivalents = [
                        { name: "The Bear", type: 'special' }, { name: "Palmer Lake 4 Miler", dist: CONFIG.distMap.palmerLake, type: 'vdot' },
                        { name: "10K", dist: CONFIG.distMap.tenK, type: 'vdot' }, { name: "5K", dist: CONFIG.distMap.fiveK, type: 'vdot' },
                        { name: "3200m", dist: CONFIG.distMap.threeTwo, type: 'vdot' }, { name: "1600m", dist: CONFIG.distMap.oneSix, type: 'vdot' }
                    ];

                    const raceEquivalentsHTML = raceEquivalents.map(race => {
                        let predTimeSec;
                        if (race.type === 'special' && race.name === 'The Bear') {
                            const anchor5kTime = Calculations.calculateTimeFromVDOT(vdot, CONFIG.distMap.fiveK);
                            predTimeSec = Calculations.getInterpolatedBearTime(anchor5kTime, CONFIG.benchmarks);
                        } else {
                            predTimeSec = Calculations.calculateTimeFromVDOT(vdot, race.dist);
                        }
                        return `<div><div style="font-weight: 600;">${race.name}</div><div style="font-family: monospace; font-weight: 700;">${Calculations.secToHMS(predTimeSec)}</div></div>`;
                    }).join('');

                    const equivalentsSectionHTML = `
                    <div style="margin-top: 16px; text-align: center;">
                        <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 8px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px;">Race Equivalents</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 14px;">
                           ${raceEquivalentsHTML}
                        </div>
                    </div>
                `;

                    const paceOrder = state.settings.paceCardSplits.length > 0 ? state.settings.paceCardSplits : ["Recovery", "Foundation", "Steady", "Tempo", "Lactate Threshold", "CV", "10K", "5K", "3200m", "1600m"];
                    const splitHeaders = CONFIG.defaultSplitDistances;
                    const splitsTableHTML = `
                    <div style="margin-top: 16px;">
                        <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 8px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px;">Interval Splits</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px; text-align: center;">
                            <thead>
                                <tr style="background-color: #f8fafc;">
                                    <th style="text-align: left; padding: 4px; font-weight: 600;">Zone/Race</th>
                                    ${splitHeaders.map(h => `<th style="padding: 4px; font-weight: 600;">${h.label}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                            ${paceOrder.map((name, index) => {
                        const paceData = state.paceCardData.paces[name];
                        if (!paceData || !paceData.medianPacePerMeter) return '';
                        const bgColor = index % 2 === 0 ? '#ffffff' : '#f8fafc';
                        return `<tr style="background-color: ${bgColor};">
                                    <td style="text-align: left; font-weight: 600; padding: 4px;">${name}</td>
                                    ${splitHeaders.map(h => {
                            const pace = Calculations.secToPace(paceData.medianPacePerMeter * h.dist);
                            return `<td style="font-family: monospace; padding: 4px;">${pace || '-'}</td>`;
                        }).join('')}
                                </tr>`;
                    }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                    const userName = state.settings.name ? `${state.settings.name}'s` : 'My';
                    const quoteHTML = state.settings.motivationalQuote ? `<p style="font-style: italic; text-align: center; margin-top: 16px; font-size: 12px; color: #475569;">"${state.settings.motivationalQuote}"</p>` : '';

                    const modalHTML = `
                    <div id="printable-area" class="bg-white dark:bg-slate-900 p-5">
                        <div style="font-family: Inter, sans-serif; color: #111; width: 100%; max-width: 600px; margin: auto; background-color: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="text-align: left;">
                                    <img src="https://placehold.co/60x60/1e293b/ffffff?text=Bears" alt="Bears TC Logo" style="width: 60px; height: auto; border-radius: 50%;">
                                    <h2 style="font-size: 20px; font-weight: 800; margin: 8px 0 0 0;">${userName} Pace Card</h2>
                                    <div style="background-color: #f1f5f9; border-radius: 8px; padding: 8px; text-align: center; margin-top: 8px;">
                                        <span style="font-size: 12px; color: #475569;">Your VDOT is</span>
                                        <span style="font-size: 20px; font-weight: 700; color: #4f46e5; display: block;">${state.paceCardData.vdot}</span>
                                    </div>
                                </div>
                                <div id="qrcode-container" style="text-align: right; min-width: 80px; min-height: 80px;"></div>
                            </div>
                            
                            ${equivalentsSectionHTML}
                            ${splitsTableHTML}
                            ${quoteHTML}
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 mt-6 pc-no-print">
                        <button id="modal-cancel-btn" class="w-full text-center bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Close</button>
                        <button id="modal-download-btn" class="w-full flex items-center justify-center gap-2 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition"><i class="ph-download"></i><span>Download</span></button>
                        <button id="modal-print-btn" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition"><i class="ph-printer"></i><span>Print</span></button>
                    </div>`;

                    UI.showModal(modalHTML);

                    try {
                        const shareUrl = `${window.location.origin}${window.location.pathname}?vdot=${state.latestCalculation.vdot}`;
                        const qrContainer = document.getElementById('qrcode-container');
                        if (qrContainer) {
                            QRCode.toCanvas(qrContainer, shareUrl, { width: 80, margin: 1, color: { dark: '#000000', light: '#ffffff' } }, function (error) {
                                if (error) {
                                    console.error('QR Code generation error:', error);
                                    UI.showToast('Could not generate QR code.', 'error');
                                    qrContainer.innerHTML = '<p class="text-xs text-red-500">QR Error</p>';
                                }
                            });
                        }
                    } catch (error) {
                        console.error('QR Code execution failed:', error);
                        UI.showToast('Could not generate QR code.', 'error');
                    }
                },
                showTutorial() {
                    UI.showModal(`
                    <div class="p-6 text-center">
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Welcome to the Bears TC Pace Calculator!</h3>
                        <ol class="text-slate-600 dark:text-slate-400 mb-6 text-left space-y-2">
                            <li><b>1. Select a Basis:</b> Choose a recent race or time trial (like 'Bear Time').</li>
                            <li><b>2. Enter Your Time:</b> Input your performance time.</li>
                            <li><b>3. Calculate & Review:</b> Get your equivalent paces for training and other races.</li>
                            <li><b>4. Save & Track:</b> Use the 'History' and 'Settings' tabs to track progress and personalize your experience.</li>
                        </ol>
                        <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Get Started</button>
                    </div>
                `);
                    localStorage.setItem('seenTutorial', 'true');
                },
                exportHistory() {
                    if (state.history.length === 0) {
                        UI.showToast('No history to export.', 'error');
                        return;
                    }
                    try {
                        const dataStr = JSON.stringify(state.history, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                        const exportFileDefaultName = 'bears_tc_history.json';
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        document.body.appendChild(linkElement);
                        linkElement.click();
                        document.body.removeChild(linkElement);
                        UI.showToast('History exported successfully!', 'success');
                    } catch (error) {
                        console.error('Export failed:', error);
                        UI.showToast('Could not export history.', 'error');
                    }
                },
                importHistory() {
                    try {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json,application/json';
                        input.onchange = e => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = readerEvent => {
                                try {
                                    const content = readerEvent.target.result;
                                    const importedHistory = JSON.parse(content);

                                    if (!Array.isArray(importedHistory) || importedHistory.some(item => typeof item.id === 'undefined' || typeof item.date === 'undefined' || typeof item.vdot === 'undefined')) {
                                        throw new Error('Invalid file format.');
                                    }

                                    const existingIds = new Set(state.history.map(item => item.id));
                                    const newItems = importedHistory.filter(item => !existingIds.has(item.id));

                                    if (newItems.length > 0) {
                                        state.history.push(...newItems);
                                        this.saveHistoryToStorage();
                                        UI.renderHistoryTab();
                                        UI.showToast(`${newItems.length} new entries imported.`, 'success');
                                    } else {
                                        UI.showToast('No new entries to import.', 'success');
                                    }
                                } catch (error) {
                                    UI.showToast(`Import failed: ${error.message}`, 'error');
                                    console.error('Import process failed:', error);
                                }
                            };
                            reader.onerror = () => {
                                UI.showToast('Failed to read file.', 'error');
                            }
                            reader.readAsText(file);
                        };
                        input.click();
                    } catch (error) {
                        console.error('Import setup failed:', error);
                        UI.showToast('Could not start import process.', 'error');
                    }
                },
            };

            const EventHandlers = {
                init() {
                    DOMElements.wrapper.addEventListener('click', this.handleWrapperClick.bind(this));
                    DOMElements.wrapper.addEventListener('change', this.handleWrapperChange.bind(this));
                    DOMElements.wrapper.addEventListener('input', this.handleWrapperInput.bind(this));
                    DOMElements.wrapper.addEventListener('keyup', this.handleWrapperKeyup.bind(this));
                    DOMElements.wrapper.addEventListener('mouseover', this.handleWrapperMouseOver.bind(this));
                    DOMElements.wrapper.addEventListener('mouseout', this.handleWrapperMouseOut.bind(this));

                    DOMElements.modalOverlay.addEventListener('click', (e) => { if (e.target === DOMElements.modalOverlay) UI.hideModal(); });

                    window.addEventListener('resize', () => {
                        if (DOMElements.tabs.history.content.classList.contains('active')) {
                            UI.renderProgressChart();
                        }
                    });

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && state.currentStep === 2) {
                            e.preventDefault();
                            AppLogic.calculateAndDisplay();
                        }
                        if (e.key === 'Escape') {
                            if (DOMElements.modalOverlay.style.display === 'block') {
                                UI.hideModal();
                            } else if (state.currentStep === 2) {
                                document.getElementById('timeInput-m').value = '';
                                document.getElementById('timeInput-s').value = '';
                                UI.renderEmptyState();
                                UI.renderActionButtons('action-buttons');
                            }
                        }
                    });

                    const hammer = new Hammer(DOMElements.wrapper);
                    hammer.on('swipeleft', () => {
                        const tabs = ['calc', 'convert', 'history', 'settings'];
                        const current = tabs.findIndex(t => DOMElements.tabs[t].content.classList.contains('active'));
                        if (current < tabs.length - 1) UI.switchTab(tabs[current + 1]);
                    });
                    hammer.on('swiperight', () => {
                        const tabs = ['calc', 'convert', 'history', 'settings'];
                        const current = tabs.findIndex(t => DOMElements.tabs[t].content.classList.contains('active'));
                        if (current > 0) UI.switchTab(tabs[current - 1]);
                    });
                },
                handleWrapperClick(e) {
                    const target = e.target;
                    const closest = (selector) => target.closest(selector);

                    if (closest('#darkToggle')) { UI.setDarkMode(!state.isDark); return; }

                    if (closest('#tab-calc-btn')) { UI.switchTab('calc'); return; }
                    if (closest('#tab-convert-btn')) { UI.switchTab('convert'); return; }
                    if (closest('#tab-history-btn')) { UI.switchTab('history'); return; }
                    if (closest('#tab-settings-btn')) { UI.switchTab('settings'); return; }

                    // Universal Converter — Convert button
                    if (closest('#convert-calc-btn')) {
                        const distIndex = parseInt(document.getElementById('convert-event-select').value, 10);
                        const format = document.getElementById('convert-time-format').value;
                        let timeSec;
                        if (format === 'seconds') {
                            timeSec = parseFloat(document.getElementById('convert-time-m').value) || 0;
                        } else {
                            const timeStr = `${document.getElementById('convert-time-m').value || '0'}:${document.getElementById('convert-time-s').value || '0'}`;
                            timeSec = Calculations.timeToSec(timeStr, format);
                        }
                        const errorEl = document.getElementById('convert-time-error');
                        if (isNaN(timeSec) || timeSec <= 0) {
                            if (errorEl) errorEl.textContent = 'Please enter a valid time.';
                            return;
                        }
                        if (errorEl) errorEl.textContent = '';
                        const gender = document.getElementById('convert-gender')?.value || 'men';
                        const trackType = document.getElementById('convert-track-type')?.value || 'flat';
                        const altitudeFt = parseFloat(document.getElementById('convert-altitude')?.value) || 0;
                        UI.renderConvertResults(distIndex, timeSec, gender, trackType, altitudeFt);
                        return;
                    }

                    // Click on a Performance Equivalent card → populate form & re-convert
                    const equivCard = closest('[data-convert-to-index]');
                    if (equivCard) {
                        const newDistIndex = parseInt(equivCard.dataset.convertToIndex, 10);
                        const newTimeSec = parseFloat(equivCard.dataset.convertToTime);
                        if (isNaN(newDistIndex) || isNaN(newTimeSec) || newTimeSec <= 0) return;

                        // Update the distance dropdown
                        const distSelect = document.getElementById('convert-event-select');
                        if (distSelect) distSelect.value = newDistIndex;

                        // Update time inputs (always set to mm:ss format)
                        const formatSelect = document.getElementById('convert-time-format');
                        if (formatSelect) formatSelect.value = 'mm:ss';
                        const hms = Calculations.secToHMS(newTimeSec);
                        const parts = hms.split(':');
                        const mInput = document.getElementById('convert-time-m');
                        const sInput = document.getElementById('convert-time-s');
                        if (sInput) sInput.style.display = '';
                        if (parts.length === 3) {
                            // HH:MM:SS — switch to that format
                            if (formatSelect) formatSelect.value = 'hh:mm:ss';
                        }
                        if (mInput) mInput.value = parts.length === 3 ? parts[0] : parts[0];
                        if (sInput) sInput.value = parts.length === 3 ? `${parts[1]}:${parts[2]}`.replace(':', '') : parts[1];
                        // For hh:mm:ss, set m=HH, s=MM (we'll just pass the raw seconds through)
                        // Simpler: just re-render with the raw seconds 
                        const gender = document.getElementById('convert-gender')?.value || 'men';
                        const trackType = document.getElementById('convert-track-type')?.value || 'flat';
                        const altitudeFt = parseFloat(document.getElementById('convert-altitude')?.value) || 0;

                        // Scroll to converter form
                        distSelect?.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        UI.renderConvertResults(newDistIndex, newTimeSec, gender, trackType, altitudeFt);
                        return;
                    }

                    // Altitude preset buttons (converter + calculator)
                    if (closest('#convert-altitude-preset')) {
                        const altInput = document.getElementById('convert-altitude');
                        if (altInput) altInput.value = '7200';
                        return;
                    }
                    if (closest('#calc-altitude-preset')) {
                        const altInput = document.getElementById('calc-altitude');
                        if (altInput) altInput.value = '7200';
                        return;
                    }

                    // Sub-tab switching within converter results
                    const subTabBtn = closest('.convert-sub-tab');
                    if (subTabBtn) {
                        const tabName = subTabBtn.dataset.tab;
                        const colorMap = {
                            altitude: { border: 'border-rose-500', text: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-50/50 dark:bg-rose-900/10' },
                            flattrack: { border: 'border-emerald-500', text: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-50/50 dark:bg-emerald-900/10' },
                            ustfcca: { border: 'border-amber-500', text: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-50/50 dark:bg-amber-900/10' },
                        };
                        // Reset all tabs
                        document.querySelectorAll('.convert-sub-tab').forEach(t => {
                            t.className = 'convert-sub-tab flex-1 px-3 py-3 text-sm font-semibold transition-all duration-200 border-b-2 border-transparent text-slate-500 dark:text-slate-400';
                        });
                        // Activate clicked tab
                        const c = colorMap[tabName];
                        if (c) subTabBtn.className = `convert-sub-tab flex-1 px-3 py-3 text-sm font-semibold transition-all duration-200 border-b-2 ${c.border} ${c.text} ${c.bg}`;
                        // Switch panels
                        document.querySelectorAll('.convert-sub-panel').forEach(p => p.style.display = 'none');
                        const activePanel = document.getElementById(`convert-sub-panel-${tabName}`);
                        if (activePanel) {
                            activePanel.style.display = 'block';
                            activePanel.style.animation = 'pcFadeIn 0.25s ease';
                        }
                        return;
                    }

                    if (closest('#next-step-btn')) {
                        state.selectedBasis = document.querySelector('input[name="mode"]:checked').value;
                        localStorage.setItem('paceCalcBasis', state.selectedBasis);
                        state.currentStep = 2;
                        UI.renderCalculatorStep('forward');
                        return;
                    }
                    if (closest('#back-btn')) {
                        state.currentStep = 1;
                        UI.renderCalculatorStep('back');
                        return;
                    }
                    if (closest('#example-link')) {
                        e.preventDefault();
                        const example = CONFIG.exampleTimes[state.selectedBasis];
                        if (example) {
                            document.getElementById('timeInput-m').value = example.m;
                            document.getElementById('timeInput-s').value = example.s;
                            AppLogic.calculateAndDisplay(true);
                        }
                    }
                    const presetBtn = closest('.pc-example-preset');
                    if (presetBtn) {
                        e.preventDefault();
                        const m = presetBtn.getAttribute('data-example-m');
                        const s = presetBtn.getAttribute('data-example-s');
                        if (m && s) {
                            document.getElementById('timeInput-m').value = m;
                            document.getElementById('timeInput-s').value = s;
                            AppLogic.calculateAndDisplay(true);
                        }
                    }

                    if (closest('#calc-btn')) { AppLogic.calculateAndDisplay(); return; }
                    if (closest('#savePaceBtn')) { AppLogic.savePace(); return; }
                    if (closest('#copyTableBtn')) { AppLogic.copyTable(); return; }
                    if (closest('#generatePaceCardBtn')) { AppLogic.generatePaceCard(); return; }
                    if (closest('#shareBtn')) { UI.shareAsImage(); return; }

                    if (closest('#reset-btn')) {
                        document.getElementById('timeInput-m').value = '';
                        document.getElementById('timeInput-s').value = '';
                        state.latestCalculation = null;
                        UI.renderEmptyState();
                        UI.renderActionButtons('action-buttons');
                        return;
                    }

                    if (closest('#undo-btn')) { AppLogic.undoLastAction(); return; }

                    if (closest('#clearHistoryBtn')) { this.handleClearHistory(); return; }
                    const deleteHistoryBtn = closest('.delete-history-btn');
                    if (deleteHistoryBtn) {
                        const id = parseInt(deleteHistoryBtn.dataset.id, 10);
                        AppLogic.deleteHistoryItem(id);
                        return;
                    }

                    if (closest('#add-split-btn')) { AppLogic.addCustomSplit(); return; }
                    const deleteSplitBtn = closest('.delete-split-btn');
                    if (deleteSplitBtn) {
                        AppLogic.deleteCustomSplit(deleteSplitBtn.dataset.index);
                        return;
                    }

                    if (closest('#modal-close-btn') || closest('#modal-cancel-btn')) { UI.hideModal(); return; }
                    if (closest('#modal-print-btn')) { window.print(); return; }
                    if (closest('#modal-download-btn')) {
                        const printableArea = document.getElementById('printable-area');
                        html2canvas(printableArea.querySelector('div'), { backgroundColor: '#ffffff' }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `pace-card-vdot-${state.paceCardData.vdot}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        }).catch(err => {
                            console.error('html2canvas failed:', err);
                            UI.showToast('Could not download pace card.', 'error');
                        });
                        return;
                    }
                    const modalCopyBtn = closest('#modal-copy-btn');
                    if (modalCopyBtn) {
                        const input = document.getElementById('share-link-input');
                        input.select();
                        input.setSelectionRange(0, 99999);
                        try {
                            document.execCommand('copy');
                            modalCopyBtn.innerHTML = '<i class="ph-check"></i><span>Copied!</span>';
                            setTimeout(() => { modalCopyBtn.innerHTML = '<i class="ph-copy"></i><span>Copy</span>'; }, 2000);
                        } catch (err) { UI.showToast('Could not copy link.', 'error'); }
                    }

                    if (closest('#exportHistoryBtn')) { AppLogic.exportHistory(); return; }
                    if (closest('#importHistoryBtn')) { AppLogic.importHistory(); return; }
                    if (closest('#show-tutorial-btn')) { AppLogic.showTutorial(); return; }
                },
                handleWrapperChange(e) {
                    // Venue Type Toggle
                    if (e.target.name === 'venue-type') {
                        const type = e.target.value;
                        const venueInput = document.getElementById('calc-venue');
                        if (venueInput) {
                            venueInput.setAttribute('list', `venue-options-${type}`);
                            if (type === 'xc') {
                                venueInput.placeholder = "Search XC courses...";
                            } else {
                                venueInput.placeholder = `Search ${type} venues...`;
                            }
                            venueInput.value = '';
                        }
                        return;
                    }

                    // Conversions tab: Venue Type Toggle
                    if (e.target.name === 'convert-venue-type') {
                        const type = e.target.value;
                        const venueInput = document.getElementById('convert-venue');
                        if (venueInput) {
                            venueInput.setAttribute('list', `convert-venue-options-${type}`);
                            if (type === 'xc') {
                                venueInput.placeholder = "Search XC courses...";
                            } else {
                                venueInput.placeholder = `Search ${type} venues...`;
                            }
                            venueInput.value = '';
                        }
                        return;
                    }

                    // Calculator Input Change Handling
                    if (e.target.name === 'mode') {
                        state.selectedBasis = e.target.value;
                    }
                    if (e.target.id === 'paceDistance' || e.target.id === 'timeFormat' || e.target.id === 'unit-toggle') {
                        if (e.target.id === 'unit-toggle') {
                            state.settings.displayUnit = e.target.value;
                            localStorage.setItem('paceCalcUnit', e.target.value);
                        }
                        if (state.latestCalculation) {
                            UI.renderResults();
                        }
                    }
                    if (e.target.classList.contains('pace-card-split-checkbox')) {
                        AppLogic.saveSettings();
                    }
                    if (e.target.id === 'history-sort-by' || e.target.id === 'history-sort-order') {
                        state.settings.historySort.by = document.getElementById('history-sort-by').value;
                        state.settings.historySort.order = document.getElementById('history-sort-order').value;
                        AppLogic.saveSettings();
                        UI.renderHistoryList();
                    }
                    // Re-calc on track type or gender change for altitude/track adjustments
                    if (e.target.id === 'calc-track-type' || e.target.id === 'calc-gender') {
                        if (state.latestCalculation) {
                            UI.renderResults();
                        }
                    }
                },
                handleWrapperInput(e) {
                    const target = e.target;
                    const targetId = target.id;

                    // Venue Auto-fill Logic
                    if (targetId === 'calc-venue') {
                        const val = target.value;
                        const venue = CONFIG.highAltitudeVenues.find(v => v.name === val);
                        if (venue) {
                            const altInput = document.getElementById('calc-altitude');
                            if (altInput) {
                                altInput.value = venue.elevation;
                                if (state.latestCalculation) UI.renderResults();
                            }
                            // Auto-set track type for indoor venues
                            if (venue.trackType) {
                                const trackTypeSelect = document.getElementById('calc-track-type');
                                if (trackTypeSelect) trackTypeSelect.value = venue.trackType;
                            }
                        }
                    }

                    // Conversions tab: Venue Auto-fill Logic
                    if (targetId === 'convert-venue') {
                        const val = target.value;
                        const venue = CONFIG.highAltitudeVenues.find(v => v.name === val);
                        if (venue) {
                            const altInput = document.getElementById('convert-altitude');
                            if (altInput) {
                                altInput.value = venue.elevation;
                            }
                            // Auto-set track type for indoor venues
                            if (venue.trackType) {
                                const trackTypeSelect = document.getElementById('convert-track-type');
                                if (trackTypeSelect) trackTypeSelect.value = venue.trackType;
                            }
                        }
                    }

                    // Re-calc on altitude manual change
                    if (targetId === 'calc-altitude') {
                        if (state.latestCalculation) UI.renderResults();
                    }

                    if (targetId.startsWith('timeInput-')) {
                        const mInput = document.getElementById('timeInput-m');
                        const sInput = document.getElementById('timeInput-s');
                        const errorEl = document.getElementById('time-input-error');

                        const m = parseInt(mInput.value, 10);
                        const s = parseInt(sInput.value, 10);

                        let isValid = true;
                        if (m < 0 || m > 999) {
                            mInput.classList.add('border-red-500');
                            if (errorEl) errorEl.textContent = "Minutes must be 0-999.";
                            isValid = false;
                        } else {
                            mInput.classList.remove('border-red-500');
                        }

                        if (s < 0 || s > 59) {
                            sInput.classList.add('border-red-500');
                            if (errorEl) errorEl.textContent = "Seconds must be 0-59.";
                            isValid = false;
                        } else {
                            sInput.classList.remove('border-red-500');
                        }

                        if (isValid && errorEl) errorEl.textContent = "";

                        clearTimeout(state.debounceTimer);
                        state.debounceTimer = setTimeout(() => {
                            if (mInput.value && sInput.value && isValid) {
                                AppLogic.calculateAndDisplay(true);
                            }
                        }, 300);

                        const nextId = target.dataset.next;
                        if (target.value.length >= target.maxLength && nextId) {
                            document.getElementById(nextId)?.focus();
                        }
                    }

                    if (targetId === 'goalDistanceSlider' || targetId === 'goalTimeSlider') {
                        this.handleGoalPace();
                    }

                    if (targetId === 'userName' || targetId === 'defaultMhr' || targetId === 'defaultLthr' || targetId === 'motivationalQuote') {
                        AppLogic.saveSettings();
                    }

                    if (targetId === 'fontSizeSlider') {
                        DOMElements.wrapper.style.fontSize = `${target.value}px`;
                        localStorage.setItem('fontSize', target.value);
                    }
                },
                handleWrapperKeyup(e) {
                    const target = e.target;
                    const targetId = target.id;
                    if (e.key === 'Backspace' && target.value.length === 0) {
                        if (targetId === 'timeInput-s') document.getElementById('timeInput-m')?.focus();
                        if (targetId === 'goalTime-s') document.getElementById('goalTime-m')?.focus();
                    }
                    if (['ArrowUp', 'ArrowDown'].includes(e.key) && target.type === 'range') {
                        target.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                },
                handleWrapperMouseOver(e) {
                    const chartDot = e.target.closest('.chart-dot');
                    if (chartDot) {
                        const tooltipEl = document.getElementById('chartTooltip');
                        const historyData = [...state.history].sort((a, b) => new Date(a.date) - new Date(b.date));
                        const index = chartDot.getAttribute('data-index');
                        const data = historyData[index];
                        const date = new Date(data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        tooltipEl.innerHTML = `<strong>VDOT: ${data.vdot}</strong><br>${date}`;
                        tooltipEl.style.opacity = '1';
                        const x = parseFloat(chartDot.getAttribute('cx'));
                        const y = parseFloat(chartDot.getAttribute('cy'));
                        tooltipEl.style.left = `${x}px`;
                        tooltipEl.style.top = `${y - 40}px`;
                        chartDot.setAttribute('r', '7');
                    }
                },
                handleWrapperMouseOut(e) {
                    const chartDot = e.target.closest('.chart-dot');
                    if (chartDot) {
                        document.getElementById('chartTooltip').style.opacity = '0';
                        chartDot.setAttribute('r', '5');
                    }
                },
                handleGoalPace() {
                    const distSlider = document.getElementById("goalDistanceSlider");
                    const timeSlider = document.getElementById("goalTimeSlider");
                    const distValueEl = document.getElementById("goalDistanceValue");
                    const timeValueEl = document.getElementById("goalTimeValue");
                    const resultDiv = document.getElementById("goalPaceResult");

                    if (!distSlider || !timeSlider) return;

                    const distance = parseFloat(distSlider.value);
                    const timeInSec = parseInt(timeSlider.value, 10);

                    distValueEl.textContent = `${distance.toFixed(1)} km`;
                    timeValueEl.textContent = Calculations.secToPace(timeInSec);

                    const distanceMeters = distance * 1000;
                    const pacePerMile = (timeInSec / distanceMeters) * METERS_PER_MILE;
                    const splits = [200, 400, 800, 1000, 1200, 1600].map(d => ({
                        name: `${d}m`,
                        value: Calculations.secToPace((timeInSec / distanceMeters) * d, 'meters')
                    }));
                    splits.unshift({ name: 'Pace / mi', value: Calculations.secToPace(pacePerMile, 'miles') });
                    splits.unshift({ name: 'Pace / km', value: Calculations.secToPace(pacePerMile, 'km') });

                    resultDiv.innerHTML = `<h4 class="text-lg font-bold text-slate-900 dark:text-white">Required Splits:</h4><p class="text-sm text-slate-500 dark:text-slate-400">To run ${distance.toFixed(1)} km in ${Calculations.secToHMS(timeInSec)}, you need a ${Calculations.secToPace(pacePerMile, 'miles')}/mi pace.</p><ul class="grid grid-cols-2 gap-x-4 gap-y-2 mt-4 text-sm">${splits.map(s => `<li class="flex justify-between border-b border-dashed border-slate-200 dark:border-slate-700 py-1"><span class="font-semibold text-slate-700 dark:text-slate-300">${s.name}:</span><span class="font-mono font-bold text-slate-900 dark:text-white">${s.value}</span></li>`).join('')}</ul>`;
                    resultDiv.classList.remove("hidden");
                },
                handleClearHistory() {
                    const modalHTML = `<h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Clear History</h4><p class="text-slate-600 dark:text-slate-400 mb-6">Are you sure you want to delete all saved history? This cannot be undone.</p><div class="flex gap-3"><button id="modal-cancel-btn" class="w-full text-center bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button><button id="modal-confirm-clear-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition">Yes, Clear</button></div>`;
                    UI.showModal(modalHTML);
                    document.getElementById('modal-confirm-clear-btn').addEventListener('click', () => {
                        AppLogic.clearHistory();
                        UI.hideModal();
                        UI.showToast('History Cleared!', 'success');
                    }, { once: true });
                },
            };

            function init() {
                const prefersDark = localStorage.getItem('paceCalcDarkMode') === 'true' ||
                    (localStorage.getItem('paceCalcDarkMode') === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
                UI.setDarkMode(prefersDark, false);

                AppLogic.loadHistoryFromStorage();
                AppLogic.loadSettings();

                const lastInputs = JSON.parse(localStorage.getItem('lastInputs') || '{}');
                state.selectedBasis = lastInputs.mode || state.selectedBasis;
                const fontSize = localStorage.getItem('fontSize') || '16';
                DOMElements.wrapper.style.fontSize = `${fontSize}px`;

                UI.renderCalculatorStep();
                UI.renderGoalPaceForm();
                UI.renderInfo();
                UI.renderEmptyState();

                EventHandlers.init();
                UI._initTapToCopy();

                AppLogic.applyUrlParams();

                if (!localStorage.getItem('seenTutorial')) {
                    AppLogic.showTutorial();
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

        })();

    // PWA Service Worker Registration & Install Prompt
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').catch(() => { });
    }
    let deferredInstallPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        // Show install banner
        const banner = document.createElement('div');
        banner.id = 'pwa-install-banner';
        banner.className = 'fixed bottom-4 left-4 right-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-2xl shadow-2xl z-50 flex items-center gap-3 pc-slide-up';
        banner.innerHTML = `
                    <span class="text-2xl">📲</span>
                    <div class="flex-1">
                        <p class="font-bold text-sm">Install Pace Calculator</p>
                        <p class="text-xs text-indigo-200">Add to home screen for instant access</p>
                    </div>
                    <button id="pwa-install-btn" class="bg-white text-indigo-600 font-bold text-sm px-4 py-2 rounded-xl hover:bg-indigo-50 transition">Install</button>
                    <button id="pwa-dismiss-btn" class="text-indigo-200 hover:text-white ml-1 text-lg">&times;</button>
                `;
        document.body.appendChild(banner);
        document.getElementById('pwa-install-btn').addEventListener('click', async () => {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                await deferredInstallPrompt.userChoice;
                deferredInstallPrompt = null;
            }
            banner.remove();
        });
        document.getElementById('pwa-dismiss-btn').addEventListener('click', () => banner.remove());
    });
</script>

<!-- Footer -->
<footer class="max-w-screen-2xl mx-auto px-4 py-8 mt-8 border-t border-slate-200 dark:border-slate-700">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-sm text-slate-500 dark:text-slate-400">
        <div>
            <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-2">What is VDOT?</h4>
            <p class="leading-relaxed">VDOT is a running fitness score from Jack Daniels' Running Formula. It
                combines your VO₂max and running economy into one number based on race performance. <strong>Higher =
                    faster.</strong> Most high school runners score 30–55; elites reach 70+.</p>
        </div>
        <div>
            <h4 class="font-bold text-slate-700 dark:text-slate-300 mb-2">About This Calculator</h4>
            <p class="leading-relaxed">Built by <a href="https://www.bearstc.com"
                    class="text-indigo-500 hover:text-indigo-600 dark:text-indigo-400 font-medium" target="_blank"
                    rel="noopener">Bears Track Club</a> in Colorado Springs. Free to use — enter any race time to
                get personalized training paces adjusted for altitude and heat.</p>
        </div>
    </div>
    <p class="text-center text-xs text-slate-400 dark:text-slate-500 mt-6">© 2026 Bears Track Club · Powered by
        Daniels' Running Formula</p>
</footer>